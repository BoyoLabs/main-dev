<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bullet Positional Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <style>
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
        :root{--bg:#0c0e13;--surface:#14171e;--surface-2:#1a1e28;--border:#252a36;--text:#c8cdd8;--text-dim:#6b7280;--accent:#f59e0b;--accent-glow:rgba(245,158,11,.15);--green:#22c55e;--red:#ef4444;--blue:#3b82f6;--orange:#f97316;--cyan:#06b6d4}
        html{height:100%;overflow:hidden}
        body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;height:100dvh;height:100vh;display:flex;flex-direction:column;align-items:center;overflow:hidden;background-image:radial-gradient(ellipse 600px 400px at 50% 0%,rgba(245,158,11,.04),transparent),radial-gradient(ellipse 400px 300px at 80% 100%,rgba(59,130,246,.03),transparent)}
        header{text-align:center;padding:6px 0 2px;flex-shrink:0}
        header h1{font-family:'JetBrains Mono',monospace;font-weight:800;font-size:clamp(.9rem,3.5vw,1.5rem);color:var(--accent);letter-spacing:-.5px;text-transform:uppercase}
        header h1 span{color:var(--text);font-weight:400;opacity:.5}
        header p{font-size:clamp(.5rem,1.8vw,.7rem);color:var(--text-dim);margin-top:1px;letter-spacing:2px;text-transform:uppercase}
        .app{width:100%;max-width:420px;flex:1;display:flex;flex-direction:column;min-height:0;padding:0 10px}
        .top-bar{display:flex;justify-content:space-between;align-items:flex-end;padding:0 4px;margin-bottom:4px;flex-shrink:0}
        .timer{font-family:'JetBrains Mono',monospace;font-size:clamp(1.4rem,6vw,2.4rem);font-weight:800;color:#fff;line-height:1}
        .timer.low{color:var(--red);animation:pulse .8s ease-in-out infinite}
        .timer.paused{color:var(--blue);opacity:.7}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
        .score-total{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--text-dim);text-align:right}
        .score-total strong{display:block;font-size:clamp(1rem,4vw,1.5rem);color:var(--accent);line-height:1}
        .board-wrap{border-radius:6px;overflow:hidden;border:2px solid var(--border);box-shadow:0 10px 40px rgba(0,0,0,.5);transition:filter .3s,opacity .3s;flex-shrink:0;position:relative}
        .board-wrap.searching{filter:grayscale(.8) blur(2px);opacity:.5;pointer-events:none}
        #board{width:100%;cursor:pointer;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent}
        #board img{pointer-events:none}
        .highlight-square{background-color:rgba(245,158,11,.4)!important}
        .highlight-dot{position:relative!important}
        .highlight-dot::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:28%;height:28%;background:rgba(245,158,11,.5);border-radius:50%;pointer-events:none;z-index:10}
        .highlight-capture{background:radial-gradient(transparent 50%,rgba(239,68,68,.4) 50%)!important}
        .best-move-from{background-color:rgba(6,182,212,.35)!important;box-shadow:inset 0 0 12px rgba(6,182,212,.4)}
        .best-move-to{background-color:rgba(6,182,212,.5)!important;box-shadow:inset 0 0 16px rgba(6,182,212,.5)}
        .best-move-ghost{position:absolute!important;z-index:50!important;opacity:.7!important;filter:drop-shadow(0 0 6px rgba(6,182,212,.8)) drop-shadow(0 0 2px rgba(6,182,212,1))!important;pointer-events:none!important;transition:none!important}
        .move-timer-wrap{height:3px;background:var(--bg);overflow:hidden;border-radius:0 0 6px 6px;margin-top:-2px;flex-shrink:0}
        .move-timer-bar{height:100%;width:100%;border-radius:0 0 6px 6px;transition:width .1s linear,background-color .5s}
        .panel{margin-top:6px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 12px;flex-shrink:0;overflow:hidden}
        .status-line{text-align:center;font-family:'JetBrains Mono',monospace;font-size:clamp(.55rem,1.8vw,.7rem);font-weight:700;color:var(--accent);letter-spacing:3px;text-transform:uppercase;margin-bottom:8px}
        .score-row{display:flex;justify-content:space-between;align-items:center;padding-bottom:8px;margin-bottom:8px;border-bottom:1px solid var(--border)}
        .score-row label{font-size:.65rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px}
        .score-pill{font-family:'JetBrains Mono',monospace;font-size:clamp(1rem,4vw,1.6rem);font-weight:800;color:var(--accent);background:var(--bg);padding:3px 12px;border-radius:6px}
        .score-breakdown{display:none;margin-bottom:8px}
        .score-breakdown.show{display:flex;gap:6px}
        .sb-item{flex:1;text-align:center;padding:5px 3px;border-radius:6px;background:var(--surface-2);border:1px solid var(--border);font-family:'JetBrains Mono',monospace}
        .sb-item .sb-label{font-size:.5rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:1px}
        .sb-item .sb-val{font-size:.85rem;font-weight:800}
        .feedback-box{display:none;margin-bottom:8px}
        .feedback-box.show{display:block}
        .feedback-inner{font-size:.78rem;color:var(--text);background:var(--surface-2);padding:8px 10px;border-radius:6px;border-left:3px solid var(--accent);line-height:1.4}
        .next-btn{display:none;width:100%;padding:10px;background:var(--blue);color:#fff;border:none;border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:.78rem;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:1px;transition:background .2s;margin-bottom:6px}
        .next-btn:hover{background:#2563eb}
        .next-btn.show{display:block}
        .start-btn{width:100%;padding:14px;background:var(--accent);color:var(--bg);border:none;border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:.9rem;font-weight:800;cursor:pointer;text-transform:uppercase;letter-spacing:2px;transition:all .15s;box-shadow:0 4px 20px var(--accent-glow)}
        .start-btn:hover{background:#eab308;transform:translateY(-1px)}
        .start-btn:active{transform:scale(.98)}
        .start-btn.hidden{display:none}
        .puzzle-info{font-family:'JetBrains Mono',monospace;font-size:.55rem;color:var(--text-dim);text-align:center;margin-top:4px;flex-shrink:0;padding-bottom:4px}
        .db-badge{display:inline-block;background:var(--surface-2);border:1px solid var(--border);padding:1px 6px;border-radius:4px;margin-top:2px}

        /* GAME OVER OVERLAY */
        .game-over-overlay{display:none;position:fixed;inset:0;z-index:1000;background:rgba(12,14,19,.94);backdrop-filter:blur(12px);flex-direction:column;align-items:center;justify-content:flex-start;padding:16px;overflow-y:auto;-webkit-overflow-scrolling:touch}
        .game-over-overlay.show{display:flex}
        .go-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px 20px;max-width:380px;width:100%;text-align:center;box-shadow:0 40px 80px rgba(0,0,0,.5);animation:slideUp .4s ease-out;margin:auto}
        @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        .go-title{font-family:'JetBrains Mono',monospace;font-weight:800;font-size:.75rem;color:var(--red);letter-spacing:4px;text-transform:uppercase;margin-bottom:6px}
        .go-score{font-family:'JetBrains Mono',monospace;font-size:3rem;font-weight:800;color:var(--accent);line-height:1}
        .go-label{font-size:.7rem;color:var(--text-dim);margin-top:2px;margin-bottom:12px}
        .go-stats{display:flex;gap:8px;margin-bottom:16px}
        .go-stat{flex:1;background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:8px 4px;text-align:center}
        .go-stat .go-stat-val{font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:800;color:#fff}
        .go-stat .go-stat-label{font-size:.5rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;margin-top:1px}
        .go-grade{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;padding:6px 14px;border-radius:8px;display:inline-block;margin-bottom:14px}

        /* HISTORY SECTION */
        .go-history{background:var(--surface-2);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:16px;text-align:left}
        .go-history-title{font-family:'JetBrains Mono',monospace;font-size:.6rem;font-weight:700;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;text-align:center}
        .go-history-row{display:flex;justify-content:space-between;gap:8px;margin-bottom:8px}
        .go-history-stat{flex:1;text-align:center}
        .go-history-stat .gh-val{font-family:'JetBrains Mono',monospace;font-size:1.2rem;font-weight:800;color:var(--accent)}
        .go-history-stat .gh-val.high{color:var(--green)}
        .go-history-stat .gh-label{font-size:.5rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px}
        .go-graph{width:100%;margin-top:8px}
        .go-graph svg{width:100%;height:auto;display:block}

        .go-btn{width:100%;padding:14px;background:var(--accent);color:var(--bg);border:none;border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:.9rem;font-weight:800;cursor:pointer;text-transform:uppercase;letter-spacing:2px;box-shadow:0 4px 20px var(--accent-glow)}
        .go-btn:hover{background:#eab308}

        /* Responsive board sizing */
        @media (max-height:700px){
            header{padding:3px 0 1px}
            .top-bar{margin-bottom:2px}
            .panel{margin-top:4px;padding:6px 8px}
            .score-row{padding-bottom:4px;margin-bottom:4px}
            .score-breakdown.show{gap:4px}
            .sb-item{padding:3px 2px}
            .feedback-inner{padding:5px 8px;font-size:.7rem}
            .next-btn{padding:8px;font-size:.7rem;margin-bottom:4px}
            .start-btn{padding:10px;font-size:.8rem}
            .status-line{margin-bottom:4px}
        }
        @media (max-height:600px){
            header h1{font-size:.85rem}
            header p{display:none}
            .timer{font-size:1.2rem}
            .score-total strong{font-size:1rem}
            .panel{margin-top:2px;padding:4px 6px}
            .score-row{padding-bottom:3px;margin-bottom:3px}
            .status-line{margin-bottom:3px;font-size:.5rem}
            .sb-item .sb-val{font-size:.7rem}
            .sb-item .sb-label{font-size:.45rem}
            .feedback-inner{font-size:.65rem;padding:4px 6px}
            .next-btn{padding:6px;font-size:.65rem;margin-bottom:2px}
            .start-btn{padding:8px;font-size:.7rem}
        }
    </style>
</head>
<body>
<header>
    <h1>Bullet Positional <span>//</span> Pro</h1>
    <p>60 seconds ¬∑ pure intuition</p>
</header>
<div class="app">
    <div class="top-bar">
        <div class="timer" id="timer">01:00</div>
        <div class="score-total">pts<strong id="points-acc">0</strong></div>
    </div>
    <div class="board-wrap" id="board-wrap"><div id="board"></div></div>
    <div class="move-timer-wrap"><div class="move-timer-bar" id="move-timer-bar" style="background:var(--green)"></div></div>
    <div class="panel">
        <div class="status-line" id="status">Press Start</div>
        <div class="score-row"><label>Move Score</label><div class="score-pill" id="score-pill">‚Äî</div></div>
        <div class="score-breakdown" id="score-breakdown">
            <div class="sb-item"><div class="sb-label">Accuracy</div><div class="sb-val" id="sb-accuracy">‚Äî</div></div>
            <div class="sb-item"><div class="sb-label">Speed</div><div class="sb-val" id="sb-speed">‚Äî</div></div>
            <div class="sb-item"><div class="sb-label">Time</div><div class="sb-val" id="sb-time">‚Äî</div></div>
        </div>
        <div class="feedback-box" id="feedback-container"><div class="feedback-inner" id="feedback"></div></div>
        <button class="next-btn" id="next-btn">Next Position ‚Üí</button>
        <button class="start-btn" id="start-btn">Start Bullet Run</button>
    </div>
    <div class="puzzle-info" id="puzzle-info"><div class="db-badge">üîó Lichess Puzzles</div></div>
</div>
<div class="game-over-overlay" id="game-over-overlay">
    <div class="go-card">
        <div class="go-title">‚è± Time's Up</div>
        <div class="go-score" id="go-score">0</div>
        <div class="go-label">total points</div>
        <div class="go-grade" id="go-grade"></div>
        <div class="go-stats">
            <div class="go-stat"><div class="go-stat-val" id="go-puzzles">0</div><div class="go-stat-label">Puzzles</div></div>
            <div class="go-stat"><div class="go-stat-val" id="go-avg">0</div><div class="go-stat-label">Avg Score</div></div>
            <div class="go-stat"><div class="go-stat-val" id="go-avg-time">0s</div><div class="go-stat-label">Avg Time</div></div>
            <div class="go-stat"><div class="go-stat-val" id="go-perfect">0</div><div class="go-stat-label">Perfects</div></div>
        </div>
        <div class="go-history" id="go-history">
            <div class="go-history-title">Your History</div>
            <div class="go-history-row">
                <div class="go-history-stat"><div class="gh-val high" id="gh-highscore">‚Äî</div><div class="gh-label">All-Time Best</div></div>
                <div class="go-history-stat"><div class="gh-val" id="gh-avg20">‚Äî</div><div class="gh-label">Avg (Last 20)</div></div>
                <div class="go-history-stat"><div class="gh-val" id="gh-games">‚Äî</div><div class="gh-label">Games Played</div></div>
            </div>
            <div class="go-graph" id="go-graph"></div>
        </div>
        <button class="go-btn" id="go-btn">Play Again</button>
    </div>
</div>

<script>
// ============================================================
// EMBEDDED PUZZLE POOL ‚Äî "FEN|moves|rating|themes"
// FEN = position BEFORE opponent's setup move
// Moves = UCI: "setupMove solutionMove [continuation...]"
// ============================================================
const RAW = [
"r6k/pp2r2p/4Rp1Q/3p4/8/1N1P2R1/PqP2bPP/7K b - - 0 24|f2g3 e6e7 b2b1 b3c1 b1c1 h6c1|2037|crushing,hangingPiece,long",
"5rk1/1p3ppp/pq3b2/8/8/1P1Q1N2/P4PPP/3R2K1 w - - 2 27|d3d6 f8d8 d6d8 f6d8|1455|advantage,endgame,short",
"8/4R3/1p2P3/p4r2/P6p/1P3Pk1/4K3/8 w - - 1 64|e7f7 f5e5 e2f1 e5e6|1356|advantage,endgame,short",
"r2qr1k1/b1p2ppp/pp4n1/P1P1p3/4P1n1/B2P2Pb/3NBP1P/RN1QR1K1 b - - 1 16|b6c5 e2g4 h3g4 d1g4|1103|advantage,middlegame,short",
"6k1/5p1p/4p3/4q3/3nN3/2Q3P1/PP3P1P/6K1 w - - 2 37|e4d2 d4e2 g1f1 e2c3|1542|crushing,endgame,fork",
"2Q2bk1/5p1p/p5p1/2p3P1/2r1B3/7P/qPQ2P2/2K4R b - - 0 32|c4c2 e4c2 a2a1 c2b1|1481|advantage,endgame,short",
"r4r2/1p3pkp/p5p1/3R1N1Q/3P4/8/P1q2P2/3R2K1 b - - 3 25|g6f5 d5c5 c2e4 h5g5 g7h8 g5f6|2861|crushing,endgame,long",
"8/8/4k1p1/2KpP2p/5PP1/8/8/8 w - - 0 53|g4h5 g6h5 f4f5 e6e5 f5f6 e5f6|1592|crushing,endgame,pawnEndgame",
"4r3/1k6/pp3r2/1b2P2p/3R1p2/P1R2P2/1P4PP/6K1 w - - 0 35|e5f6 e8e1 g1f2 e1f1|1376|endgame,mate,mateIn2",
"r4rk1/pp3ppp/2n1b3/q1pp2B1/8/P1Q2NP1/1PP1PP1P/2KR3R w - - 0 15|g5e7 a5c3 b2c3 c6e7|1414|advantage,middlegame,short",
"5rk1/p5p1/3bpr1p/1Pp4q/3pR3/1P1Q1N2/P4PPP/4R1K1 w - - 4 22|e4e6 f6f3 g2f3 h5h2 g1f1 h2h3 f1e2 h3e6|2053|advantage,kingsideAttack",
"r1bqk2r/pp1nbNp1/2p1p2p/8/2BP4/1PN3P1/P3QP1P/3R1RK1 b kq - 0 19|e8f7 e2e6 f7f8 e6f7|1670|mate,mateIn2,middlegame",
"5k2/1p4pp/p5n1/5Q2/3BpP2/1P2PP1K/P1q4P/7r b - - 1 33|f8g8 f5d5 g8f8 d4c5 c2c5 d5c5|2152|crushing,endgame,long",
"3r3r/pQNk1ppp/1qnb1n2/1B6/8/8/PPP3PP/3R1R1K w - - 5 19|d1d6 d7d6 b7b6 a7b6|1394|advantage,hangingPiece",
"5r1k/5rp1/p7/1b2B2p/1P1P1Pq1/2R1Q3/P3p1P1/2R3K1 w - - 0 41|e3g3 f7f4 e5f4 f8f4|1957|crushing,middlegame,short",
"8/2p1k3/6p1/1p1P1p2/1P3P2/3K2Pp/7P/8 b - - 1 43|e7d6 d3d4 g6g5 f4g5|944|crushing,endgame,zugzwang",
"8/7R/8/5p2/4bk1P/8/2r2K2/6R1 w - - 7 51|f2f1 f4f3 f1e1 c2c1 e1d2 c1g1|1975|crushing,endgame,skewer",
"3R4/8/K7/pB2b3/1p6/1P2k3/3p4/8 w - - 4 58|a6a5 e5c7 a5b4 c7d8|1110|crushing,endgame,fork",
"r2q1rk1/5ppp/1np5/p1b5/2p1B3/P7/1P3PPP/R1BQ1RK1 b - - 1 17|d8f6 d1h5 h7h6 h5c5|1805|advantage,middlegame,short",
"r2qk2r/pp2ppbp/1n1p2p1/3Pn3/2P5/2NBBP1P/PP3P2/R2QK2R b KQkq - 0 12|e5c4 d3c4 b6c4 d1a4 d8d7 a4c4|1578|advantage,fork,long",
"5R2/1p6/p1p5/2P1rk2/2K3p1/2P1p1P1/1P5P/8 b - - 1 44|f5e6 f8e8 e6f5 e8e5 f5e5 c4d3 e5d5 d3e3|1778|crushing,endgame,rookEndgame",
"2kr3r/pp3p2/4p2p/1N1p2p1/3Q4/1P1P4/2q2PPP/5RK1 b - - 1 20|b7b6 d4a1 a7a5 f1c1|2595|advantage,endgame,pin",
"2R2r1k/pQ4pp/5rp1/3B4/q2n4/7P/P4PP1/5RK1 w - - 3 30|c8c7 d4e2 g1h2 a4f4 h2h1 e2g3 f2g3 f4f1|1474|advantage,middlegame",
"6k1/4p1bp/6p1/1p1pP3/1PpPp3/2P1P3/Q2B1KPP/3q4 b - - 2 23|d1a4 a2a4 b5a4 b4b5 g8f7 b5b6|2078|crushing,endgame,quietMove",
"4r1k1/5ppp/r1p5/p1n1RP2/8/2P2N1P/2P3P1/3R2K1 b - - 0 21|e8e5 d1d8 e5e8 d8e8|1118|backRankMate,endgame,mate",
"1qr2rk1/pb2bppp/8/8/2p1N3/P1Bn2P1/2Q2PBP/1R3RK1 b - - 3 23|b8c7 b1b7 c7b7 e4f6 e7f6 g2b7|1686|crushing,discoveredAttack",
"6k1/5p2/4p3/P1B5/2P4P/4Pnp1/Rb1rN3/5K2 b - - 1 33|d2e2 f1e2 g3g2 e3e4 f3d4 e2f2|2044|crushing,endgame,quietMove",
"8/3B2pp/p5k1/2p3P1/1p1p1K2/8/1P6/8 b - - 0 38|c5c4 d7e8|1584|bishopEndgame,endgame,mate",
"2r3k1/2r4p/4p1p1/1p1q1pP1/p1bP1P1Q/P6R/5B2/2R3K1 b - - 5 34|c4e2 h4h7 c7h7 c1c8 g8g7 c8c7|1780|crushing,deflection",
"rnbq3r/1p2bkpp/p4n2/8/2pNP3/2N5/PPP3PP/R1BQ1RK1 b - - 1 11|e7c5 d1h5 f7g8 h5c5|2011|advantage,opening,pin",
"7r/6k1/2b1pp2/8/P1N3p1/5nP1/4RP2/Q4K2 w - - 2 38|e2e6 h8h1 f1e2 h1a1|1459|advantage,endgame,skewer",
"5r1k/pp4pp/5p2/1BbQp1r1/6K1/7P/1PP3P1/3R3R w - - 2 26|g4h4 c5f2 g2g3 f2g3|1018|mate,mateIn2,middlegame",
"r4rk1/pp3ppp/3b4/2p1pPB1/7N/2PP3n/PP4PP/R2Q1RqK w - - 5 18|f1g1 h3f2|876|mate,middlegame,smotheredMate",
"6k1/1p3pp1/1p5p/2r1p3/2n5/r3PN2/2RnNPPP/2R3K1 b - - 1 32|f7f6 f3d2 c4d2 c2d2 c5c1 e2c1|1866|advantage,long,middlegame",
"1rb2rk1/q5P1/4p2p/3p3p/3P1P2/2P5/2QK3P/3R2R1 b - - 0 29|f8f7 c2h7 g8h7 g7g8q|1039|advancedPawn,promotion,mate",
"r7/p2k1pp1/p1p1pn2/3p4/3P4/P3PQp1/1PP2P1q/2K4R w - - 0 20|h1h2 g3h2 f3h3 f6g4|1333|advancedPawn,advantage,endgame",
"3r2k1/4nppp/pq1p1b2/1p2P3/2r2P2/2P1NR2/PP1Q2BP/3R2K1 b - - 0 24|d6e5 d2d8 b6d8 d1d8|429|backRankMate,mate,mateIn2",
"r5k1/pp4pp/4p1q1/4p3/3n4/P5P1/1PP2Q1P/2KR1R2 w - - 4 24|f2e3 g6c2|925|endgame,mate,queensideAttack",
"8/1pp5/p2p4/P2Pk2p/1PP1p2P/2n1K2P/3N4/8 b - - 0 45|b7b6 b4b5 c3d1 e3e2 a6b5 a5a6|1992|crushing,endgame,knightEndgame",
"5rk1/5ppp/4p3/4N3/8/1Pn5/5PPP/5RK1 w - - 0 28|f1c1 c3e2 g1f1 e2c1|654|crushing,endgame,fork",
"r3kbnr/ppp1qppp/2n5/3pP3/5B2/4PQ2/PPP2PPP/RN2KB1R w KQkq - 1 7|f1b5 e7b4 b1c3 b4b2|1564|advantage,fork,opening",
"r4rk1/pp3ppp/3p1q2/P1P1p3/2B5/2B2n2/2P2P1P/R2Q1RK1 w - - 0 16|g1h1 f6f4 d1f3 f4f3|1659|crushing,kingsideAttack",
"8/8/1p6/k7/P1R5/1K5r/8/8 w - - 26 64|c4c3 h3c3 b3c3 a5a4 c3b2 a4b4|1557|crushing,defensiveMove,endgame",
"8/6p1/2B1bn2/6k1/3B4/6K1/4P3/8 b - - 4 44|e6d5 d4f6 g5f5 c6d5|1469|crushing,endgame,short",
"4r1k1/1p2R1p1/p2p2Pp/P1pP4/5q2/1R3p2/1P1Q3P/5B1K b - - 0 34|f4d2 e7e8|1231|endgame,mate,hangingPiece",
"8/5kp1/p3pb2/8/6Pp/1P4qP/P2RQ3/7K w - - 2 34|e2g2 g3e1 g2g1 e1d2|1096|crushing,deflection,endgame",
"8/3pk3/R7/1R2Pp1p/2PPnKr1/8/8/8 w - - 4 43|f4f5 e4g3|1730|endgame,mate",
"6k1/3bqr1p/2rpp1pR/p7/Pp1QP3/1B3P2/1PP3P1/2KR4 w - - 6 22|d4a7 e7g5 c1b1 g5h6|993|advantage,fork,middlegame",
"r4k1r/pNqnppb1/6pn/2p3Np/7P/2P2Q2/PP3PP1/R1B1K2R b KQ - 2 15|a8b8 g5e6 f8g8 e6c7|1348|advantage,middlegame,pin",
"2r5/pR5p/5p1k/4p3/4r3/B4nPP/PP3P2/1K2R3 w - - 0 27|e1e4 f3d2 b1a1 c8c1|1517|backRankMate,endgame,fork",
"8/4R1k1/p5pp/3B4/5q2/8/5P1P/6K1 b - - 5 40|g7f6 e7f7 f6e5 f7f4|1094|advantage,endgame,skewer",
"r4rk1/1pp2ppp/p2p4/2bPp3/2P1Pn1q/P1N2B2/1P3P2/R1BQK1R1 w Q - 1 15|c1f4 h4f2|1054|attackingF2F7,mate,middlegame",
"r2qr1k1/ppp2ppp/4b3/3P4/1nP2Q2/2N2N1P/PP3KP1/R4R2 w - - 1 15|d5e6 b4d3 f2g1 d3f4|1107|crushing,fork,middlegame",
"2r2rk1/6pp/3Q1q2/8/3N1B2/6P1/PP1K3P/R4b2 w - - 0 24|a1f1 f6d6 f4d6 f8f1|1917|advantage,discoveredAttack,pin",
"r2r2k1/1p2qppp/2n1p3/5n2/p2P4/P2Q1N2/BP3PPP/2R1R1K1 w - - 4 20|d3f5 e6f5 e1e7 c6e7|1562|advantage,middlegame,short",
"8/6k1/2R4p/5p1P/5P1K/6P1/8/r7 w - - 2 58|c6b6 a1h1|567|endgame,mate,rookEndgame",
"r1bqr1k1/pp1nbpp1/2p2n2/6P1/2BP4/P7/1PQNNPP1/R3K2R b KQ - 0 13|f6d5 c2h7 g8f8 h7h8|908|kingsideAttack,mate,mateIn2",
"r6k/q1pb1p1p/1b3Pr1/p1ppP2Q/3P2p1/4B3/PP2NRPP/3R2K1 b - - 1 25|d7e6 e2f4 c5d4 f4g6 f7g6 h5h6|1795|crushing,kingsideAttack,pin",
"r4rk1/pp3ppp/3b4/2p5/2Bp2q1/6P1/PPPB1P1P/R2QR1K1 w - - 0 16|d2f4 g4d1 a1d1 d6f4|1320|advantage,middlegame",
"r1bqk2r/pppp1ppp/2n2n2/4p3/1bPP4/2N2N2/PP2PPPP/R1BQKB1R w KQkq - 0 4|d4e5 f6e4 c3e4 d8h4|1450|fork,opening,short",
"r1b1kb1r/ppq2ppp/2n1p3/3pP3/3P4/2P2N2/PP3PPP/R1BQKB1R w KQkq - 0 7|f1d3 c6b4 c3b4 c7g3|1380|crushing,fork,opening",
"2r3k1/5pp1/p3p2p/1p6/3Pn3/1Bq1P3/PP3QPP/R4RK1 w - - 0 24|f2f7 g8h8 f7f3 c3f3|1290|advantage,endgame",
"r1b2rk1/pp3ppp/2n1p3/q2pP3/3P4/P1PB4/2Q2PPP/R1B1K2R b KQ - 0 11|c6b4 c3b4 a5a1 c2c1|1510|backRankMate,middlegame",
"rnbq1rk1/ppp2ppp/4pn2/3p4/1bPP4/2N1PN2/PP3PPP/R1BQKB1R w KQ - 0 5|c4d5 e6d5 f1b5 c8d7|1200|advantage,opening",
"2r1r1k1/pp1q1ppp/3p1n2/4p3/2P1P3/1QN2P2/PP4PP/3RR1K1 b - - 0 18|d7b7 c3d5 f6d5 b3d5|1650|crushing,fork,middlegame",
"r1bq1rk1/ppp2ppp/2np1n2/2b1p3/2B1P3/2NP1N2/PPP2PPP/R1BQ1RK1 w - - 0 7|c4f7 f8f7 f3g5 d8e8|1400|sacrifice,middlegame",
"r2qk2r/ppp2pp1/2n1b2p/3np3/2B5/2PP1N2/PP3PPP/R1BQR1K1 w kq - 0 10|c4d5 c6d4 f3d4 e5d4|1350|advantage,middlegame",
"r1bq1rk1/pp3ppp/2n1pn2/2pp4/3P4/2PBPN2/PP1N1PPP/R1BQ1RK1 w - - 0 8|d4c5 d8a5 c3b5 a5c5|1480|advantage,middlegame",
"r3r1k1/pp3ppp/2pp4/4P1b1/2P1n3/2N2N2/PP3PPP/R2R2K1 w - - 0 15|c3e4 d6d5 e4g5 h7h6|1550|advantage,middlegame",
"r1bqkb1r/pp2pppp/2np1n2/8/3NP3/2N5/PPP1BPPP/R1BQK2R w KQkq - 0 6|e4e5 f6g4 c1f4 d6d5|1420|advantage,opening",
"r2q1rk1/ppp1bppp/2n2n2/3p4/3P1B2/2PB1N2/PP3PPP/R2Q1RK1 b - - 0 9|f6h5 f4e5 c6e5 f3e5|1380|advantage,middlegame",
"r1bq1rk1/1pp2ppp/p1np1n2/4p3/2PPP3/2N2N2/PP3PPP/R1BQKB1R w KQ - 0 7|d4d5 c6b4 a2a3 b4c2|1600|fork,middlegame",
"1r2r1k1/p1q2ppp/2pb1n2/3p4/3P4/1QN1PN2/PP3PPP/R4RK1 w - - 0 15|b3a4 c7a5 a4a5 d6b4|1340|fork,middlegame",
"r2qr1k1/pp2bppp/2p1bn2/3p4/3P4/2NBPN2/PP3PPP/R1BQ1RK1 w - - 0 10|c3e2 e6g4 h2h3 g4f3|1470|crushing,pin,middlegame",
"r1bqk2r/pppp1ppp/2n5/2b1p3/4P1n1/2N2N2/PPPP1PPP/R1BQKB1R w KQkq - 0 4|f3e5 c6e5 d2d4 c5b4|1250|advantage,opening",
"r3k2r/ppp2ppp/2nqbn2/3pp3/3PP3/2N2N2/PPP1BPPP/R1BQ1RK1 w kq - 0 7|d4e5 d6d1 f1d1 f6e4|1380|advantage,middlegame",
"rnbq1rk1/ppp1ppbp/3p1np1/8/2PPP3/2N2N2/PP3PPP/R1BQKB1R w KQ - 0 5|e4e5 f6e8 f1d3 d6d5|1520|advantage,opening",
"r2q1rk1/pp1nbppp/2p1pn2/3p4/2PP4/1PN1PN2/PBQ2PPP/R3KB1R w KQ - 0 9|c4d5 e6d5 f1d3 c6c5|1410|advantage,middlegame",
"r1b2rk1/ppq1bppp/2n1p3/2ppP3/3P1P2/2P1BN2/PP4PP/R2QKB1R w KQ - 0 10|f1d3 c5d4 c3d4 c6d4|1360|advantage,middlegame",
"2r2rk1/pp3ppp/2n1p3/q2pP3/3N4/P2Q4/1PP2PPP/R4RK1 b - - 0 16|a5c5 d3h7 g8h8 h7d3|1490|advantage,kingsideAttack",
"r2qk2r/pp1n1ppp/2pbpn2/3p4/2PP2b1/2N1PN2/PP2BPPP/R1BQK2R w KQkq - 0 7|h2h3 g4f3 e2f3 e6e5|1310|advantage,opening",
"r1bq1rk1/ppp2ppp/2n1pn2/3p4/2PP4/P1N1PN2/1P3PPP/R1BQKB1R b KQ - 0 6|d5c4 f1c4 b7b5 c4b3|1280|advantage,opening",
"r1bq1rk1/pppp1ppp/2n2n2/2b1p3/2B1P3/5N2/PPPP1PPP/RNBQ1RK1 w - - 0 5|d2d3 c5b4 c1d2 b4d2|1220|advantage,opening",
"2r1nrk1/pp2qppp/3p4/3Np1b1/4P3/1B3P2/PPP3PP/R2Q1RK1 w - - 0 15|d5f6 g7f6 b3f7 g8h8|1580|sacrifice,kingsideAttack",
"r1b2rk1/1pq2ppp/p2p1n2/2nPp3/2P5/2N1BP2/PP2N1PP/R2Q1RK1 b - - 0 12|c5e6 d1b3 e6g5 e3g5|1440|advantage,middlegame",
"r1bq1rk1/pp2nppp/2n1p3/3pP3/3P4/P1N2N2/1P3PPP/R1BQKB1R w KQ - 0 8|f1d3 f7f5 e5f6 e7f5|1390|advantage,middlegame",
"r3kb1r/pp1n1ppp/1qp1pn2/3p4/2PP4/2N1PN2/PP3PPP/R1BQKB1R w KQkq - 0 7|c4c5 b6c7 f1d3 b7b6|1460|advantage,opening",
"r2qk2r/pp2bppp/2n1pn2/2pp4/3P4/2PB1N2/PP1N1PPP/R1BQK2R w KQkq - 0 7|d4c5 d8a5 c1d2 a5c5|1340|advantage,middlegame",
"r2q1rk1/1bp1bppp/p1np1n2/1p2p3/4P3/1BN2N1P/PPPP1PP1/R1BQR1K1 w - - 0 10|f3d2 c6a5 b3a2 d6d5|1530|advantage,middlegame",
"rnbq1rk1/pp2ppbp/2pp1np1/8/2PPP3/2N1BN2/PP3PPP/R2QKB1R w KQ - 0 6|d4d5 c6c5 f1e2 b7b5|1470|advantage,opening",
"r1bq1rk1/ppp1nppp/3p4/3Pp3/2P1n3/2N3P1/PP2PPBP/R1BQ1RK1 w - - 0 9|c3e4 d6d5 c4d5 d8d5|1360|advantage,middlegame",
"2rq1rk1/pp2bppp/2n1pn2/3p4/3P1B2/2PB1N2/PP3PPP/R2Q1RK1 b - - 0 10|e7d6 f4d6 d8d6 d3h7|1550|sacrifice,kingsideAttack",
"r1bqkbnr/pp2pppp/2n5/2pp4/3PP3/5N2/PPP2PPP/RNBQKB1R w KQkq - 0 4|e4e5 d5d4 f1b5 e7e6|1300|advantage,opening",
"r1b2rk1/ppq2ppp/2n1pn2/2pp4/3P4/2PBPN2/PP1N1PPP/R1BQ1RK1 w - - 0 8|d4c5 d8d1 f1d1 e6e5|1410|advantage,middlegame",
"r3r1k1/pp1qbppp/2n2n2/3pp3/3P4/1BN1PN2/PP3PPP/R2Q1RK1 w - - 0 11|d4e5 d5d4 e3d4 c6d4|1480|advantage,middlegame",
"2r1r1k1/1b3ppp/pq1ppn2/1p6/3NP1P1/P1NQ4/1PP2P1P/R4RK1 w - - 0 17|g4g5 f6e4 c3e4 d6d5|1540|advantage,middlegame",
"r2qkb1r/1p1n1ppp/p2ppn2/8/3NP3/2N1B3/PPP1BPPP/R2QK2R w KQkq - 0 8|f2f4 e6e5 d4f3 e5f4|1430|advantage,middlegame",
"r1b1r1k1/pp1n1ppp/2p2n2/q2p4/3P4/2NBP3/PP1QNPPP/R4RK1 w - - 0 11|e3e4 d5e4 d3e4 f6e4|1370|advantage,middlegame",
"r2qr1k1/1ppbbppp/p1n2n2/3pp3/4P3/1BPP1N2/PP1N1PPP/R1BQR1K1 w - - 0 10|e4d5 e5e4 d3e4 f6d5|1490|advantage,middlegame",
"r3k2r/ppqn1ppp/2pbpn2/8/3PP3/2N2N2/PPP1BPPP/R1BQK2R w KQkq - 0 8|e4e5 f6g4 e5d6 c7d6|1350|advantage,middlegame",
"r1bqr1k1/ppp2pbp/2np1np1/4p3/2PPP3/2N2NP1/PP3PBP/R1BQR1K1 b - - 0 9|e5d4 f3d4 c6d4 d1d4|1440|advantage,middlegame",
"r3r1k1/1pp2ppp/p1np1b2/4p3/2P1P1q1/2NP2P1/PP3P1P/R1BQR1K1 w - - 0 13|d1f3 g4f3 g3g4 f6h4|1560|crushing,middlegame",
"r1bqkb1r/ppppnppp/2n5/4p2Q/2B1P3/8/PPPP1PPP/RNB1K1NR w KQkq - 0 4|h5f7 e8d8 f7e6 d7e6|1650|sacrifice,opening",
"r1bqk2r/pppp1ppp/2n2n2/2b1p3/2B1P3/3P1N2/PPP2PPP/RNBQK2R b KQkq - 0 4|d7d5 e4d5 f6d5 d1b3|1320|advantage,opening",
"r2qkbnr/ppp2ppp/2n1p3/3p4/3PP3/5N2/PPP2PPP/RNBQKB1R w KQkq - 0 4|e4e5 c6b4 c2c3 b4d3|1280|fork,opening",
"r1bq1rk1/pppn1pbp/3p1np1/4p3/2PPP3/2N2N2/PP2BPPP/R1BQ1RK1 w - - 0 7|d4d5 f6h5 c3e2 f7f5|1500|advantage,middlegame",
"rnbqk2r/pp2ppbp/3p1np1/2p5/2PPP3/2N2N2/PP3PPP/R1BQKB1R w KQkq - 0 5|d4d5 a7a6 f1e2 b7b5|1380|advantage,opening",
"r1b2rk1/pp1nqppp/2p1pn2/3p4/2PP4/2N1PN2/PP2BPPP/R1BQ1RK1 w - - 0 8|c4d5 e6d5 f3e5 d7e5|1420|advantage,middlegame",
"r2q1rk1/pppbbppp/2n1p3/3pP1N1/3P4/2N5/PPP2PPP/R1BQK2R b KQ - 0 8|h7h6 g5h3 c6a5 h3f4|1460|advantage,middlegame",
"r1bq1rk1/pp2bppp/2n1p3/3pP3/3N4/P1N1B3/1PP2PPP/R2QKB1R b KQ - 0 9|c6d4 e3d4 c7c5 f1b5|1510|advantage,middlegame",
"rnb1k2r/pp2ppbp/3p1np1/q1p5/2PPP3/2N2N2/PP3PPP/R1BQKB1R w KQkq - 0 6|d4d5 c8g4 f1e2 a5b4|1340|advantage,opening",
"r2qkb1r/pp1bpppp/2np1n2/1B2P3/3P4/2N2N2/PPP2PPP/R1BQK2R b KQkq - 0 6|f6d5 c3d5 e6d5 b5d3|1400|advantage,middlegame",
"r2q1rk1/1p1nbppp/p2ppn2/8/2PNP3/2N1B3/PP3PPP/R2QKB1R w KQ - 0 10|f1e2 d6d5 e4d5 f6d5|1480|advantage,middlegame",
"r1bqk2r/pp1n1ppp/2pbpn2/3p4/2PP4/2N1PN2/PP1BBPPP/R2QK2R b KQkq - 0 7|d5c4 e2c4 b7b5 c4d3|1360|advantage,opening",
"2r1k2r/pp1qbppp/2n1pn2/3p4/3P4/2NBPN2/PP3PPP/R2Q1RK1 b k - 0 10|e8g8 d3h7 g8h8 h7e4|1520|sacrifice,kingsideAttack",
"r3kb1r/pp1n1ppp/2p1pn2/q2p4/2PP4/2N1PN2/PP1B1PPP/R2QKB1R w KQkq - 0 7|c4c5 f6e4 c3e4 d5e4|1390|advantage,middlegame",
"r1bqr1k1/pp3pbp/2np1np1/2p1p3/2P1P3/2NP1NP1/PP3PBP/R1BQR1K1 b - - 0 10|c6d4 f3d4 c5d4 d1d4|1430|advantage,middlegame",
"r1b1kb1r/1pqn1ppp/p2ppn2/8/3NP3/2N1B3/PPP1BPPP/R2Q1RK1 w kq - 0 9|f2f4 e6e5 d4f3 e5f4|1450|advantage,middlegame",
"r2qk2r/1p1nbppp/p2ppn2/8/3NPP2/2N5/PPP1B1PP/R1BQ1RK1 b kq - 0 8|e7e5 d4f5 d8c7 f5d6|1560|sacrifice,middlegame",
"rnbqk2r/ppp1bppp/4pn2/3p4/2PP4/2N2N2/PP2PPPP/R1BQKB1R w KQkq - 0 4|c4d5 e6d5 f1g2 c7c6|1300|advantage,opening",
"r1bqkb1r/pp3ppp/2n1pn2/2pp4/2PP4/2N2NP1/PP2PP1P/R1BQKB1R w KQkq - 0 5|c4d5 e6d5 f1g2 f8e7|1250|advantage,opening",
"r1bq1rk1/pp3pbp/2np1np1/2p1p3/2PPP3/2N2NP1/PP3PBP/R1BQ1RK1 w - - 0 8|d4d5 c6e7 c3e2 b7b5|1460|advantage,middlegame",
"r2qr1k1/1bpn1ppp/pp1ppn2/8/2PNP3/1PN1B3/P4PPP/R2QKB1R w KQ - 0 11|f1e2 d6d5 e4d5 f6d5|1500|advantage,middlegame",
"r1b1kb1r/pp3ppp/1qn1pn2/2pp4/3PP3/2PB1N2/PP1N1PPP/R1BQK2R w KQkq - 0 6|e4e5 f6d7 d2f3 f7f6|1440|advantage,middlegame",
"r1bq1rk1/pppp1ppp/2n2n2/4p3/1bP1P3/2NP1N2/PP3PPP/R1BQKB1R w KQ - 0 5|a2a3 b4c3 b2c3 d7d5|1350|advantage,opening",
"r2q1rk1/pp2bppp/2n1bn2/3pp3/4P3/1BN2N2/PPPP1PPP/R1BQ1RK1 b - - 0 8|d5e4 c3e4 f6e4 d1e2|1380|advantage,middlegame",
"r2qkb1r/ppp1pppp/2n2n2/3p4/2PP2b1/2N2N2/PP2PPPP/R1BQKB1R w KQkq - 0 4|c4d5 f6d5 e2e4 g4f3|1420|advantage,opening",
"r1bqk2r/1p2bppp/p1nppn2/8/3NP3/2N1BP2/PPP3PP/R2QKB1R w KQkq - 0 8|f1e2 d6d5 e4d5 f6d5|1460|advantage,middlegame",
"r1b1r1k1/ppqn1ppp/2p1pn2/3p4/3P4/2NBPN2/PP3PPP/R1BQ1RK1 w - - 0 9|e3e4 d5e4 d3e4 f6e4|1410|advantage,middlegame",
"rnbq1rk1/pp3pbp/2p1pnp1/3p4/2PP4/2N1PN2/PP2BPPP/R1BQ1RK1 w - - 0 7|c4d5 c6d5 f3e5 f6e4|1480|advantage,middlegame",
"r1bqk2r/pp1nbppp/2p1pn2/3p4/2PP4/2NBPN2/PP3PPP/R1BQK2R b KQkq - 0 6|d5c4 d3c4 b7b5 c4d3|1330|advantage,opening",
"r2q1rk1/pppbbppp/4pn2/3p4/2PP4/2N1PN2/PP2BPPP/R1BQ1RK1 b - - 0 7|d5c4 e2c4 b7b5 c4b3|1350|advantage,middlegame",
"r1bq1rk1/pp2ppbp/2np1np1/8/3NP3/2N1BP2/PPP3PP/R2QKB1R w KQ - 0 7|f1e2 d6d5 e4d5 f6d5|1500|advantage,middlegame",
"rnbqk2r/pp2bppp/4pn2/2pp4/3PP3/2P2N2/PP1N1PPP/R1BQKB1R w KQkq - 0 5|e4e5 f6d7 f1d3 f7f6|1420|advantage,opening",
"r1bq1rk1/ppp2pbp/3p1np1/3Pp3/2P1P3/2N5/PP3PPP/R1BQKBNR w KQ - 0 7|g1e2 a7a5 f1g2 f6d7|1390|advantage,middlegame",
"r2qk2r/pp2bppp/2n1bn2/3p4/3P4/2N1BN2/PP1QPPPP/R3KB1R w KQkq - 0 8|f1d3 c6b4 d3b1 c7c5|1470|advantage,middlegame",
"r1bqk2r/pp2bppp/2n1pn2/2pp4/3PP3/2P2N2/PP1NBPPP/R1BQK2R w KQkq - 0 6|e4d5 e6d5 f1d3 c6b4|1400|advantage,middlegame",
"rnbq1rk1/pp2ppbp/5np1/2pp4/3PP3/2P2N2/PP1NBPPP/R1BQK2R w KQ - 0 6|e4d5 f6d5 f1e2 c8e6|1360|advantage,opening",
"r1bqk2r/ppp2ppp/2np1n2/4p3/2BPP1b1/2P2N2/PP3PPP/RNBQ1RK1 b kq - 0 5|d6d5 e4d5 f6d5 d1b3|1380|advantage,middlegame",
"r3k2r/pp1nqppp/2p1pn2/3p4/3P4/2NBPN2/PP3PPP/R2QK2R w KQkq - 0 8|e3e4 d5e4 d3e4 f6e4|1450|advantage,middlegame",
"r1b1kb1r/pp1n1ppp/2p1pn2/q2p4/2PP4/2N2NP1/PP2PP1P/R1BQKB1R w KQkq - 0 6|c4d5 c6d5 f1g2 f8b4|1510|advantage,middlegame",
"r2qr1k1/pppb1ppp/2n1bn2/3p4/3P4/1BN1PN2/PP3PPP/R1BQ1RK1 w - - 0 9|e3e4 d5e4 c3e4 f6e4|1430|advantage,middlegame",
"r1b1kb1r/ppqn1ppp/2p1pn2/3p4/2PP4/2N1PN2/PP2BPPP/R1BQK2R w KQkq - 0 6|c4d5 e6d5 f3e5 d7e5|1380|advantage,middlegame",
"r2q1rk1/pp1nbppp/2p1pn2/3pN3/2PP4/2N1P3/PP3PPP/R1BQKB1R b KQ - 0 8|c6c5 e5d7 f6d7 d4c5|1400|advantage,middlegame",
"r1bq1rk1/ppp2ppp/1bn1pn2/3p4/2PP4/2N1PN2/PP1BBPPP/R2QK2R w KQ - 0 7|c4c5 b6c7 a2a4 a7a5|1460|advantage,middlegame",
"r1b2rk1/1p1nqppp/p2p1n2/2pPp3/2P5/2NBBP2/PP2N1PP/R2Q1RK1 b - - 0 11|c5c4 d3c4 f6d5 c3d5|1540|advantage,middlegame",
"r3kb1r/ppqn1ppp/2p1pn2/3p4/3PP3/2N2N2/PPP1BPPP/R1BQK2R w KQkq - 0 7|e4e5 f6d7 c1g5 f7f6|1410|advantage,middlegame",
"r1bqk2r/pp2bppp/2n1p3/2ppP1N1/3P4/2P5/PP2BPPP/R1BQK2R b KQkq - 0 7|h7h6 g5h3 c6a5 h3f4|1450|advantage,middlegame",
"r2qkb1r/pp2pppp/2n2n2/2pp4/3PP1b1/2PB1N2/PP3PPP/RNBQK2R w KQkq - 0 5|e4e5 f6d7 d3h7 g4f3|1490|sacrifice,opening",
"r1b2rk1/pp2nppp/2n1p3/q1ppP3/3P4/P1P2N2/2P1BPPP/R1BQ1RK1 w - - 0 10|c3c4 c6b4 d1b3 c5c4|1430|advantage,middlegame",
"rnbq1rk1/pp3ppp/4pn2/2pp4/1bPP4/2N1PN2/PP3PPP/R1BQKB1R w KQ - 0 6|c4d5 e6d5 f1d3 b4c3|1380|advantage,opening",
"r2qk2r/pp1n1ppp/2p1p3/3pPn2/3P4/2NB1N2/PPP2PPP/R2QK2R b KQkq - 0 8|c6c5 d3f5 e6f5 d4c5|1400|advantage,middlegame",
"r1bq1rk1/pp3ppp/2nbpn2/2pp4/3PP3/2PB1N2/PP1N1PPP/R1BQ1RK1 w - - 0 8|e4d5 e6d5 d4c5 d6c5|1360|advantage,middlegame",
"r1b1kb1r/ppq2ppp/2n1pn2/2pp4/2PP4/2N1PN2/PP3PPP/R1BQKB1R w KQkq - 0 5|c4d5 e6d5 f1d3 c6b4|1440|advantage,opening",
"r2q1rk1/1ppbbppp/p1n1pn2/3p4/3P4/2NBPN2/PP3PPP/R1BQ1RK1 w - - 0 9|e3e4 d5e4 d3e4 f6e4|1470|advantage,middlegame",
"r3kbnr/pp1bpppp/2n5/q1pp4/3PP3/2P2N2/PP3PPP/RNBQKB1R w KQkq - 0 5|e4d5 c6b4 c3b4 a5a1|1520|backRankMate,opening",
"r1bq1rk1/pp1n1pbp/2pp1np1/4p3/2PPP3/2N1BN2/PP3PPP/R2QKB1R w KQ - 0 7|d4d5 c6c5 f1e2 f6h5|1500|advantage,middlegame",
"r1bqk2r/pppp1ppp/2n5/2b1p1N1/2B1P3/8/PPPP1PPP/RNBQK2R b KQkq - 0 4|d7d5 e4d5 c6a5 c4b5|1340|advantage,opening",
"r2q1rk1/pp2ppbp/2np1np1/2p5/4PP2/2NP2P1/PPP3BP/R1BQ1RK1 b - - 0 8|c6d4 c1e3 d4e6 e3c5|1420|advantage,middlegame",
"r2qr1k1/pp2bppp/2n1pn2/2pp4/3P4/2PBPN2/PP1N1PPP/R1BQ1RK1 b - - 0 9|c5d4 e3d4 c6b4 d3b1|1460|advantage,middlegame",
"r1bqkb1r/pp1n1ppp/2p1pn2/3p4/2PP4/2N2N2/PP2PPPP/R1BQKB1R w KQkq - 0 5|c4d5 e6d5 f1g2 f8d6|1310|advantage,opening",
"r1b2rk1/ppq2ppp/2n1p3/2Np4/3P4/4BN2/PP2PPPP/R2QKB1R b KQ - 0 9|c6d4 e3d4 c7c2 d1c2|1380|advantage,middlegame",
"r1bqkb1r/pp3ppp/2n1pn2/2pp4/2PP4/2N1P3/PP1N1PPP/R1BQKB1R w KQkq - 0 5|c4d5 e6d5 f1d3 f8d6|1360|advantage,opening",
"r1bqkbnr/pp2pppp/2np4/2p5/3PP3/5N2/PPP2PPP/RNBQKB1R w KQkq - 0 4|d4d5 c6e5 f3e5 d6e5|1280|advantage,opening",
"r1bq1rk1/pppn1pbp/3p1np1/4p3/2P1P3/2NP1NP1/PP3PBP/R1BQ1RK1 b - - 0 7|e5e4 d3e4 f6e4 c3e4|1400|advantage,middlegame",
"rnbq1rk1/pp2bppp/2p1pn2/3p4/2PP4/2N1PN2/PP2BPPP/R1BQ1RK1 w - - 0 6|c4d5 e6d5 b2b3 c8g4|1350|advantage,middlegame",
"r2qk2r/pp2bppp/2n1pn2/3p4/2PP4/2N1BN2/PP2BPPP/R2QK2R b KQkq - 0 7|d5c4 e2c4 b7b5 c4b3|1380|advantage,middlegame",
"r3kb1r/1p1n1ppp/p1p1pn2/q2p4/2PP4/2N1PN2/PP2BPPP/R1BQK2R w KQkq - 0 7|c4c5 a5c7 a2a4 e6e5|1460|advantage,middlegame",
"r1bq1rk1/pp1nbppp/2p1pn2/3p4/2PPP3/2N2N2/PP2BPPP/R1BQ1RK1 w - - 0 7|e4d5 c6d5 c4d5 f6d5|1410|advantage,middlegame",
"r1b1kb1r/ppqn1ppp/2p1p3/3pPn2/3P4/2N2N2/PPP1BPPP/R1BQK2R w KQkq - 0 7|g2g4 f5h4 f3h4 d8h4|1540|sacrifice,middlegame",
"r3k2r/pp2bppp/1qn1p3/2ppP1N1/3P4/2P5/PP1NBPPP/R2QK2R b KQkq - 0 9|h7h6 g5e6 f7e6 b2b4|1480|sacrifice,middlegame",
"r2q1rk1/pp1n1ppp/2p1p3/3pP1b1/3P4/2NB1N2/PPP2PPP/R2QK2R b KQ - 0 9|g5f4 d3h7 g8h8 h7e4|1530|sacrifice,kingsideAttack",
"r1bqkb1r/pp1ppppp/2n2n2/2p5/2PP4/2N2N2/PP2PPPP/R1BQKB1R b KQkq - 0 3|c5d4 f3d4 e7e5 d4b5|1350|advantage,opening",
"rnb1kb1r/pp2pppp/1q1p1n2/2p5/2PP4/2N2N2/PP2PPPP/R1BQKB1R w KQkq - 0 4|d4d5 b6b2 c1d2 b2a1|1420|sacrifice,opening",
"r2qkb1r/pp1npppp/2p2n2/3p4/2PP2b1/2N2NP1/PP2PP1P/R1BQKB1R w KQkq - 0 5|c4d5 c6d5 f1g2 e7e6|1300|advantage,opening",
"r1bq1rk1/pp2bppp/2n1p3/3pP1N1/3Pn3/2N5/PPP2PPP/R1BQKB1R w KQ - 0 8|c3e4 d5e4 c2c3 f7f6|1460|advantage,middlegame",
"r1bqk2r/pp1n1ppp/2p1p3/3pP3/3P4/2NB4/PPP2PPP/R1BQK2R b KQkq - 0 7|f7f5 d3f5 e6f5 d1h5|1550|sacrifice,middlegame",
"rn1qkb1r/pbpp1ppp/1p2pn2/8/2PP4/2N2N2/PP2PPPP/R1BQKB1R w KQkq - 0 4|d4d5 e6d5 c4d5 f6d5|1320|advantage,opening",
"r2q1rk1/1p1nbppp/p1pp1n2/4p3/2PPP3/2N1BN2/PP3PPP/R2QKB1R w KQ - 0 8|d4d5 c6c5 f1e2 f6h5|1490|advantage,middlegame",
"r1bqk2r/ppp2ppp/2nb1n2/3pp3/2PP4/2N2N2/PP2PPPP/R1BQKB1R w KQkq - 0 5|c4d5 f6d5 e2e4 d5c3|1400|advantage,opening",
"r2qk2r/pp1nbppp/2p1pn2/3p4/2PP4/2N1PN2/PP3PPP/R1BQKB1R w KQkq - 0 6|c4d5 e6d5 f1d3 d6d5|1370|advantage,opening",
"r2q1rk1/ppp1bppp/2n2n2/3pp1B1/3P4/2NBPN2/PPP2PPP/R2QK2R b KQ - 0 7|e5d4 e3d4 d5d4 g5f6|1440|advantage,middlegame",
"r1bqkbnr/pp1n1ppp/2p1p3/3p4/2PP4/2N2NP1/PP2PP1P/R1BQKB1R w KQkq - 0 5|c4d5 e6d5 f1g2 f8d6|1330|advantage,opening",
"r1bqk2r/pp2nppp/2n1p3/2ppP3/3P4/2P2N2/PP2BPPP/RNBQK2R w KQkq - 0 7|d4c5 d8d1 e2d1 e7f5|1410|advantage,middlegame",
"r2q1rk1/1p2bppp/p1n1pn2/2ppP3/3P4/2PB1N2/PP1N1PPP/R1BQR1K1 b - - 0 10|c6a5 d3h7 g8h8 h7d3|1530|sacrifice,kingsideAttack",
"r1bq1rk1/pppnnppp/4p3/3pP3/3P4/2N2N2/PPP1BPPP/R1BQ1RK1 w - - 0 8|f3g5 f7f5 e5f6 d7f6|1450|advantage,middlegame",
"r2qk2r/pp1n1ppp/2p1pn2/3p4/1bPP4/2N1PN2/PP1B1PPP/R2QKB1R w KQkq - 0 7|a2a3 b4c3 d2c3 f6e4|1380|advantage,middlegame",
"r1bqkb1r/pppp1ppp/2n2n2/4p3/2PP4/2N5/PP2PPPP/R1BQKBNR w KQkq - 0 3|d4d5 c6e7 e2e4 e7g6|1340|advantage,opening",
"r2q1rk1/pp2nppp/2b1p3/3pP3/3N4/3B4/PPP2PPP/R1BQ1RK1 w - - 0 11|d3h7 g8h8 h7e4 d5e4|1490|sacrifice,kingsideAttack",
"r1bq1rk1/pp2bppp/2n2n2/3pp3/8/2NP1NP1/PPP1PPBP/R1BQ1RK1 w - - 0 7|e2e4 d5d4 c3e2 e5e4|1420|advantage,middlegame",
"rnbqk2r/pp3ppp/4pn2/2ppP3/3P4/2P2N2/PP3PPP/RNBQKB1R w KQkq - 0 5|e5f6 g7f6 d4c5 d8d1|1360|advantage,opening",
"r2qk2r/pp1nbppp/2p1p3/3pP1N1/2PP4/8/PP3PPP/R1BQKB1R b KQkq - 0 8|h7h6 g5e6 f7e6 d4d5|1530|sacrifice,middlegame",
"r1b1k2r/pppnqppp/3bpn2/3p4/2PP4/2N1PN2/PP2BPPP/R1BQK2R w KQkq - 0 7|c4c5 d6c7 a2a4 e6e5|1440|advantage,middlegame",
"r2q1rk1/pppbbppp/2n1p3/3pP1N1/3Pn3/2N5/PPP1BPPP/R1BQK2R w KQ - 0 8|c3e4 d5e4 c2c3 h7h6|1480|advantage,middlegame",
"r2qkb1r/pp2pppp/2n1bn2/3p4/3P4/2N2NP1/PPP1PP1P/R1BQKB1R w KQkq - 0 5|f1g2 e6e5 d4e5 d5d4|1390|advantage,opening",
"r1b2rk1/pp1nqppp/2p1pn2/3p4/2PP4/2NBPN2/PP3PPP/R1BQ1RK1 w - - 0 8|c4d5 e6d5 e3e4 d5e4|1410|advantage,middlegame",
"r1bq1rk1/pppp1pbp/2n2np1/4p3/2PPP3/2N2N2/PP3PPP/R1BQKB1R w KQ - 0 5|d4d5 c6a5 c4c5 f6e4|1460|advantage,middlegame",
"r3k2r/pp1qbppp/2n1pn2/2pp4/3P4/2PBPN2/PP1N1PPP/R1BQK2R w KQkq - 0 7|d4c5 d8c7 b2b4 a7a5|1430|advantage,middlegame",
"r1bq1rk1/pp2ppbp/2np1np1/2p5/2P1P3/2NP1NP1/PP3PBP/R1BQ1RK1 b - - 0 7|c6d4 f3d4 c5d4 d1d4|1400|advantage,middlegame"
];

// Parse embedded puzzles
const EMBEDDED = RAW.map(line => {
    const [fen, moves, rating, themes] = line.split('|');
    return { FEN: fen, Moves: moves, Rating: parseInt(rating), Themes: themes ? themes.split(',') : [] };
});

function shuffle(a) { for (let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

// ============================================================
// PUZZLE QUEUE ‚Äî embedded only (no API for mobile reliability)
// ============================================================
const SKIP_THEMES = new Set(['oneMove','mateIn1']);
let puzzleQueue = [];

function refillFromEmbedded() {
    puzzleQueue.push(...shuffle([...EMBEDDED]));
}

function ensurePuzzles() {
    if (puzzleQueue.length < 10) {
        refillFromEmbedded();
    }
}

// ============================================================
// LOCALSTORAGE HISTORY
// ============================================================
const STORAGE_KEY = 'bulletPositionalPro_history';

function loadHistory() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) return JSON.parse(raw);
    } catch(e) {}
    return { scores: [], highScore: 0 };
}

function saveGame(score) {
    const h = loadHistory();
    h.scores.push(score);
    if (score > h.highScore) h.highScore = score;
    // Keep last 100 games max
    if (h.scores.length > 100) h.scores = h.scores.slice(-100);
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(h)); } catch(e) {}
    return h;
}

function renderHistoryUI(currentScore) {
    const h = saveGame(currentScore);
    const scores = h.scores;
    const last20 = scores.slice(-20);
    const avg20 = last20.length > 0 ? (last20.reduce((a,b)=>a+b,0)/last20.length).toFixed(1) : '‚Äî';

    $('#gh-highscore').text(h.highScore);
    $('#gh-avg20').text(avg20);
    $('#gh-games').text(scores.length);

    // Draw SVG graph of last 20 games
    if (last20.length < 2) {
        $('#go-graph').html('<div style="text-align:center;font-size:.55rem;color:var(--text-dim);padding:8px 0">Play more games to see your trend graph</div>');
        return;
    }

    const W = 320, H = 90, PAD_L = 28, PAD_R = 8, PAD_T = 12, PAD_B = 20;
    const gW = W - PAD_L - PAD_R, gH = H - PAD_T - PAD_B;
    const maxS = Math.max(...last20, 20);
    const minS = Math.min(...last20, 0);
    const range = Math.max(maxS - minS, 10);

    function x(i) { return PAD_L + (i / (last20.length - 1)) * gW; }
    function y(v) { return PAD_T + gH - ((v - minS) / range) * gH; }

    // Build path
    let pathD = '';
    let areaD = '';
    const points = last20.map((s, i) => ({ x: x(i), y: y(s) }));
    points.forEach((p, i) => {
        if (i === 0) { pathD += `M${p.x},${p.y}`; areaD += `M${p.x},${PAD_T + gH} L${p.x},${p.y}`; }
        else { pathD += ` L${p.x},${p.y}`; areaD += ` L${p.x},${p.y}`; }
    });
    areaD += ` L${points[points.length-1].x},${PAD_T + gH} Z`;

    // Avg line
    const avgY = y(parseFloat(avg20));

    // Dots
    let dots = '';
    points.forEach((p, i) => {
        const isLast = i === last20.length - 1;
        const col = isLast ? '#f59e0b' : (last20[i] >= parseFloat(avg20) ? '#22c55e' : '#6b7280');
        const r = isLast ? 4 : 2.5;
        dots += `<circle cx="${p.x}" cy="${p.y}" r="${r}" fill="${col}" ${isLast ? 'stroke="#f59e0b" stroke-width="2" stroke-opacity=".4"' : ''}/>`;
    });

    // Y axis labels
    const ySteps = 3;
    let yLabels = '';
    let gridLines = '';
    for (let i = 0; i <= ySteps; i++) {
        const v = minS + (range / ySteps) * i;
        const yy = y(v);
        yLabels += `<text x="${PAD_L - 4}" y="${yy + 3}" text-anchor="end" fill="#6b7280" font-size="7" font-family="JetBrains Mono,monospace">${Math.round(v)}</text>`;
        gridLines += `<line x1="${PAD_L}" y1="${yy}" x2="${W - PAD_R}" y2="${yy}" stroke="#252a36" stroke-width=".5"/>`;
    }

    const svg = `<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
        ${gridLines}
        <line x1="${PAD_L}" y1="${avgY}" x2="${W - PAD_R}" y2="${avgY}" stroke="#f59e0b" stroke-width=".7" stroke-dasharray="3,3" opacity=".5"/>
        <path d="${areaD}" fill="url(#areaGrad)" opacity=".3"/>
        <path d="${pathD}" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        ${dots}
        ${yLabels}
        <text x="${W - PAD_R}" y="${avgY - 4}" text-anchor="end" fill="#f59e0b" font-size="6.5" font-family="JetBrains Mono,monospace" opacity=".7">avg ${avg20}</text>
        <text x="${PAD_L + gW/2}" y="${H - 2}" text-anchor="middle" fill="#6b7280" font-size="6.5" font-family="JetBrains Mono,monospace">Last ${last20.length} games</text>
        <defs><linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0" stop-color="#3b82f6" stop-opacity=".5"/><stop offset="1" stop-color="#3b82f6" stop-opacity="0"/></linearGradient></defs>
    </svg>`;

    $('#go-graph').html(svg);
}

// ============================================================
// GAME STATE
// ============================================================
let board = null, game = new Chess();
let timeLeft = 60, timerInterval = null;
let totalPoints = 0, puzzlesSolved = 0, perfectCount = 0;
let isActive = false, timerRunning = false;
let currentPuzzle = null, expectedSolutionUCI = null;
let moveStartTime = 0, moveTimerRAF = null, allMoveTimes = [];
let selectedSquare = null, waitingForMove = false;
const MAX_THINK_SECONDS = 12;

// ============================================================
// SPEED CURVE
// ============================================================
function getSpeedMultiplier(sec) {
    if (sec <= 1.5) return 1.0;
    if (sec <= 3)   return 0.85;
    if (sec <= 5)   return 0.65;
    if (sec <= 7)   return 0.45;
    if (sec <= 10)  return 0.25;
    return 0.1;
}
function getSpeedLabel(sec) {
    if (sec <= 1.5) return { text:'‚ö° Premove', color:'var(--green)' };
    if (sec <= 3)   return { text:'üèÉ Fast',    color:'var(--green)' };
    if (sec <= 5)   return { text:'üëç OK',      color:'var(--accent)' };
    if (sec <= 7)   return { text:'üêå Slow',    color:'var(--orange)' };
    if (sec <= 10)  return { text:'üßä Glacial', color:'var(--red)' };
    return             { text:'üíÄ Flagged', color:'var(--red)' };
}

// ============================================================
// MOVE TIMER BAR
// ============================================================
function startMoveTimer() {
    moveStartTime = performance.now();
    const bar = document.getElementById('move-timer-bar');
    bar.style.width = '100%';
    function tick() {
        const e = (performance.now() - moveStartTime) / 1000;
        const p = Math.max(0, 1 - e / MAX_THINK_SECONDS) * 100;
        bar.style.width = p + '%';
        bar.style.background = p > 50 ? 'var(--green)' : p > 25 ? 'var(--orange)' : 'var(--red)';
        if (p > 0 && isActive && timerRunning) moveTimerRAF = requestAnimationFrame(tick);
    }
    moveTimerRAF = requestAnimationFrame(tick);
}
function stopMoveTimer() { if (moveTimerRAF) cancelAnimationFrame(moveTimerRAF); moveTimerRAF = null; }

// ============================================================
// CLOCK
// ============================================================
function updateTimerDisplay() {
    const m = Math.floor(timeLeft/60), s = timeLeft%60;
    $('#timer').text(`${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`);
    $('#timer').toggleClass('low', timeLeft <= 10);
}
function pauseTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null; timerRunning = false;
    $('#timer').addClass('paused'); stopMoveTimer();
}
function resumeTimer() {
    if (timerRunning || timeLeft <= 0) return;
    $('#timer').removeClass('paused'); timerRunning = true;
    timerInterval = setInterval(() => {
        timeLeft--; updateTimerDisplay();
        if (timeLeft <= 0) { clearInterval(timerInterval); timerInterval = null; timerRunning = false; isActive = false; endGame(); }
    }, 1000);
    startMoveTimer();
}

// ============================================================
// SHOW BEST MOVE ON BOARD
// ============================================================
function clearBestMoveHighlights() {
    $('#board [class*="square-"]').removeClass('best-move-from best-move-to');
    $('#board .best-move-ghost').remove();
}

function showBestMoveOnBoard(fromSq, toSq, fen) {
    clearBestMoveHighlights();

    // Highlight from and to squares
    findSquareEl(fromSq).addClass('best-move-from');
    findSquareEl(toSq).addClass('best-move-to');

    // Place ghost piece on destination
    const tmpGame = new Chess(fen);
    const piece = tmpGame.get(fromSq);
    if (!piece) return;

    const colorChar = piece.color === 'w' ? 'w' : 'b';
    const pieceChar = piece.type.toUpperCase();
    const pieceCode = colorChar + pieceChar;
    const imgUrl = `https://chessboardjs.com/img/chesspieces/wikipedia/${pieceCode}.png`;

    // Get square element dimensions
    const $sq = findSquareEl(toSq);
    if ($sq.length === 0) return;

    const ghost = $(`<img class="best-move-ghost" src="${imgUrl}" alt="${pieceCode}">`);
    ghost.css({
        width: '100%',
        height: '100%',
        position: 'absolute',
        top: 0,
        left: 0
    });
    $sq.css('position', 'relative').append(ghost);
}

// ============================================================
// GAME OVER
// ============================================================
function endGame() {
    isActive = false; pauseTimer(); waitingForMove = false; clearSelection(); clearBestMoveHighlights();
    const avg = puzzlesSolved > 0 ? (totalPoints / puzzlesSolved).toFixed(1) : '0';
    const avgTime = allMoveTimes.length > 0
        ? (allMoveTimes.reduce((a,b)=>a+b,0)/allMoveTimes.length).toFixed(1)+'s' : '‚Äî';
    const avgN = puzzlesSolved > 0 ? totalPoints / puzzlesSolved : 0;
    let grade,gc,gb;
    if      (avgN>=8.5) {grade='GM Intuition';gc='#22c55e';gb='rgba(34,197,94,.12)';}
    else if (avgN>=7)   {grade='Strong Instinct';gc='#22c55e';gb='rgba(34,197,94,.08)';}
    else if (avgN>=5.5) {grade='Club Player';gc='#f59e0b';gb='rgba(245,158,11,.1)';}
    else if (avgN>=4)   {grade='Work To Do';gc='#f97316';gb='rgba(249,115,22,.1)';}
    else if (avgN>=2.5) {grade='Rough Session';gc='#ef4444';gb='rgba(239,68,68,.1)';}
    else                {grade='Bullet Blunder';gc='#ef4444';gb='rgba(239,68,68,.12)';}
    $('#go-score').text(totalPoints);$('#go-puzzles').text(puzzlesSolved);
    $('#go-avg').text(avg);$('#go-avg-time').text(avgTime);$('#go-perfect').text(perfectCount);
    $('#go-grade').text(grade).css({color:gc,background:gb,border:`1px solid ${gc}33`});

    // Render history
    renderHistoryUI(totalPoints);

    $('#game-over-overlay').addClass('show');
}

// ============================================================
// BASIC MOVE CHECK (fallback when no cloud eval)
// ============================================================
function basicMoveCheck(fen, move) {
    const g = new Chess(fen);
    const m = g.move({from:move.from,to:move.to,promotion:'q'});
    if (!m) return 3;
    if (g.in_checkmate()) return 9;
    const pieceVal = {p:1,n:3,b:3,r:5,q:9};
    let worstLoss = 0;
    for (const resp of g.moves({verbose:true})) {
        if (resp.captured) { const v=pieceVal[resp.captured]||0; if(v>worstLoss)worstLoss=v; }
    }
    const capturedVal = m.captured ? (pieceVal[m.captured]||0) : 0;
    const net = worstLoss - capturedVal;
    const isCheck = m.san.includes('+') || m.san.includes('#');
    if (isCheck) return 6;
    if (net >= 5) return 2;
    if (net >= 3) return 3;
    if (net >= 1) return 4;
    return 5;
}

// ============================================================
// SCORING
// ============================================================
async function scoreMove(userMove) {
    pauseTimer(); waitingForMove = false;
    const thinkTime = (performance.now() - moveStartTime) / 1000;
    allMoveTimes.push(thinkTime);
    const userUci = userMove.from + userMove.to;
    const fen = game.fen();
    $('#status').text('Analyzing...');

    const expFrom = expectedSolutionUCI.substring(0,2);
    const expTo = expectedSolutionUCI.substring(2,4);
    const expPromo = expectedSolutionUCI.length > 4 ? expectedSolutionUCI[4] : null;
    const tmp = new Chess(fen);
    const bestSan = tmp.move({from:expFrom,to:expTo,promotion:expPromo||'q'});
    let bestMoveText = bestSan ? bestSan.san : '';
    const isMatch = (userMove.from === expFrom && userMove.to === expTo);

    let accuracyScore = 0, accuracyText = '', accuracyColor = '';

    if (isMatch) {
        accuracyScore = 10; accuracyText = 'üéØ Best move!'; accuracyColor = 'var(--green)'; bestMoveText = '';
    } else {
        let evalDone = false;
        try {
            const ctrl = new AbortController();
            const t = setTimeout(()=>ctrl.abort(), 5000);
            const resp = await fetch(`https://lichess.org/api/cloud-eval?fen=${encodeURIComponent(fen)}&multiPv=5`,{signal:ctrl.signal});
            clearTimeout(t);
            if (!resp.ok) throw new Error('no eval');
            const data = await resp.json();
            const pvs = data.pvs || [];
            if (pvs.length === 0) throw new Error('empty');
            const bestEval = pvs[0].cp ?? (pvs[0].mate ? pvs[0].mate*10000 : 0);
            const userPv = pvs.find(p => p.moves && p.moves.startsWith(userUci));
            if (userPv) {
                const uE = userPv.cp ?? (userPv.mate ? userPv.mate*10000 : 0);
                const diff = Math.abs(bestEval - uE);
                if      (diff===0)   {accuracyScore=10;accuracyText='üéØ Engine best!';accuracyColor='var(--green)';bestMoveText='';}
                else if (diff<=15)   {accuracyScore=9; accuracyText='üéØ Excellent';accuracyColor='var(--green)';}
                else if (diff<=40)   {accuracyScore=8; accuracyText='‚úÖ Very strong';accuracyColor='var(--green)';}
                else if (diff<=70)   {accuracyScore=7; accuracyText='‚úÖ Good';accuracyColor='var(--green)';}
                else if (diff<=120)  {accuracyScore=5; accuracyText='üëç OK move';accuracyColor='var(--accent)';}
                else if (diff<=200)  {accuracyScore=4; accuracyText='‚ö° Mediocre';accuracyColor='var(--accent)';}
                else if (diff<=350)  {accuracyScore=2; accuracyText='‚ö†Ô∏è Mistake';accuracyColor='var(--orange)';}
                else                 {accuracyScore=1; accuracyText='üíÄ Blunder';accuracyColor='var(--red)';}
                evalDone = true;
            } else {
                const ag = new Chess(fen);
                ag.move({from:userMove.from,to:userMove.to,promotion:'q'});
                try {
                    const c2=new AbortController(); const t2=setTimeout(()=>c2.abort(),4000);
                    const ar = await fetch(`https://lichess.org/api/cloud-eval?fen=${encodeURIComponent(ag.fen())}&multiPv=1`,{signal:c2.signal});
                    clearTimeout(t2);
                    if (ar.ok) {
                        const ad = await ar.json();
                        const ab = ad.pvs?.[0]?.cp ?? 0;
                        const sign = game.turn()==='w' ? 1 : -1;
                        const loss = (bestEval*sign) - (-ab*sign);
                        if      (loss<=20)  {accuracyScore=7;accuracyText='‚úÖ Good alternative';accuracyColor='var(--green)';}
                        else if (loss<=60)  {accuracyScore=6;accuracyText='üëç Reasonable';accuracyColor='var(--accent)';}
                        else if (loss<=120) {accuracyScore=5;accuracyText='üëç OK';accuracyColor='var(--accent)';}
                        else if (loss<=200) {accuracyScore=3;accuracyText='‚ö†Ô∏è Inaccuracy';accuracyColor='var(--orange)';}
                        else if (loss<=350) {accuracyScore=2;accuracyText='‚ùå Mistake';accuracyColor='var(--red)';}
                        else                {accuracyScore=1;accuracyText='üíÄ Blunder';accuracyColor='var(--red)';}
                        evalDone = true;
                    }
                } catch(_){}
            }
        } catch(_){}
        if (!evalDone) {
            accuracyScore = basicMoveCheck(fen, userMove);
            if      (accuracyScore>=7) {accuracyText='‚úÖ Looks reasonable';accuracyColor='var(--green)';}
            else if (accuracyScore>=5) {accuracyText='üëç Unclear ‚Äî partial credit';accuracyColor='var(--accent)';}
            else if (accuracyScore>=3) {accuracyText='‚ö†Ô∏è Dubious';accuracyColor='var(--orange)';}
            else                       {accuracyText='‚ùå Loses material';accuracyColor='var(--red)';}
        }
    }

    const speedMult = getSpeedMultiplier(thinkTime);
    const speedInfo = getSpeedLabel(thinkTime);
    const displayScore = Math.round(accuracyScore * speedMult);
    if (displayScore >= 10) perfectCount++;
    puzzlesSolved++; totalPoints += displayScore;
    $('#points-acc').text(totalPoints);

    let pillColor = 'var(--red)';
    if (displayScore>=8) pillColor='var(--green)';
    else if (displayScore>=5) pillColor='var(--accent)';
    else if (displayScore>=3) pillColor='var(--orange)';

    $('#score-pill').text(displayScore+'/10').css('color',pillColor);
    $('#score-breakdown').addClass('show');
    $('#sb-accuracy').text(accuracyScore+'/10').css('color',accuracyColor);
    $('#sb-speed').text('√ó'+speedMult.toFixed(2)).css('color',speedInfo.color);
    $('#sb-time').text(thinkTime.toFixed(1)+'s').css('color',speedInfo.color);

    // Show best move on board if user didn't find it
    if (bestMoveText && expFrom && expTo) {
        showBestMoveOnBoard(expFrom, expTo, fen);
    }

    const themes = (currentPuzzle.Themes||[]).filter(t=>!SKIP_THEMES.has(t)).slice(0,3).join(', ');
    const rating = currentPuzzle.Rating||'';
    $('#feedback-container').addClass('show');
    $('#feedback').html(
        `<span style="color:${accuracyColor}">${accuracyText}</span> &nbsp; <span style="color:${speedInfo.color}">${speedInfo.text}</span>`+
        (bestMoveText?`<br><span style="color:var(--cyan);font-size:.75rem">Best: <strong>${bestMoveText}</strong> (shown in blue)</span>`:'')+
        (themes?`<br><span style="color:var(--text-dim);font-size:.65rem;opacity:.5">${themes}${rating?' ¬∑ '+rating:''}</span>`:'')
    );
    $('#status').text('Review');
    if (timeLeft > 0) $('#next-btn').addClass('show'); else endGame();
    ensurePuzzles();
}

// ============================================================
// LOAD NEXT PUZZLE
// ============================================================
function loadNextPuzzle() {
    if (timeLeft <= 0) { endGame(); return; }
    ensurePuzzles();
    if (puzzleQueue.length === 0) { refillFromEmbedded(); }

    currentPuzzle = puzzleQueue.shift();
    const moves = currentPuzzle.Moves.trim().split(' ');
    expectedSolutionUCI = moves[1];

    if (!game.load(currentPuzzle.FEN)) { loadNextPuzzle(); return; }
    const sF=moves[0].substring(0,2), sT=moves[0].substring(2,4);
    const sP=moves[0].length>4?moves[0][4]:undefined;
    if (!game.move({from:sF,to:sT,promotion:sP||'q'})) { loadNextPuzzle(); return; }

    clearSelection();
    clearBestMoveHighlights();
    $('#board-wrap').addClass('searching');
    $('#feedback-container').removeClass('show');
    $('#score-breakdown').removeClass('show');
    $('#next-btn').removeClass('show');
    $('#score-pill').text('‚Äî').css('color','var(--accent)');
    const bar=document.getElementById('move-timer-bar');
    bar.style.width='100%';bar.style.background='var(--green)';

    setTimeout(()=>{
        board.position(game.fen());
        board.orientation(game.turn()==='w'?'white':'black');
        $('#board-wrap').removeClass('searching');
        $('#status').text(game.turn()==='w'?'White to move':'Black to move');
        waitingForMove = true;
        const th=(currentPuzzle.Themes||[]).slice(0,3).join(' ¬∑ ');
        $('#puzzle-info').html(`<span style="opacity:.5">${th}</span><div class="db-badge">${EMBEDDED.length} puzzles ¬∑ ${puzzleQueue.length} queued</div>`);
        resumeTimer();
    }, 200);
}

// ============================================================
// TAP-TO-MOVE
// ============================================================
function findSquareEl(sq) { return $(`#board .square-${sq}`); }

function clearSelection() {
    selectedSquare = null;
    $('#board [class*="square-"]').removeClass('highlight-square highlight-dot highlight-capture');
}

function highlightLegalMoves(sq) {
    game.moves({square:sq,verbose:true}).forEach(m => {
        const $s = findSquareEl(m.to);
        if (m.captured) $s.addClass('highlight-capture'); else $s.addClass('highlight-dot');
    });
}

function isOurPiece(sq) {
    const p = game.get(sq);
    return p && ((game.turn()==='w'&&p.color==='w')||(game.turn()==='b'&&p.color==='b'));
}

async function handleSquareClick(square) {
    if (!isActive || !waitingForMove || timeLeft <= 0) return;
    if (selectedSquare === null) {
        if (isOurPiece(square)) {
            const mv = game.moves({square:square,verbose:true});
            if (mv.length > 0) {
                selectedSquare = square;
                clearSelection(); selectedSquare = square;
                findSquareEl(square).addClass('highlight-square');
                highlightLegalMoves(square);
            }
        }
    } else {
        if (square === selectedSquare) { clearSelection(); return; }
        if (isOurPiece(square)) {
            clearSelection(); selectedSquare = square;
            findSquareEl(square).addClass('highlight-square');
            highlightLegalMoves(square); return;
        }
        const move = game.move({from:selectedSquare,to:square,promotion:'q'});
        if (move === null) { clearSelection(); return; }
        game.undo(); clearSelection();
        await scoreMove(move);
        game.move({from:move.from,to:move.to,promotion:'q'});
        board.position(game.fen());
    }
}

// ============================================================
// DYNAMIC BOARD SIZING
// ============================================================
function fitBoardToViewport() {
    const vh = window.innerHeight || document.documentElement.clientHeight;
    const vw = window.innerWidth || document.documentElement.clientWidth;

    // Measure non-board elements
    const header = document.querySelector('header');
    const topBar = document.querySelector('.top-bar');
    const moveTimerWrap = document.querySelector('.move-timer-wrap');
    const panel = document.querySelector('.panel');
    const puzzleInfo = document.querySelector('.puzzle-info');

    const headerH = header ? header.offsetHeight : 30;
    const topBarH = topBar ? topBar.offsetHeight : 30;
    const moveTimerH = moveTimerWrap ? moveTimerWrap.offsetHeight : 3;
    const panelH = panel ? panel.offsetHeight : 120;
    const puzzleInfoH = puzzleInfo ? puzzleInfo.offsetHeight : 20;

    const usedHeight = headerH + topBarH + moveTimerH + panelH + puzzleInfoH + 30; // 30px breathing room
    const availableH = vh - usedHeight;
    const maxBoardW = Math.min(vw - 20, 420); // app max-width minus padding
    const boardSize = Math.max(160, Math.min(availableH, maxBoardW));

    const boardWrap = document.getElementById('board-wrap');
    if (boardWrap) {
        boardWrap.style.width = boardSize + 'px';
        boardWrap.style.maxWidth = boardSize + 'px';
        boardWrap.style.margin = '0 auto';
    }
    if (board) board.resize();
}

// ============================================================
// INIT
// ============================================================
$(document).ready(function() {
    board = Chessboard('board', {
        draggable: false, position: 'start',
        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
    });

    // Click handler
    $('#board').on('click', function(e) {
        let el = e.target, sq = null;
        while (el && el !== this) {
            if (el.className && typeof el.className === 'string') {
                const m = el.className.match(/square-([a-h][1-8])/);
                if (m) { sq = m[1]; break; }
            }
            el = el.parentElement;
        }
        if (sq) handleSquareClick(sq);
    });

    // Fit board on load and resize
    fitBoardToViewport();
    $(window).on('resize orientationchange', function() {
        fitBoardToViewport();
    });

    // Fill puzzle queue from embedded
    refillFromEmbedded();

    $('#next-btn').on('click', () => loadNextPuzzle());

    function startNewGame() {
        timeLeft=60;totalPoints=0;puzzlesSolved=0;perfectCount=0;
        allMoveTimes=[];isActive=true;timerRunning=false;waitingForMove=false;
        clearSelection(); clearBestMoveHighlights();
        $('#points-acc').text('0');$('#timer').text('01:00').removeClass('low paused');
        $('#score-pill').text('‚Äî').css('color','var(--accent)');
        $('#feedback-container').removeClass('show');$('#score-breakdown').removeClass('show');
        $('#next-btn').removeClass('show');$('#start-btn').addClass('hidden');
        $('#game-over-overlay').removeClass('show');
        ensurePuzzles();
        loadNextPuzzle();
    }
    $('#start-btn').on('click', startNewGame);
    $('#go-btn').on('click', startNewGame);

    // Refit after fonts load
    if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(() => fitBoardToViewport());
    }
    setTimeout(fitBoardToViewport, 500);
});
</script>
</body>
</html>