<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cash Terminal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <style>
        :root {
            --bg-color: #131722;
            --card-bg: #1e222d;
            --tv-green: #089981;
            --tv-red: #f23645;
            --text-main: #d1d4dc;
            --text-dim: #787b86;
            --grid-color: #2a2e39;
            --blue-accent: #2962ff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; padding: 10px; display: flex; justify-content: center; }
        
        .terminal-container { width: 100%; max-width: 800px; background: var(--card-bg); border: 1px solid var(--grid-color); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }

        .header { padding: 20px; border-bottom: 1px solid var(--grid-color); display: flex; justify-content: space-between; align-items: center; }
        .price-row { display: flex; align-items: baseline; gap: 10px; }
        .price-large { font-size: 2.2rem; font-weight: bold; color: white; font-family: monospace; }
        .change-indicator { font-size: 0.9rem; font-weight: bold; padding: 2px 6px; border-radius: 4px; }
        .pos { color: var(--tv-green); }
        .neg { color: var(--tv-red); }

        .chart-wrapper { padding: 10px; height: 350px; }

        .time-filters { display: flex; background: #2a2e39; padding: 2px; border-radius: 4px; }
        .btn-filter { background: transparent; border: none; color: var(--text-dim); padding: 6px 10px; cursor: pointer; font-size: 0.7rem; font-weight: bold; }
        .btn-filter.active { background: #363a45; color: var(--blue-accent); border-radius: 3px; }

        .controls-section { padding: 20px; border-top: 1px solid var(--grid-color); }
        .controls-grid { display: grid; grid-template-columns: 1fr auto auto; gap: 12px; }
        input { background: #2a2e39; border: 1px solid #363a45; color: white; padding: 12px; border-radius: 6px; font-size: 16px; width: 100%; outline: none; }
        button.action { padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 0.85rem; }
        .btn-buy { background: var(--tv-green); color: white; }
        .btn-sell { background: var(--tv-red); color: white; }

        .utils { padding: 10px; background: var(--bg-color); text-align: center; font-size: 0.7rem; color: var(--text-dim); border-top: 1px solid var(--grid-color); }

        @media (max-width: 600px) {
            .controls-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; align-items: flex-start; gap: 15px; }
        }
    </style>
</head>
<body>

<div class="terminal-container">
    <div class="header">
        <div>
            <div id="dbStatus" style="font-size: 0.6rem; color: var(--tv-green); margin-bottom: 4px;">‚óè SYSTEM ONLINE</div>
            <div class="price-row">
                <span id="currentBalance" class="price-large">0.00</span>
                <span id="changeValue" class="change-indicator">+0%</span>
            </div>
        </div>
        <div class="time-filters">
            <button class="btn-filter" onclick="updateView('1D')">1D</button>
            <button class="btn-filter" onclick="updateView('1W')">1W</button>
            <button class="btn-filter" onclick="updateView('1M')">1M</button>
            <button class="btn-filter active" onclick="updateView('ALL')">ALL</button>
        </div>
    </div>

    <div class="chart-wrapper">
        <canvas id="balanceChart"></canvas>
    </div>

    <div class="controls-section">
        <div class="controls-grid">
            <input type="number" id="amountInput" placeholder="Amount..." inputmode="decimal">
            <button class="action btn-buy" onclick="modifyBalance(true)">Deposit</button>
            <button class="action btn-sell" onclick="modifyBalance(false)">Withdraw</button>
        </div>
    </div>

    <div class="utils">
        <span onclick="exportData()" style="cursor:pointer">üíæ EXPORT</span> | 
        <span onclick="document.getElementById('importFile').click()" style="cursor:pointer">üìÇ IMPORT</span>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
        | <span onclick="clearEverything()" style="cursor:pointer; color: var(--tv-red)">‚úñ RESET</span>
    </div>
</div>

<script>
    const STORAGE_KEY = 'cash_terminal_final_v1';
    let rawData = [];
    let chart;
    let currentFilter = 'ALL';

    // 1. Initial Data Load
    function loadData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            rawData = JSON.parse(saved);
            document.getElementById('dbStatus').innerText = `‚óè LOADED ${rawData.length} ENTRIES`;
        } else {
            document.getElementById('dbStatus').innerText = `‚óè NEW DATABASE`;
        }
    }

    // 2. Chart Initialization
    const ctx = document.getElementById('balanceChart').getContext('2d');
    const grad = ctx.createLinearGradient(0, 0, 0, 300);
    grad.addColorStop(0, 'rgba(8, 153, 129, 0.3)');
    grad.addColorStop(1, 'rgba(8, 153, 129, 0)');

    chart = new Chart(ctx, {
        type: 'line',
        data: { datasets: [{ data: [], borderColor: '#089981', borderWidth: 2, pointRadius: 0, fill: true, backgroundColor: grad, tension: 0.1 }] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { type: 'time', grid: { color: '#2a2e39' }, ticks: { color: '#787b86', font: { size: 10 } } },
                y: { position: 'right', grid: { color: '#2a2e39' }, ticks: { color: '#787b86', font: { size: 10 } } }
            },
            plugins: { legend: { display: false } }
        }
    });

    // 3. Logic Functions
    function modifyBalance(isAdd) {
        const input = document.getElementById('amountInput');
        const val = parseFloat(input.value);
        if (isNaN(val) || val === 0) return;

        const last = rawData.length > 0 ? rawData[rawData.length - 1].y : 0;
        const entry = { x: new Date().toISOString(), y: isAdd ? last + val : last - val };
        
        rawData.push(entry);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(rawData)); // Save immediately
        
        input.value = '';
        input.blur();
        renderUI();
    }

    function renderUI() {
        if (rawData.length === 0) {
            document.getElementById('currentBalance').innerText = "0.00";
            return;
        }
        const latest = rawData[rawData.length - 1].y;
        document.getElementById('currentBalance').innerText = latest.toLocaleString(undefined, {minimumFractionDigits: 2});
        updateView(currentFilter);
    }

    function updateView(range) {
        currentFilter = range;
        let filtered = [...rawData];
        const now = moment();

        if (range === '1D') filtered = rawData.filter(d => moment(d.x).isAfter(now.clone().subtract(1, 'days')));
        else if (range === '1W') filtered = rawData.filter(d => moment(d.x).isAfter(now.clone().subtract(7, 'days')));
        else if (range === '1M') filtered = rawData.filter(d => moment(d.x).isAfter(now.clone().subtract(1, 'months')));

        const displayChange = document.getElementById('changeValue');
        if (filtered.length > 1) {
            const startPrice = filtered[0].y;
            const endPrice = filtered[filtered.length - 1].y;
            const diff = endPrice - startPrice;
            const pct = startPrice !== 0 ? ((diff / Math.abs(startPrice)) * 100).toFixed(1) : "0";
            const sign = diff >= 0 ? "+" : "";
            displayChange.innerText = `${sign}${pct}%`;
            displayChange.className = `change-indicator ${diff >= 0 ? 'pos' : 'neg'}`;
        }

        chart.data.datasets[0].data = filtered;
        chart.update();
        document.querySelectorAll('.btn-filter').forEach(btn => btn.classList.toggle('active', btn.innerText === range));
    }

    // 4. Persistence Tools
    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(rawData));
        const dl = document.createElement('a');
        dl.setAttribute("href", dataStr);
        dl.setAttribute("download", `vault_backup_${new Date().toISOString().slice(0,10)}.json`);
        dl.click();
    }

    function importData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => { 
            rawData = JSON.parse(ev.target.result); 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(rawData));
            location.reload(); // Refresh to ensure everything updates
        };
        reader.readAsText(e.target.files[0]);
    }

    function clearEverything() {
        if (confirm("Erase all data?")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    // Run on Start
    loadData();
    renderUI();
</script>
</body>
</html>

