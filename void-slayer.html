<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VOID-SLAYER | Cloud MMORPG</title>
    <style>
        :root { --bg: #050508; --panel: #111116; --accent: #8b0000; --gold: #d4af37; --text: #aaa; --admin: #ff00ff; }
        * { box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Crimson Text', serif; margin: 0; display: flex; height: 100vh; height: 100dvh; overflow: hidden; }
        nav { width: 220px; min-width: 220px; background: var(--panel); border-right: 1px solid #222; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .nav-link { color: #666; padding: 12px 10px; border-bottom: 1px solid #1a1a1a; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        .nav-link:hover { color: #fff; background: #1a1a1f; padding-left: 15px; }
        main { flex: 1; display: flex; flex-direction: column; min-width: 0; min-height: 0; overflow: hidden; }
        #stats-bar { background: #000; padding: 10px 20px; border-bottom: 1px solid #222; display: flex; gap: 20px; font-family: monospace; font-size: 0.85rem; align-items: center; flex-wrap: wrap; }
        .stat-val { color: var(--gold); font-weight: bold; }
        .content { flex: 1; padding: 20px; overflow-y: auto; -webkit-overflow-scrolling: touch; background: radial-gradient(circle at top, #16161d 0%, #050508 100%); }
        .card { background: rgba(20, 20, 25, 0.98); border: 1px solid #333; padding: 20px; margin-bottom: 15px; }
        .action-btn { background: #222; border: 1px solid #444; color: #ccc; padding: 10px 20px; cursor: pointer; text-transform: uppercase; margin: 4px; font-family: inherit; font-size: 0.85rem; }
        .action-btn:hover { background: var(--accent); color: white; border-color: red; }
        #game-log { height: 160px; overflow-y: auto; border-top: 1px solid #222; padding-top: 10px; font-size: 0.85rem; color: #888; margin-top: 20px; }
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px; overflow-y: auto; }
        input, select { background: #111; border: 1px solid #333; color: white; padding: 12px; margin-bottom: 12px; width: 260px; box-sizing: border-box; }
        .hidden { display: none !important; }
        .debug { font-size: 0.75rem; color: #555; margin-top: 10px; font-family: monospace; }

        /* Auth form styles */
        .auth-card { background: rgba(20, 20, 25, 0.98); border: 1px solid #333; padding: 30px 40px; display: flex; flex-direction: column; align-items: center; max-width: 400px; width: 100%; }
        .auth-tabs { display: flex; gap: 0; margin-bottom: 20px; width: 100%; }
        .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; background: #111; border: 1px solid #333; color: #666; text-transform: uppercase; font-family: inherit; letter-spacing: 2px; font-size: 0.85rem; transition: 0.2s; }
        .auth-tab.active { background: var(--accent); color: white; border-color: var(--accent); }
        .auth-tab:hover:not(.active) { color: #fff; background: #1a1a1f; }
        .auth-error { color: #ff4444; font-size: 0.85rem; margin-bottom: 10px; min-height: 1.2em; text-align: center; }
        .auth-success { color: #44ff44; font-size: 0.85rem; margin-bottom: 10px; min-height: 1.2em; text-align: center; }
        .auth-field { width: 100%; }
        .auth-field label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; }
        .auth-field input, .auth-field select { width: 100%; }
        .auth-divider { width: 100%; border-top: 1px solid #222; margin: 15px 0; position: relative; }
        .auth-divider span { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: rgba(20, 20, 25, 0.98); padding: 0 10px; color: #555; font-size: 0.8rem; }
        .realm-info { font-size: 0.75rem; color: #555; text-align: center; margin-top: -5px; margin-bottom: 10px; }
        .name-link { color: inherit; cursor: pointer; text-decoration: none; border-bottom: 1px dotted #555; transition: 0.15s; }
        .name-link:hover { color: var(--gold); border-bottom-color: var(--gold); }

        /* Avatar selector */
        .avatar-option { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; border: 2px solid #333; cursor: pointer; transition: 0.2s; background: #111; }
        .avatar-option:hover { border-color: var(--gold); background: #1a1a1f; transform: scale(1.1); }
        .avatar-option.selected { border-color: var(--accent); background: rgba(139, 0, 0, 0.2); box-shadow: 0 0 10px rgba(139, 0, 0, 0.5); }

        /* Mobile hamburger */
        #mobile-header { display: none; background: var(--panel); padding: 10px 15px; border-bottom: 1px solid #222; align-items: center; justify-content: space-between; z-index: 50; }
        #menu-toggle { background: none; border: 1px solid #444; color: #ccc; font-size: 1.3rem; padding: 6px 12px; cursor: pointer; font-family: inherit; }
        #nav-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 98; }

        /* Mobile responsive */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #mobile-header { display: flex; }
            nav { position: fixed; top: 0; left: -280px; width: 260px; min-width: 260px; height: 100%; z-index: 99; transition: left 0.3s ease; padding-top: 15px; }
            nav.open { left: 0; }
            #nav-overlay.open { display: block; }
            main { flex: 1; min-height: 0; overflow: hidden; }
            #stats-bar { padding: 8px 12px; gap: 10px; font-size: 0.75rem; }
            .content { padding: 12px; padding-bottom: 80px; }
            .card { padding: 15px; }
            .action-btn { padding: 10px 16px; font-size: 0.8rem; }
            #auth-screen { padding: 15px; }
            .auth-card { padding: 20px 15px; }
            input, select { width: 100%; }
            #chat-in { width: 65% !important; }
        }
    </style>
</head>
<body>

<div id="auth-screen">
    <h1 style="color:var(--accent); letter-spacing: 5px; margin-bottom: 5px;">VOID-SLAYER</h1>
    <p style="color: #555; margin-top: 0; margin-bottom: 25px; font-size: 0.9rem;">Cloud MMORPG</p>

    <div class="auth-card">
        <div class="auth-tabs">
            <div class="auth-tab active" id="tab-login-btn" onclick="switchAuthTab('login')">Login</div>
            <div class="auth-tab" id="tab-register-btn" onclick="switchAuthTab('register')">Register</div>
        </div>

        <div id="auth-error" class="auth-error"></div>
        <div id="auth-success" class="auth-success"></div>

        <!-- Login Form -->
        <div id="auth-login">
            <div class="auth-field">
                <label>Username</label>
                <input type="text" id="login-username" placeholder="Enter username" onkeypress="if(event.key==='Enter')doLogin()">
            </div>
            <div class="auth-field">
                <label>Password</label>
                <input type="password" id="login-password" placeholder="Enter password" onkeypress="if(event.key==='Enter')doLogin()">
            </div>
            <button class="action-btn" style="width:100%; margin: 10px 0 0 0;" onclick="doLogin()">Enter the Void</button>
        </div>

        <!-- Register Form -->
        <div id="auth-register" class="hidden">
            <div class="auth-field">
                <label>Username</label>
                <input type="text" id="reg-username" placeholder="Choose a username" onkeypress="if(event.key==='Enter')doRegister()">
            </div>
            <div class="auth-field">
                <label>Password</label>
                <input type="password" id="reg-password" placeholder="Choose a password" onkeypress="if(event.key==='Enter')doRegister()">
            </div>
            <div class="auth-field">
                <label>Confirm Password</label>
                <input type="password" id="reg-password2" placeholder="Confirm password" onkeypress="if(event.key==='Enter')doRegister()">
            </div>
            <div class="auth-field">
                <label>Race</label>
                <select id="race-sel" style="width:100%;">
                    <option value="Hollow">Hollow (+Str)</option>
                    <option value="Wraith">Wraith (+Wis)</option>
                </select>
            </div>
            <button class="action-btn" style="width:100%; margin: 10px 0 0 0;" onclick="doRegister()">Create Character</button>
        </div>

        <div class="auth-divider"><span>REALM</span></div>

        <div class="auth-field">
            <input type="text" id="realm-name" value="void-realm-default" placeholder="Realm name" style="text-align:center; font-family: monospace; color: var(--gold); border-color: #444;">
        </div>
        <div class="realm-info">All players in the same realm share the same cloud database.</div>

        <div class="debug" id="connection-status">Initializing...</div>
        <div class="debug" id="auth-debug" style="margin-top: 8px; max-height: 80px; overflow-y: auto;"></div>
        <div style="margin-top: 10px;">
            <span class="debug" style="cursor:pointer; color:#664444; border-bottom:1px dotted #664444;" onclick="if(confirm('Clear all local data for this realm? You will need to register again.')){const r=document.getElementById('realm-name').value.trim()||'void-realm-default';localStorage.removeItem('void-accounts-'+r);localStorage.removeItem('void-gamestate-'+r);document.getElementById('auth-debug').innerText='Local data cleared.';document.getElementById('auth-error').innerText='';}">Clear local data</span>
        </div>
    </div>
</div>

<div id="nav-overlay" onclick="closeMenu()"></div>

<nav id="main-nav">
    <h2 style="color:var(--accent)">VOID MENU</h2>
    <div class="nav-link" onclick="goTab('grind')">The Frontier</div>
    <div id="nav-dungeon" class="nav-link" onclick="goTab('dungeon')">The Void Gate</div>
    <div class="nav-link" onclick="goTab('lead'); loadLeaderboard();">Leaderboard</div>
    <div class="nav-link" onclick="goTab('shop'); refreshShop();">Black Market</div>
    <div class="nav-link" onclick="goTab('pvp'); refreshPvpTargets();">The Arena</div>
    <div class="nav-link" onclick="goTab('guild'); refreshGuildUI();">Guild Hall</div>
    <div class="nav-link" onclick="goTab('wars'); refreshWarsUI();">Guild Wars</div>
    <div class="nav-link" onclick="goTab('chat')">Tavern</div>
    <div class="nav-link" onclick="goTab('profile')">Profile</div>
    <div class="nav-link" onclick="goTab('news'); refreshNews();">News</div>
    <div id="nav-backup" class="nav-link hidden" onclick="goTab('backup'); refreshBackupInfo();" style="color:var(--admin);">üîí Backup</div>
    <div class="debug" style="margin-top: auto; padding-top: 20px;">
        <span id="player-count">0</span> players online<br>
        <span id="cloud-status" style="color: #888;">Cloud: Idle</span>
    </div>
</nav>

<div id="mobile-header">
    <button id="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
    <span style="color:var(--accent); font-weight:bold; letter-spacing:2px;">VOID-SLAYER</span>
</div>

<main>
    <div id="stats-bar">
        <span>Lv <span class="stat-val" id="stat-level">1</span></span>
        <span>XP <span class="stat-val" id="stat-xp">0</span>/<span id="stat-xp-next">100</span></span>
        <span>HP <span class="stat-val" id="stat-hp">100</span></span>
        <span>STR <span class="stat-val" id="stat-str">10</span></span>
        <span>WIS <span class="stat-val" id="stat-wis">10</span></span>
        <span style="color:var(--gold)">‚öú <span class="stat-val" id="stat-gold">0</span></span>
        <span id="stat-guild"></span>
    </div>

    <div class="content">
        <!-- FRONTIER TAB -->
        <div id="tab-grind">
            <div class="card">
                <h2>The Frontier</h2>
                <p>The dark frontier sprawls before you, teeming with shadowy foes. Your blade thirsts for blood.</p>
                <button class="action-btn" onclick="doGrind()">Slay Minions</button>
                <button class="action-btn" onclick="doRest()" style="background:#1a3a1a; border-color:#2a5a2a;">üõå Rest (Restore 50 HP)</button>
            </div>
            <div id="game-log"></div>
        </div>

        <!-- VOID GATE TAB -->
        <div id="tab-dungeon" class="hidden">
            <div class="card">
                <h2>The Void Gate</h2>
                <p id="gate-desc">The massive obsidian gate looms before you.</p>
                <div id="gate-status"></div>
                <div id="gate-actions"></div>
            </div>
        </div>

        <!-- LEADERBOARD TAB -->
        <div id="tab-lead" class="hidden">
            <div class="card">
                <h2>Leaderboard</h2>
                <div id="leaderboard-list" style="font-family:monospace; font-size:0.9rem;"></div>
            </div>
        </div>

        <!-- SHOP TAB -->
        <div id="tab-shop" class="hidden">
            <div class="card">
                <h2>Black Market</h2>
                <p>A hooded merchant whispers prices. Gold buys power.</p>
                <div id="shop-items"></div>
            </div>
        </div>

        <!-- PVP TAB -->
        <div id="tab-pvp" class="hidden">
            <div class="card">
                <h2>The Arena</h2>
                <p>Challenge other slayers to mortal combat.</p>
                <div id="pvp-targets"></div>
            </div>
        </div>

        <!-- GUILD TAB -->
        <div id="tab-guild" class="hidden">
            <div class="card">
                <h2>Guild Hall</h2>
                <div id="guild-content"></div>
            </div>
        </div>

        <!-- WARS TAB -->
        <div id="tab-wars" class="hidden">
            <div class="card">
                <h2>‚öîÔ∏è Guild Wars</h2>
                <p style="color:#888;">Guilds battle for supremacy. First to 20,000 frontier kills wins!</p>
                
                <div id="active-wars-section" style="margin-top:20px;">
                    <h3 style="color:var(--accent);">Active Wars</h3>
                    <div id="active-wars-list"></div>
                </div>
                
                <div id="war-history-section" style="margin-top:30px;">
                    <h3 style="color:#888;">War History</h3>
                    <div id="war-history-list"></div>
                </div>
            </div>
        </div>

        <!-- CHAT TAB -->
        <div id="tab-chat" class="hidden">
            <div class="card">
                <h2>The Tavern</h2>
                <div id="chat-log" style="height:300px; overflow-y:auto; border:1px solid #333; padding:10px; margin-bottom:10px; font-size:0.9rem;"></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="chat-in" placeholder="Speak..." style="flex:1; width:auto;" onkeypress="if(event.key==='Enter')sendChatMsg()">
                    <button class="action-btn" onclick="sendChatMsg()">Send</button>
                </div>
            </div>
        </div>

        <!-- PROFILE TAB -->
        <div id="tab-profile" class="hidden">
            <div class="card">
                <h2>Profile Settings</h2>
                <p style="color:#888;">Customize your character profile.</p>
                
                <div style="margin:20px 0;">
                    <label style="display:block; color:#888; font-size:0.85rem; margin-bottom:5px;">Display Name</label>
                    <input type="text" id="profile-displayname" placeholder="Your display name" style="width:300px; max-width:100%;">
                    <p style="color:#666; font-size:0.8rem; margin-top:5px;">This is how other players will see you.</p>
                </div>
                
                <div style="margin:20px 0;">
                    <label style="display:block; color:#888; font-size:0.85rem; margin-bottom:8px;">Avatar</label>
                    <div id="avatar-selector" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <div class="avatar-option" data-avatar="‚öîÔ∏è" onclick="selectAvatar('‚öîÔ∏è')">‚öîÔ∏è</div>
                        <div class="avatar-option" data-avatar="üó°Ô∏è" onclick="selectAvatar('üó°Ô∏è')">üó°Ô∏è</div>
                        <div class="avatar-option" data-avatar="üõ°Ô∏è" onclick="selectAvatar('üõ°Ô∏è')">üõ°Ô∏è</div>
                        <div class="avatar-option" data-avatar="üë§" onclick="selectAvatar('üë§')">üë§</div>
                        <div class="avatar-option" data-avatar="ü¶á" onclick="selectAvatar('ü¶á')">ü¶á</div>
                        <div class="avatar-option" data-avatar="üíÄ" onclick="selectAvatar('üíÄ')">üíÄ</div>
                        <div class="avatar-option" data-avatar="üëª" onclick="selectAvatar('üëª')">üëª</div>
                        <div class="avatar-option" data-avatar="üåô" onclick="selectAvatar('üåô')">üåô</div>
                        <div class="avatar-option" data-avatar="‚≠ê" onclick="selectAvatar('‚≠ê')">‚≠ê</div>
                        <div class="avatar-option" data-avatar="üî•" onclick="selectAvatar('üî•')">üî•</div>
                        <div class="avatar-option" data-avatar="‚ùÑÔ∏è" onclick="selectAvatar('‚ùÑÔ∏è')">‚ùÑÔ∏è</div>
                        <div class="avatar-option" data-avatar="‚ö°" onclick="selectAvatar('‚ö°')">‚ö°</div>
                        <div class="avatar-option" data-avatar="üêâ" onclick="selectAvatar('üêâ')">üêâ</div>
                        <div class="avatar-option" data-avatar="ü¶Ö" onclick="selectAvatar('ü¶Ö')">ü¶Ö</div>
                        <div class="avatar-option" data-avatar="üê∫" onclick="selectAvatar('üê∫')">üê∫</div>
                        <div class="avatar-option" data-avatar="ü¶Å" onclick="selectAvatar('ü¶Å')">ü¶Å</div>
                    </div>
                    <input type="hidden" id="profile-avatar" value="‚öîÔ∏è">
                </div>
                
                <div style="margin:20px 0;">
                    <label style="display:block; color:#888; font-size:0.85rem; margin-bottom:5px;">Bio</label>
                    <textarea id="profile-bio" placeholder="Tell others about yourself..." style="width:100%; max-width:500px; height:80px; background:#111; border:1px solid #333; color:white; padding:10px; font-family:inherit; resize:vertical;"></textarea>
                    <p style="color:#666; font-size:0.8rem; margin-top:5px;">Maximum 200 characters.</p>
                </div>
                
                <button class="action-btn" onclick="saveProfile()">Save Changes</button>
                
                <div id="profile-status" style="margin-top:15px; font-size:0.9rem; color:#888;"></div>
            </div>
        </div>

        <!-- NEWS TAB -->
        <div id="tab-news" class="hidden">
            <div class="card">
                <h2>Realm News</h2>
                
                <div id="admin-news-post" class="hidden" style="margin-bottom:20px; padding:15px; background:#0a0a0a; border:1px solid #444;">
                    <h3 style="color:var(--admin); margin-top:0;">‚úç Post News (Admin)</h3>
                    <textarea id="news-input" placeholder="Type your news announcement..." style="width:100%; height:80px; background:#111; border:1px solid #333; color:white; padding:10px; font-family:inherit; resize:vertical;"></textarea>
                    <button class="action-btn" onclick="postNews()" style="margin-top:10px; background:var(--admin); border-color:var(--admin);">üì¢ Post News</button>
                </div>
                
                <div id="news-list"></div>
            </div>
        </div>

        <!-- BACKUP TAB (Admin Only) -->
        <div id="tab-backup" class="hidden">
            <div class="card">
                <h2 style="color:var(--admin)">üîí Admin Backup Panel</h2>
                <p style="color:#888;">Download or restore the entire realm state.</p>
                
                <div id="backup-info" style="margin:15px 0; padding:15px; background:#0a0a0a; border:1px solid #222; font-family:monospace; font-size:0.85rem;"></div>
                
                <button class="action-btn" onclick="downloadBackup()" style="background:var(--admin); border-color:var(--admin);">‚¨á Download Backup</button>
                <label class="action-btn" style="display:inline-block; cursor:pointer;">
                    ‚¨Ü Upload Backup
                    <input type="file" accept=".json" onchange="uploadBackup(event)" style="display:none;">
                </label>
                
                <div id="backup-status" style="margin-top:15px; font-size:0.9rem; color:#888;"></div>
            </div>
        </div>
    </div>
</main>

<script>
    // ============================================
    // CLOUD SYNC CONFIGURATION
    // ============================================
    const CLOUD_CONFIG = {
        webAppUrl: 'https://script.google.com/macros/s/AKfycbyJEZzZiIf3QyawNA-mR_lUHknsWok_2-FLp68odIYxKSiDMGT_F0JcZwJqnGDEMYI/exec',
        sheetId: '1EblrSWCeDCgOVLB3wJ9rkQ56-SdThchkcpaa3bR4Bas',
        heartbeatInterval: 60000, // 60 seconds
        autoSaveDelay: 3000 // 3 seconds after marking dirty
    };

    let cloudSyncTimer = null;
    let isDirty = false;
    let lastSyncTime = 0;
    let autoSaveTimer = null;

    // ============================================
    // GAME STATE & CONSTANTS
    // ============================================
    const ADMIN = 'boyo1991';
    let currentUser = null;
    let currentTab = 'grind';
    let p = {}; // Current player
    
    const gameState = {
        players: {},
        guilds: {},
        wars: [],
        news: [],
        gate: 'CLOSED',
        chat: []
    };

    const seenChatIds = new Set();

    // ============================================
    // CLOUD SYNC FUNCTIONS
    // ============================================
    
    function updateCloudStatus(message, color = '#888') {
        const statusEl = document.getElementById('cloud-status');
        if (statusEl) {
            statusEl.textContent = 'Cloud: ' + message;
            statusEl.style.color = color;
        }
    }

    // ============================================
    // LOCAL STORAGE (Primary ‚Äî always works)
    // ============================================
    let cloudAvailable = false; // set true after first successful cloud request

    function getAccounts() {
        const realm = document.getElementById('realm-name')?.value.trim() || 'void-realm-default';
        const key = `void-accounts-${realm}`;
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : {};
    }

    function saveAccounts(accounts) {
        const realm = document.getElementById('realm-name')?.value.trim() || 'void-realm-default';
        const key = `void-accounts-${realm}`;
        localStorage.setItem(key, JSON.stringify(accounts));
    }

    function getLocalGameState() {
        const realm = document.getElementById('realm-name')?.value.trim() || 'void-realm-default';
        const key = `void-gamestate-${realm}`;
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : null;
    }

    function saveLocalGameState() {
        const realm = document.getElementById('realm-name')?.value.trim() || 'void-realm-default';
        const key = `void-gamestate-${realm}`;
        localStorage.setItem(key, JSON.stringify({
            players: gameState.players,
            guilds: gameState.guilds,
            wars: gameState.wars,
            news: gameState.news,
            gate: gameState.gate,
            chat: gameState.chat
        }));
    }

    function loadLocalGameState() {
        const gs = getLocalGameState();
        if (gs) {
            if (gs.players) gameState.players = gs.players;
            if (gs.guilds) gameState.guilds = gs.guilds;
            if (gs.wars) gameState.wars = gs.wars;
            if (gs.news) gameState.news = gs.news;
            if (gs.gate) gameState.gate = gs.gate;
            if (gs.chat) {
                gameState.chat = gs.chat;
                gs.chat.forEach(msg => seenChatIds.add(msg.id));
            }
            return true;
        }
        return false;
    }

    function saveGameState() {
        markDirty();
    }

    // ============================================
    // CLOUD SYNC (Enhancement ‚Äî fails gracefully)
    // ============================================

    function fetchWithTimeout(url, options = {}, timeoutMs = 10000) {
        return Promise.race([
            fetch(url, options),
            new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Request timed out')), timeoutMs)
            )
        ]);
    }

    function authDebug(msg) {
        const el = document.getElementById('auth-debug');
        if (el) {
            el.innerHTML += msg + '<br>';
            el.scrollTop = el.scrollHeight;
        }
        console.log('[auth]', msg);
    }

    async function loadFromCloud() {
        try {
            updateCloudStatus('Loading...', '#ffaa00');
            authDebug('Attempting cloud load...');
            const realm = document.getElementById('realm-name').value.trim() || 'void-realm-default';
            
            const response = await fetchWithTimeout(
                `${CLOUD_CONFIG.webAppUrl}?realm=${encodeURIComponent(realm)}&action=load`,
                { redirect: 'follow' },
                12000
            );
            
            authDebug('Response status: ' + response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const text = await response.text();
            authDebug('Response length: ' + text.length + ' chars');
            if (!text || text.trim().charAt(0) !== '{') {
                authDebug('Bad response: ' + text.substring(0, 100));
                throw new Error('Invalid response from server');
            }
            const data = JSON.parse(text);
            
            if (data.success && data.data) {
                if (data.data.accounts) {
                    saveAccounts(data.data.accounts);
                }
                
                if (data.data.gameState) {
                    const gs = data.data.gameState;
                    if (gs.players) gameState.players = gs.players;
                    if (gs.guilds) gameState.guilds = gs.guilds;
                    if (gs.wars) gameState.wars = gs.wars;
                    if (gs.news) gameState.news = gs.news;
                    if (gs.gate) gameState.gate = gs.gate;
                    if (gs.chat) {
                        gameState.chat = gs.chat;
                        gs.chat.forEach(msg => seenChatIds.add(msg.id));
                    }
                }
                
                // Cloud loaded successfully ‚Äî also save to localStorage as cache
                saveLocalGameState();
                cloudAvailable = true;
                updateCloudStatus('Connected', '#44ff44');
                authDebug('<span style="color:#44ff44">Cloud loaded OK</span>');
                addLog("<span style='color:#44ff44'>‚úì Loaded from cloud</span>");
                return true;
            } else {
                cloudAvailable = true;
                authDebug('Cloud connected but empty (no data yet)');
                updateCloudStatus('Connected (empty)', '#ffaa00');
                return true;
            }
        } catch (err) {
            console.warn('Cloud sync unavailable:', err.message);
            authDebug('<span style="color:#ff8844">Cloud error: ' + err.message + '</span>');
            cloudAvailable = false;
            updateCloudStatus('Local mode', '#ffaa00');
            
            // Fall back to localStorage
            if (loadLocalGameState()) {
                addLog("<span style='color:#ffaa00'>Playing in local mode ‚Äî progress saved to this browser</span>");
            } else {
                addLog("<span style='color:#ffaa00'>Playing in local mode ‚Äî new game started</span>");
            }

            return false;
        }
    }

    async function saveToCloud(force = false) {
        // Always save to localStorage first
        saveLocalGameState();

        if (!force && !isDirty) {
            if (cloudAvailable) updateCloudStatus('Idle', '#888');
            return true;
        }
        
        // If cloud isn't available, just save locally
        if (!cloudAvailable) {
            isDirty = false;
            return true;
        }

        try {
            updateCloudStatus('Saving...', '#ffaa00');
            const realm = document.getElementById('realm-name').value.trim() || 'void-realm-default';
            
            const payload = {
                realm: realm,
                accounts: getAccounts(),
                gameState: {
                    players: gameState.players,
                    guilds: gameState.guilds,
                    wars: gameState.wars,
                    news: gameState.news,
                    gate: gameState.gate,
                    chat: gameState.chat
                },
                timestamp: Date.now()
            };
            
            const response = await fetchWithTimeout(CLOUD_CONFIG.webAppUrl, {
                method: 'POST',
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(payload)
            }, 12000);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const text = await response.text();
            const result = JSON.parse(text);
            
            if (result.success) {
                isDirty = false;
                lastSyncTime = Date.now();
                updateCloudStatus('Synced', '#44ff44');
                
                setTimeout(() => {
                    if (!isDirty) {
                        updateCloudStatus('Idle', '#888');
                    }
                }, 2000);
                
                return true;
            } else {
                throw new Error(result.error || 'Save failed');
            }
        } catch (err) {
            console.warn('Cloud save unavailable:', err.message);
            cloudAvailable = false;
            updateCloudStatus('Local mode', '#ffaa00');
            isDirty = false; // Already saved locally
            return false;
        }
    }

    function markDirty() {
        isDirty = true;
        
        // Always save to localStorage immediately
        saveLocalGameState();
        
        // Clear existing cloud save timer
        if (autoSaveTimer) {
            clearTimeout(autoSaveTimer);
        }
        
        // Attempt cloud save after delay
        autoSaveTimer = setTimeout(() => {
            saveToCloud();
        }, CLOUD_CONFIG.autoSaveDelay);
    }

    function startCloudSync() {
        if (cloudSyncTimer) {
            clearInterval(cloudSyncTimer);
        }
        
        cloudSyncTimer = setInterval(() => {
            saveToCloud();
        }, CLOUD_CONFIG.heartbeatInterval);
        
        const mode = cloudAvailable ? 'Cloud sync' : 'Local autosave';
        addLog(`<span style='color:#44ff44'>${mode} started</span>`);
    }

    function stopCloudSync() {
        if (cloudSyncTimer) {
            clearInterval(cloudSyncTimer);
            cloudSyncTimer = null;
        }
        if (autoSaveTimer) {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = null;
        }
    }

    // ============================================
    // AUTH FUNCTIONS
    // ============================================
    function switchAuthTab(tab) {
        document.getElementById('auth-login').classList.toggle('hidden', tab !== 'login');
        document.getElementById('auth-register').classList.toggle('hidden', tab !== 'register');
        document.getElementById('tab-login-btn').classList.toggle('active', tab === 'login');
        document.getElementById('tab-register-btn').classList.toggle('active', tab === 'register');
        document.getElementById('auth-error').innerText = '';
        document.getElementById('auth-success').innerText = '';
    }

    async function doLogin() {
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;
        const errorDiv = document.getElementById('auth-error');
        const loginBtn = document.querySelector('#auth-login .action-btn');
        
        errorDiv.innerText = '';
        
        if (!username || !password) {
            errorDiv.innerText = 'Enter username and password.';
            return;
        }
        
        // Show loading state
        const origText = loginBtn.textContent;
        loginBtn.textContent = 'Connecting...';
        loginBtn.disabled = true;

        try {
            // Load from cloud first
            await loadFromCloud();
        
            const accounts = getAccounts();
            const accountNames = Object.keys(accounts);
            authDebug('Local accounts found: ' + (accountNames.length ? accountNames.join(', ') : 'none'));
        
            if (!accounts[username]) {
                errorDiv.innerText = 'Account not found. Register first or clear local data and re-register.';
                authDebug('<span style="color:#ff4444">Account "' + username + '" not found</span>');
                return;
            }
        
            if (accounts[username].password !== password) {
                errorDiv.innerText = 'Incorrect password.';
                authDebug('<span style="color:#ff4444">Wrong password for "' + username + '"</span>');
                return;
            }
        
            authDebug('Password OK, logging in as ' + username);
            currentUser = username;
        
            if (!gameState.players[username]) {
                authDebug('Creating new player data...');
                gameState.players[username] = {
                    race: accounts[username].race,
                    level: 1,
                    xp: 0,
                    hp: 100,
                    maxHp: 100,
                    str: accounts[username].race === 'Hollow' ? 11 : 10,
                    wis: accounts[username].race === 'Wraith' ? 11 : 10,
                    gold: 0,
                    guild: null,
                    kills: 0,
                    deaths: 0,
                    online: true,
                    lastSeen: Date.now()
                };
                markDirty();
            } else {
                authDebug('Existing player found, updating online status...');
                gameState.players[username].online = true;
                gameState.players[username].lastSeen = Date.now();
                markDirty();
            }
        
            p = gameState.players[username];
            authDebug('Player loaded: Lv' + p.level + ', ' + p.gold + 'g');
        
            document.getElementById('auth-screen').classList.add('hidden');
            authDebug('Auth screen hidden, refreshing UI...');
            refreshUI();
            startCloudSync();
            updatePlayerCount();
        
            if (username === ADMIN) {
                document.getElementById('nav-backup').classList.remove('hidden');
            }
        
            addLog(`<span style="color:var(--gold)">Welcome, ${username}.</span>`);
            sendSystemChat(`‚öî ${username} has entered the Void.`);
            authDebug('Login complete!');
        } catch (err) {
            console.warn('Login error:', err);
            authDebug('<span style="color:#ff4444">LOGIN ERROR: ' + err.message + '</span>');
            errorDiv.innerText = 'Login error: ' + err.message;
        } finally {
            loginBtn.textContent = origText;
            loginBtn.disabled = false;
        }
    }

    async function doRegister() {
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value;
        const password2 = document.getElementById('reg-password2').value;
        const race = document.getElementById('race-sel').value;
        const errorDiv = document.getElementById('auth-error');
        const successDiv = document.getElementById('auth-success');
        const regBtn = document.querySelector('#auth-register .action-btn');
        
        errorDiv.innerText = '';
        successDiv.innerText = '';
        
        if (!username || !password) {
            errorDiv.innerText = 'Enter a username and password.';
            return;
        }
        
        if (username.length < 3) {
            errorDiv.innerText = 'Username must be at least 3 characters.';
            return;
        }
        
        if (password.length < 4) {
            errorDiv.innerText = 'Password must be at least 4 characters.';
            return;
        }
        
        if (password !== password2) {
            errorDiv.innerText = 'Passwords do not match.';
            return;
        }

        const origText = regBtn.textContent;
        regBtn.textContent = 'Creating...';
        regBtn.disabled = true;
        
        try {
            // Load from cloud first
            await loadFromCloud();
            
            const accounts = getAccounts();
            
            if (accounts[username]) {
                errorDiv.innerText = 'Username already taken.';
                return;
            }
            
            accounts[username] = { password, race };
            saveAccounts(accounts);
            markDirty();
            
            successDiv.innerText = '‚úì Account created! You may now login.';
            
            setTimeout(() => {
                switchAuthTab('login');
                document.getElementById('login-username').value = username;
                document.getElementById('login-password').focus();
            }, 1500);
        } catch (err) {
            console.warn('Register error:', err);
            errorDiv.innerText = 'Registration error: ' + err.message;
        } finally {
            regBtn.textContent = origText;
            regBtn.disabled = false;
        }
    }

    // ============================================
    // UI FUNCTIONS
    // ============================================
    function refreshUI() {
        document.getElementById('stat-level').innerText = p.level;
        document.getElementById('stat-xp').innerText = p.xp;
        document.getElementById('stat-xp-next').innerText = p.level * 100;
        document.getElementById('stat-hp').innerText = p.hp;
        document.getElementById('stat-str').innerText = p.str;
        document.getElementById('stat-wis').innerText = p.wis;
        document.getElementById('stat-gold').innerText = p.gold;
        
        const guildSpan = document.getElementById('stat-guild');
        if (p.guild) {
            const guild = gameState.guilds[p.guild];
            guildSpan.innerHTML = `<span style="color:#4af">„Äê${guild ? guild.tag : p.guild}„Äë</span>`;
        } else {
            guildSpan.innerHTML = '';
        }
    }

    function addLog(html) {
        const log = document.getElementById('game-log');
        if (!log) return;
        const entry = document.createElement('div');
        entry.innerHTML = `<span style="color:#555">[${new Date().toLocaleTimeString()}]</span> ${html}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    }

    function goTab(tabName) {
        currentTab = tabName;
        document.querySelectorAll('.content > div').forEach(el => el.classList.add('hidden'));
        const target = document.getElementById('tab-' + tabName);
        if (target) target.classList.remove('hidden');
        
        // Load profile data when opening profile tab
        if (tabName === 'profile' && p) {
            const displayNameInput = document.getElementById('profile-displayname');
            const avatarInput = document.getElementById('profile-avatar');
            const bioInput = document.getElementById('profile-bio');
            
            if (displayNameInput) {
                displayNameInput.value = p.displayName || '';
            }
            
            if (avatarInput) {
                const currentAvatar = p.avatar || '‚öîÔ∏è';
                avatarInput.value = currentAvatar;
                
                // Update visual selection
                document.querySelectorAll('.avatar-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                const selectedOpt = document.querySelector(`.avatar-option[data-avatar="${currentAvatar}"]`);
                if (selectedOpt) {
                    selectedOpt.classList.add('selected');
                }
            }
            
            if (bioInput) {
                bioInput.value = p.bio || '';
            }
        }
        
        closeMenu();
    }

    function toggleMenu() {
        document.getElementById('main-nav').classList.toggle('open');
        document.getElementById('nav-overlay').classList.toggle('open');
    }

    function closeMenu() {
        document.getElementById('main-nav').classList.remove('open');
        document.getElementById('nav-overlay').classList.remove('open');
    }

    function updatePlayerCount() {
        const online = Object.values(gameState.players).filter(pl => {
            const age = Date.now() - (pl.lastSeen || 0);
            return pl.online && age < 120000;
        }).length;
        
        const countEl = document.getElementById('player-count');
        if (countEl) countEl.innerText = online;
    }

    // ============================================
    // GRINDING
    // ============================================
    function doGrind() {
        const xpGain = Math.floor(10 + Math.random() * 20);
        const goldGain = Math.floor(5 + Math.random() * 15);
        
        p.xp += xpGain;
        p.gold += goldGain;
        p.kills++;
        
        // Track war kills if in active war
        if (p.guild) {
            checkAndUpdateWarKills(p.guild);
        }
        
        addLog(`You slay a Void Wraith. <span style="color:var(--gold)">+${xpGain} XP, +${goldGain} Gold</span>`);
        
        while (p.xp >= p.level * 100) {
            p.xp -= p.level * 100;
            p.level++;
            p.maxHp += 20;
            p.hp = p.maxHp;
            p.str += 2;
            p.wis += 2;
            addLog(`<span style="color:#4af; font-weight:bold;">LEVEL UP! You are now level ${p.level}.</span>`);
        }
        
        refreshUI();
        markDirty();
    }

    function doRest() {
        const healAmount = 50;
        const oldHp = p.hp;
        p.hp = Math.min(p.maxHp, p.hp + healAmount);
        const actualHeal = p.hp - oldHp;
        
        if (actualHeal === 0) {
            addLog(`<span style="color:#888;">You are already at full health.</span>`);
        } else {
            addLog(`<span style="color:#44ff44;">You rest and recover. +${actualHeal} HP</span>`);
            refreshUI();
            markDirty();
        }
    }

    // ============================================
    // VOID GATE (Dungeon)
    // ============================================
    function updateGateUI(state) {
        const desc = document.getElementById('gate-desc');
        const status = document.getElementById('gate-status');
        const actions = document.getElementById('gate-actions');
        
        if (!desc || !status || !actions) return;
        
        if (state === 'CLOSED') {
            desc.innerText = 'The gate is sealed shut. Only the strongest can break it open.';
            status.innerHTML = '<p style="color:#888;">Status: <span style="color:#ff4444; font-weight:bold;">CLOSED</span></p>';
            
            if (currentUser === ADMIN) {
                actions.innerHTML = '<button class="action-btn" onclick="openGate()" style="background:var(--admin); border-color:var(--admin);">üîì Open Gate (Admin)</button>';
            } else {
                actions.innerHTML = '<p style="color:#666;">You are not strong enough to open it alone...</p>';
            }
        } else if (state === 'OPEN') {
            desc.innerText = 'The gate groans open. A horrifying presence emanates from within.';
            status.innerHTML = '<p style="color:#888;">Status: <span style="color:#44ff44; font-weight:bold;">OPEN</span></p>';
            actions.innerHTML = '<button class="action-btn" onclick="enterGate()">Enter the Gate</button>';
        } else if (state === 'ENTERED') {
            desc.innerText = 'You stand before an ancient horror...';
            status.innerHTML = `<p style="color:#888;">Boss: <span style="color:#ff4444; font-weight:bold;">Void Titan</span> | HP: ${gameState.bossHp || 5000}</p>`;
            actions.innerHTML = '<button class="action-btn" onclick="attackBoss()">‚öî Attack Boss</button>';
        }
    }

    function openGate() {
        if (currentUser !== ADMIN) return;
        gameState.gate = 'OPEN';
        gameState.bossHp = 5000;
        updateGateUI('OPEN');
        sendSystemChat('üåÄ The Void Gate has been opened by the Void Master!');
        markDirty();
    }

    function enterGate() {
        if (gameState.gate !== 'OPEN') return;
        gameState.gate = 'ENTERED';
        updateGateUI('ENTERED');
        addLog('<span style="color:#ff4444">You step into the abyss...</span>');
        markDirty();
    }

    function attackBoss() {
        if (gameState.gate !== 'ENTERED') return;
        
        const dmg = Math.floor(p.str * 2 + Math.random() * 50);
        gameState.bossHp -= dmg;
        
        addLog(`You strike the Void Titan for <span style="color:#ff4444">${dmg}</span> damage.`);
        
        if (gameState.bossHp <= 0) {
            gameState.gate = 'CLOSED';
            const reward = 1000;
            p.gold += reward;
            p.xp += 500;
            addLog(`<span style="color:var(--gold); font-weight:bold;">BOSS DEFEATED! +${reward} Gold, +500 XP</span>`);
            sendSystemChat(`üèÜ ${currentUser} has slain the Void Titan!`);
            updateGateUI('CLOSED');
        } else {
            updateGateUI('ENTERED');
        }
        
        refreshUI();
        markDirty();
    }

    // ============================================
    // LEADERBOARD
    // ============================================
    function loadLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        if (!list) return;
        
        const players = Object.entries(gameState.players)
            .sort((a, b) => b[1].level - a[1].level || b[1].xp - a[1].xp)
            .slice(0, 20);
        
        if (players.length === 0) {
            list.innerHTML = '<p style="color:#666;">No players yet.</p>';
            return;
        }
        
        let html = '<table style="width:100%; border-collapse: collapse;">';
        html += '<tr style="border-bottom:1px solid #333;"><th style="text-align:left; padding:8px;">Rank</th><th style="text-align:left;">Name</th><th>Level</th><th>Guild</th><th>Kills</th></tr>';
        
        players.forEach(([name, data], i) => {
            const guildTag = data.guild && gameState.guilds[data.guild] ? `„Äê${gameState.guilds[data.guild].tag}„Äë` : '-';
            const isOnline = data.online && (Date.now() - (data.lastSeen || 0)) < 120000;
            const onlineIndicator = isOnline ? '<span style="color:#44ff44;">‚óè</span>' : '<span style="color:#666;">‚óè</span>';
            const displayName = data.displayName || name;
            const avatar = data.avatar || '‚öîÔ∏è';
            
            html += `<tr style="border-bottom:1px solid #222;">`;
            html += `<td style="padding:8px;">#${i + 1}</td>`;
            html += `<td>${onlineIndicator} ${avatar} <span class="name-link" onclick="showPlayerCard('${name}')">${displayName}</span></td>`;
            html += `<td style="text-align:center;">${data.level}</td>`;
            html += `<td style="text-align:center; color:#4af;">${guildTag}</td>`;
            html += `<td style="text-align:center;">${data.kills || 0}</td>`;
            html += `</tr>`;
        });
        
        html += '</table>';
        list.innerHTML = html;
    }

    function showPlayerCard(username) {
        const pl = gameState.players[username];
        if (!pl) return;
        
        const guildName = pl.guild && gameState.guilds[pl.guild] ? gameState.guilds[pl.guild].name : 'None';
        const displayName = pl.displayName || username;
        const avatar = pl.avatar || '‚öîÔ∏è';
        const bio = pl.bio || 'No bio set.';
        
        alert(
            `${avatar} ${displayName} ${avatar}\n\n` +
            `"${bio}"\n\n` +
            `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n` +
            `Account: ${username}\n` +
            `Race: ${pl.race}\n` +
            `Level: ${pl.level}\n` +
            `HP: ${pl.hp}/${pl.maxHp}\n` +
            `STR: ${pl.str} | WIS: ${pl.wis}\n` +
            `Gold: ${pl.gold}\n` +
            `Guild: ${guildName}\n` +
            `Kills: ${pl.kills} | Deaths: ${pl.deaths}`
        );
    }

    // ============================================
    // SHOP
    // ============================================
    function refreshShop() {
        const container = document.getElementById('shop-items');
        if (!container) return;
        
        const items = [
            { name: 'Strength Elixir', cost: 200, desc: '+2 STR permanently', effect: () => { p.str += 2; } },
            { name: 'Wisdom Scroll', cost: 200, desc: '+2 WIS permanently', effect: () => { p.wis += 2; } },
            { name: 'Vitality Potion', cost: 300, desc: '+20 Max HP permanently', effect: () => { p.maxHp += 20; p.hp += 20; } },
            { name: 'Warrior\'s Blessing', cost: 500, desc: '+5 STR permanently', effect: () => { p.str += 5; } },
            { name: 'Sage\'s Blessing', cost: 500, desc: '+5 WIS permanently', effect: () => { p.wis += 5; } },
            { name: 'Titan\'s Heart', cost: 800, desc: '+50 Max HP permanently', effect: () => { p.maxHp += 50; p.hp += 50; } },
            { name: 'Divine Elixir', cost: 1000, desc: '+10 STR, +10 WIS permanently', effect: () => { p.str += 10; p.wis += 10; } }
        ];
        
        let html = '<div style="display:flex; flex-wrap:wrap; gap:10px;">';
        items.forEach((item, i) => {
            html += `<div style="border:1px solid #333; padding:15px; flex:1; min-width:200px;">`;
            html += `<h3 style="margin:0 0 5px 0; color:var(--gold);">${item.name}</h3>`;
            html += `<p style="color:#888; font-size:0.85rem; margin:5px 0;">${item.desc}</p>`;
            html += `<p style="color:var(--gold); font-weight:bold; margin:10px 0;">Cost: ${item.cost} Gold</p>`;
            html += `<button class="action-btn" onclick="buyItem(${i})">Purchase</button>`;
            html += `</div>`;
        });
        html += '</div>';
        
        container.innerHTML = html;
        window.shopItems = items;
    }

    function buyItem(index) {
        const item = window.shopItems[index];
        if (!item) return;
        
        if (p.gold < item.cost) {
            addLog('<span style="color:#ff4444;">Not enough gold!</span>');
            return;
        }
        
        p.gold -= item.cost;
        item.effect();
        addLog(`<span style="color:var(--gold);">Purchased ${item.name}.</span>`);
        refreshUI();
        markDirty();
    }

    // ============================================
    // PVP
    // ============================================
    function refreshPvpTargets() {
        const container = document.getElementById('pvp-targets');
        if (!container) return;
        
        const targets = Object.entries(gameState.players)
            .filter(([name]) => name !== currentUser)
            .sort((a, b) => b[1].level - a[1].level);
        
        if (targets.length === 0) {
            container.innerHTML = '<p style="color:#666;">No other players available.</p>';
            return;
        }
        
        let html = '';
        targets.slice(0, 10).forEach(([name, data]) => {
            const isOnline = data.online && (Date.now() - (data.lastSeen || 0)) < 120000;
            const onlineText = isOnline ? '<span style="color:#44ff44;">‚óè</span>' : '<span style="color:#666;">‚óã</span>';
            const displayName = data.displayName || name;
            const avatar = data.avatar || '‚öîÔ∏è';
            
            html += `<div style="border:1px solid #333; padding:12px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">`;
            html += `<span>${onlineText} ${avatar} <span class="name-link" onclick="showPlayerCard('${name}')">${displayName}</span> (Lv ${data.level})</span>`;
            html += `<button class="action-btn" onclick="attackPlayer('${name}')">‚öî Attack</button>`;
            html += `</div>`;
        });
        
        container.innerHTML = html;
    }

    function attackPlayer(targetName) {
        const target = gameState.players[targetName];
        if (!target) return;
        
        const targetDisplay = target.displayName || targetName;
        const myDisplay = p.displayName || currentUser;
        
        const myPower = p.level * 10 + p.str * 5;
        const theirPower = target.level * 10 + target.str * 5;
        const chance = myPower / (myPower + theirPower);
        
        if (Math.random() < chance) {
            const goldStolen = Math.floor(target.gold * 0.1);
            const xpGain = target.level * 20;
            
            p.gold += goldStolen;
            p.xp += xpGain;
            p.kills++;
            target.gold = Math.max(0, target.gold - goldStolen);
            target.deaths++;
            
            addLog(`<span style="color:#44ff44;">Victory!</span> You defeated ${targetDisplay}. <span style="color:var(--gold)">+${goldStolen} Gold, +${xpGain} XP</span>`);
            sendSystemChat(`‚öî ${myDisplay} has defeated ${targetDisplay} in the Arena!`);
        } else {
            const goldLost = Math.floor(p.gold * 0.05);
            p.gold = Math.max(0, p.gold - goldLost);
            p.deaths++;
            target.kills++;
            
            addLog(`<span style="color:#ff4444;">Defeat!</span> ${targetDisplay} bested you. <span style="color:#ff4444;">-${goldLost} Gold</span>`);
        }
        
        refreshUI();
        markDirty();
    }

    // ============================================
    // GUILD SYSTEM
    // ============================================
    function refreshGuildUI() {
        const container = document.getElementById('guild-content');
        if (!container) return;
        
        if (!p.guild) {
            let html = '<h3>You are not in a guild.</h3>';
            html += '<button class="action-btn" onclick="showCreateGuild()">Create Guild (500 Gold)</button>';
            html += '<div style="margin-top:20px;"><h4>Existing Guilds</h4>';
            
            const guilds = Object.entries(gameState.guilds);
            if (guilds.length === 0) {
                html += '<p style="color:#666;">No guilds exist yet.</p>';
            } else {
                guilds.forEach(([id, guild]) => {
                    html += `<div style="border:1px solid #333; padding:10px; margin-bottom:5px;">`;
                    html += `<strong style="color:#4af;">„Äê${guild.tag}„Äë${guild.name}</strong> - ${guild.members.length} members`;
                    html += ` <button class="action-btn" onclick="joinGuild('${id}')">Request to Join</button>`;
                    html += `</div>`;
                });
            }
            html += '</div>';
            container.innerHTML = html;
        } else {
            const guild = gameState.guilds[p.guild];
            if (!guild) {
                p.guild = null;
                markDirty();
                refreshGuildUI();
                return;
            }
            
            const isLeader = guild.leader === currentUser;
            
            let html = `<h3 style="color:#4af;">„Äê${guild.tag}„Äë${guild.name}</h3>`;
            html += `<p>Leader: ${guild.leader}</p>`;
            html += `<p>Members (${guild.members.length}): ${guild.members.join(', ')}</p>`;
            
            if (isLeader) {
                html += '<button class="action-btn" onclick="disbandGuild()" style="background:#8b0000;">Disband Guild</button>';
                html += '<button class="action-btn" onclick="declareWar()">Declare War</button>';
            }
            
            html += '<button class="action-btn" onclick="leaveGuild()">Leave Guild</button>';
            
            container.innerHTML = html;
        }
    }

    function showCreateGuild() {
        const name = prompt('Guild Name:');
        if (!name) return;
        
        const tag = prompt('Guild Tag (3-5 characters):');
        if (!tag || tag.length < 3 || tag.length > 5) {
            alert('Tag must be 3-5 characters.');
            return;
        }
        
        if (p.gold < 500) {
            alert('You need 500 gold to create a guild.');
            return;
        }
        
        const guildId = 'guild_' + Date.now();
        gameState.guilds[guildId] = {
            name: name,
            tag: tag.toUpperCase(),
            leader: currentUser,
            members: [currentUser],
            createdAt: Date.now()
        };
        
        p.guild = guildId;
        p.gold -= 500;
        
        addLog(`<span style="color:#4af;">Guild „Äê${tag.toUpperCase()}„Äë${name} created!</span>`);
        sendSystemChat(`üè∞ ${currentUser} has founded the guild „Äê${tag.toUpperCase()}„Äë${name}!`);
        
        refreshUI();
        refreshGuildUI();
        markDirty();
    }

    function joinGuild(guildId) {
        const guild = gameState.guilds[guildId];
        if (!guild) return;
        
        if (guild.members.includes(currentUser)) {
            alert('You are already in this guild.');
            return;
        }
        
        guild.members.push(currentUser);
        p.guild = guildId;
        
        addLog(`<span style="color:#4af;">You joined „Äê${guild.tag}„Äë${guild.name}!</span>`);
        sendSystemChat(`üè∞ ${currentUser} has joined „Äê${guild.tag}„Äë${guild.name}!`);
        
        refreshUI();
        refreshGuildUI();
        markDirty();
    }

    function leaveGuild() {
        const guild = gameState.guilds[p.guild];
        if (!guild) return;
        
        if (guild.leader === currentUser) {
            alert('You are the leader. Disband the guild or transfer leadership first.');
            return;
        }
        
        guild.members = guild.members.filter(m => m !== currentUser);
        p.guild = null;
        
        addLog('<span style="color:#888;">You left the guild.</span>');
        
        refreshUI();
        refreshGuildUI();
        markDirty();
    }

    function disbandGuild() {
        const guild = gameState.guilds[p.guild];
        if (!guild || guild.leader !== currentUser) return;
        
        if (!confirm(`Disband „Äê${guild.tag}„Äë${guild.name}? This cannot be undone.`)) {
            return;
        }
        
        guild.members.forEach(member => {
            if (gameState.players[member]) {
                gameState.players[member].guild = null;
            }
        });
        
        delete gameState.guilds[p.guild];
        p.guild = null;
        
        addLog('<span style="color:#ff4444;">Guild disbanded.</span>');
        sendSystemChat(`üèö The guild „Äê${guild.tag}„Äë${guild.name} has been disbanded!`);
        
        refreshUI();
        refreshGuildUI();
        markDirty();
    }

    function declareWar() {
        const guild = gameState.guilds[p.guild];
        if (!guild || guild.leader !== currentUser) return;
        
        const targetGuilds = Object.entries(gameState.guilds)
            .filter(([id]) => id !== p.guild)
            .map(([id, g]) => `${id}:„Äê${g.tag}„Äë${g.name}`)
            .join('\n');
        
        if (!targetGuilds) {
            alert('No other guilds to declare war on.');
            return;
        }
        
        const choice = prompt(`Declare war on:\n${targetGuilds}\n\nEnter guild ID:`);
        if (!choice || !gameState.guilds[choice]) return;
        
        // Check if already at war
        const existingWar = gameState.wars.find(w => 
            w.status === 'active' && 
            ((w.attacker === p.guild && w.defender === choice) || 
             (w.attacker === choice && w.defender === p.guild))
        );
        
        if (existingWar) {
            alert('Already at war with this guild!');
            return;
        }
        
        const targetGuild = gameState.guilds[choice];
        
        gameState.wars.push({
            attacker: p.guild,
            defender: choice,
            attackerTag: guild.tag,
            defenderTag: targetGuild.tag,
            attackerName: guild.name,
            defenderName: targetGuild.name,
            attackerKills: 0,
            defenderKills: 0,
            status: 'active',
            startedAt: Date.now(),
            endedAt: null,
            winner: null
        });
        
        addLog(`<span style="color:#ff4444;">War declared against „Äê${targetGuild.tag}„Äë!</span>`);
        sendSystemChat(`‚öî WAR! „Äê${guild.tag}„Äë has declared war on „Äê${targetGuild.tag}„Äë! First to 20,000 frontier kills wins!`);
        
        markDirty();
    }

    function checkAndUpdateWarKills(guildId) {
        // Find active wars involving this guild
        gameState.wars.forEach(war => {
            if (war.status === 'active') {
                if (war.attacker === guildId) {
                    war.attackerKills++;
                    checkWarVictory(war);
                } else if (war.defender === guildId) {
                    war.defenderKills++;
                    checkWarVictory(war);
                }
            }
        });
        markDirty();
    }

    function checkWarVictory(war) {
        const VICTORY_KILLS = 20000;
        
        if (war.attackerKills >= VICTORY_KILLS) {
            endWar(war, war.attacker, 'attacker');
        } else if (war.defenderKills >= VICTORY_KILLS) {
            endWar(war, war.defender, 'defender');
        }
    }

    function endWar(war, winnerGuildId, winnerSide) {
        const REWARD_PER_PLAYER = 10000;
        
        war.status = 'ended';
        war.endedAt = Date.now();
        war.winner = winnerGuildId;
        
        const winnerGuild = gameState.guilds[winnerGuildId];
        const loserGuildId = winnerSide === 'attacker' ? war.defender : war.attacker;
        const loserGuild = gameState.guilds[loserGuildId];
        
        if (!winnerGuild || !loserGuild) return;
        
        // Award rewards to all members of winning guild
        let rewardedCount = 0;
        winnerGuild.members.forEach(memberName => {
            if (gameState.players[memberName]) {
                gameState.players[memberName].gold += REWARD_PER_PLAYER;
                rewardedCount++;
            }
        });
        
        // Announce victory
        const finalScore = winnerSide === 'attacker' 
            ? `${war.attackerKills} - ${war.defenderKills}`
            : `${war.defenderKills} - ${war.attackerKills}`;
        
        sendSystemChat(`üèÜ WAR ENDED! „Äê${winnerGuild.tag}„Äë has defeated „Äê${loserGuild.tag}„Äë! Final Score: ${finalScore}. ${rewardedCount} warriors rewarded ${REWARD_PER_PLAYER} gold each!`);
        
        addLog(`<span style="color:var(--gold); font-weight:bold;">üèÜ Your guild has won the war! +${REWARD_PER_PLAYER} Gold!</span>`);
        
        markDirty();
        refreshUI();
    }

    function refreshWarsUI() {
        const activeList = document.getElementById('active-wars-list');
        const historyList = document.getElementById('war-history-list');
        
        if (!activeList || !historyList) return;
        
        // Active wars
        const activeWars = gameState.wars.filter(w => w.status === 'active');
        
        if (activeWars.length === 0) {
            activeList.innerHTML = '<p style="color:#666;">No active wars.</p>';
        } else {
            let html = '';
            activeWars.forEach(war => {
                const progress = Math.max(war.attackerKills, war.defenderKills) / 20000 * 100;
                const leading = war.attackerKills > war.defenderKills ? war.attackerTag : war.defenderTag;
                const leadingKills = Math.max(war.attackerKills, war.defenderKills);
                
                html += `<div style="border:1px solid #444; padding:15px; margin-bottom:15px; background:#0a0a0a;">`;
                html += `<h4 style="margin:0 0 10px 0; color:var(--accent);">„Äê${war.attackerTag}„Äë vs „Äê${war.defenderTag}„Äë</h4>`;
                html += `<div style="display:flex; justify-content:space-between; margin-bottom:8px;">`;
                html += `<span style="color:#4af;">„Äê${war.attackerTag}„Äë: ${war.attackerKills.toLocaleString()} kills</span>`;
                html += `<span style="color:#f4a;">„Äê${war.defenderTag}„Äë: ${war.defenderKills.toLocaleString()} kills</span>`;
                html += `</div>`;
                html += `<div style="background:#222; height:20px; border:1px solid #444; position:relative; overflow:hidden;">`;
                html += `<div style="background:linear-gradient(90deg, var(--accent), #ff4444); height:100%; width:${progress}%; transition:width 0.3s;"></div>`;
                html += `</div>`;
                html += `<p style="margin:8px 0 0 0; color:#888; font-size:0.85rem;">„Äê${leading}„Äë leading ‚Ä¢ ${(20000 - leadingKills).toLocaleString()} kills to victory</p>`;
                html += `</div>`;
            });
            activeList.innerHTML = html;
        }
        
        // War history
        const endedWars = gameState.wars.filter(w => w.status === 'ended').slice(-10).reverse();
        
        if (endedWars.length === 0) {
            historyList.innerHTML = '<p style="color:#666;">No war history yet.</p>';
        } else {
            let html = '<div style="font-family:monospace; font-size:0.85rem;">';
            endedWars.forEach(war => {
                const winnerGuild = gameState.guilds[war.winner];
                const winnerTag = winnerGuild ? winnerGuild.tag : '???';
                const loserTag = war.winner === war.attacker ? war.defenderTag : war.attackerTag;
                const duration = Math.floor((war.endedAt - war.startedAt) / 1000 / 60); // minutes
                const endDate = new Date(war.endedAt).toLocaleDateString();
                
                html += `<div style="border-bottom:1px solid #222; padding:10px 0;">`;
                html += `<span style="color:var(--gold);">üèÜ „Äê${winnerTag}„Äë</span> defeated `;
                html += `<span style="color:#666;">„Äê${loserTag}„Äë</span> `;
                html += `<span style="color:#888;">(${war.attackerKills.toLocaleString()} - ${war.defenderKills.toLocaleString()}) ‚Ä¢ ${endDate}</span>`;
                html += `</div>`;
            });
            html += '</div>';
            historyList.innerHTML = html;
        }
    }

    // ============================================
    // CHAT SYSTEM
    // ============================================
    function sendChatMsg() {
        const input = document.getElementById('chat-in');
        const msg = input.value.trim();
        if (!msg) return;
        
        const chatMsg = {
            id: Date.now() + '-' + currentUser,
            user: currentUser,
            text: msg,
            time: Date.now()
        };
        
        gameState.chat.push(chatMsg);
        seenChatIds.add(chatMsg.id);
        
        if (gameState.chat.length > 100) {
            gameState.chat.shift();
        }
        
        displayChat();
        input.value = '';
        markDirty();
    }

    function sendSystemChat(text) {
        const chatMsg = {
            id: Date.now() + '-system',
            user: 'SYSTEM',
            text: text,
            time: Date.now()
        };
        
        gameState.chat.push(chatMsg);
        seenChatIds.add(chatMsg.id);
        
        if (gameState.chat.length > 100) {
            gameState.chat.shift();
        }
        
        displayChat();
        markDirty();
    }

    function displayChat() {
        const log = document.getElementById('chat-log');
        if (!log) return;
        
        log.innerHTML = '';
        gameState.chat.slice(-50).forEach(msg => {
            const div = document.createElement('div');
            div.style.marginBottom = '5px';
            
            if (msg.user === 'SYSTEM') {
                div.style.color = '#888';
                div.innerHTML = `<strong>[SYSTEM]</strong> ${msg.text}`;
            } else {
                const userColor = msg.user === currentUser ? 'var(--gold)' : '#4af';
                const playerData = gameState.players[msg.user];
                const displayName = playerData?.displayName || msg.user;
                div.innerHTML = `<strong style="color:${userColor};">${displayName}:</strong> ${msg.text}`;
            }
            
            log.appendChild(div);
        });
        
        log.scrollTop = log.scrollHeight;
    }

    // ============================================
    // NEWS
    // ============================================
    function refreshNews() {
        const container = document.getElementById('news-list');
        if (!container) return;
        
        // Show/hide admin post UI
        const adminUI = document.getElementById('admin-news-post');
        if (adminUI) {
            if (currentUser === ADMIN) {
                adminUI.classList.remove('hidden');
            } else {
                adminUI.classList.add('hidden');
            }
        }
        
        if (gameState.news.length === 0) {
            container.innerHTML = '<p style="color:#666;">No news yet.</p>';
            return;
        }
        
        let html = '';
        gameState.news.slice().reverse().slice(0, 20).forEach(item => {
            const date = new Date(item.time).toLocaleString();
            html += `<div style="border-bottom:1px solid #222; padding:10px 0;">`;
            html += `<div style="color:#888; font-size:0.8rem; margin-bottom:5px;">${date}</div>`;
            html += `<div>${item.text}</div>`;
            html += `</div>`;
        });
        
        container.innerHTML = html;
    }

    function addNews(text) {
        gameState.news.push({
            text: text,
            time: Date.now()
        });
        
        if (gameState.news.length > 100) {
            gameState.news.shift();
        }
        
        markDirty();
    }

    function postNews() {
        if (currentUser !== ADMIN) {
            alert('Only the Void Master can post news.');
            return;
        }
        
        const input = document.getElementById('news-input');
        const text = input.value.trim();
        
        if (!text) {
            alert('Please enter a news message.');
            return;
        }
        
        addNews(text);
        sendSystemChat(`üì∞ ${text}`);
        input.value = '';
        refreshNews();
        
        addLog("<span style='color:var(--admin)'>News posted to realm.</span>");
    }

    // ============================================
    // PROFILE SYSTEM
    // ============================================
    function saveProfile() {
        const displayName = document.getElementById('profile-displayname').value.trim();
        const avatar = document.getElementById('profile-avatar').value;
        const bio = document.getElementById('profile-bio').value.trim();
        const status = document.getElementById('profile-status');
        
        if (displayName && displayName.length < 2) {
            status.style.color = '#ff4444';
            status.innerText = 'Display name must be at least 2 characters.';
            return;
        }
        
        if (displayName && displayName.length > 20) {
            status.style.color = '#ff4444';
            status.innerText = 'Display name must be 20 characters or less.';
            return;
        }
        
        if (bio && bio.length > 200) {
            status.style.color = '#ff4444';
            status.innerText = 'Bio must be 200 characters or less.';
            return;
        }
        
        // Save display name
        if (displayName) {
            p.displayName = displayName;
        } else {
            delete p.displayName;
        }
        
        // Save avatar
        p.avatar = avatar || '‚öîÔ∏è';
        
        // Save bio
        if (bio) {
            p.bio = bio;
        } else {
            delete p.bio;
        }
        
        markDirty();
        
        status.style.color = '#44ff44';
        status.innerText = '‚úì Profile saved!';
        
        setTimeout(() => {
            status.innerText = '';
        }, 3000);
        
        refreshUI();
        addLog('<span style="color:var(--gold)">Profile updated.</span>');
    }

    function selectAvatar(emoji) {
        document.getElementById('profile-avatar').value = emoji;
        
        // Update visual selection
        document.querySelectorAll('.avatar-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`.avatar-option[data-avatar="${emoji}"]`).classList.add('selected');
    }

    // ============================================
    // BACKUP SYSTEM (Admin Only)
    // ============================================
    function refreshBackupInfo() {
        if (currentUser !== ADMIN) return;
        
        const info = document.getElementById('backup-info');
        if (!info) return;
        const playerCount = Object.keys(gameState.players).length;
        const accountCount = Object.keys(getAccounts()).length;
        const guildCount = Object.keys(gameState.guilds || {}).length;
        const warCount = (gameState.wars || []).length;
        const newsCount = (gameState.news || []).length;
        const chatCount = (gameState.chat || []).length;
        
        info.innerHTML = `Players: ${playerCount} ¬∑ Accounts: ${accountCount} ¬∑ Guilds: ${guildCount}<br>` +
            `Wars: ${warCount} ¬∑ News: ${newsCount} ¬∑ Chat msgs: ${chatCount}<br>` +
            `Gate: ${gameState.gate || 'CLOSED'}`;
    }

    function downloadBackup() {
        if (currentUser !== ADMIN) return;

        const backup = {
            _meta: {
                version: 1,
                exported: new Date().toISOString(),
                exportedBy: currentUser,
                realm: document.getElementById('realm-name').value.trim() || 'void-realm-default'
            },
            accounts: getAccounts(),
            gameState: {
                players: gameState.players,
                guilds: gameState.guilds || {},
                wars: gameState.wars || [],
                news: gameState.news || [],
                gate: gameState.gate || 'CLOSED',
                chat: gameState.chat || []
            }
        };

        const json = JSON.stringify(backup, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        const dateStr = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
        a.href = url;
        a.download = `void-slayer-backup-${dateStr}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        const status = document.getElementById('backup-status');
        status.style.color = '#44ff44';
        status.innerText = '‚úÖ Backup downloaded!';
        addLog("<span style='color:var(--admin)'>Realm backup downloaded.</span>");
    }

    function uploadBackup(event) {
        if (currentUser !== ADMIN) return;
        const status = document.getElementById('backup-status');
        
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const backup = JSON.parse(e.target.result);
                
                if (!backup.gameState || !backup.accounts) {
                    status.style.color = '#ff4444';
                    status.innerText = '‚ùå Invalid backup file ‚Äî missing gameState or accounts.';
                    return;
                }

                const gs = backup.gameState;
                const playerCount = Object.keys(gs.players || {}).length;
                const accountCount = Object.keys(backup.accounts || {}).length;
                const meta = backup._meta || {};

                if (!confirm(
                    `Restore this backup?\n\n` +
                    `From: ${meta.exported || 'Unknown date'}\n` +
                    `Realm: ${meta.realm || 'Unknown'}\n` +
                    `Players: ${playerCount}\n` +
                    `Accounts: ${accountCount}\n\n` +
                    `This will OVERWRITE all current realm data.`
                )) {
                    status.style.color = '#888';
                    status.innerText = 'Restore cancelled.';
                    return;
                }

                // Restore accounts
                const accounts = backup.accounts;
                saveAccounts(accounts);

                // Restore game state
                if (gs.players) gameState.players = gs.players;
                if (gs.guilds) gameState.guilds = gs.guilds;
                if (gs.wars) gameState.wars = gs.wars;
                if (gs.news) gameState.news = gs.news;
                if (gs.gate) gameState.gate = gs.gate;
                if (gs.chat) {
                    gameState.chat = gs.chat;
                    gs.chat.forEach(msg => seenChatIds.add(msg.id));
                }

                // Reload own player data if present
                if (gameState.players[currentUser]) {
                    Object.assign(p, gameState.players[currentUser]);
                    refreshUI();
                }

                // Force cloud sync
                saveToCloud(true);
                
                updateGateUI(gameState.gate);
                updatePlayerCount();

                status.style.color = '#44ff44';
                status.innerText = `‚úÖ Restored! ${playerCount} players, ${accountCount} accounts loaded.`;
                addLog("<span style='color:var(--admin)'>Realm backup restored!</span>");
                sendSystemChat("üîÑ The Void Master has restored the realm from a backup!");

                refreshBackupInfo();
            } catch (err) {
                status.style.color = '#ff4444';
                status.innerText = '‚ùå Error reading backup: ' + err.message;
            }
        };
        reader.readAsText(file);
        
        event.target.value = '';
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    window.addEventListener('load', () => {
        updateCloudStatus('Ready', '#888');
        const statusEl = document.getElementById('connection-status');
        if (statusEl) statusEl.textContent = 'Ready ‚Äî local save active';
        goTab('grind');
        
        // Periodic player count update
        setInterval(() => {
            if (currentUser) {
                updatePlayerCount();
                p.lastSeen = Date.now();
            }
        }, 30000);
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (currentUser && p) {
            p.online = false;
            saveLocalGameState(); // Always save locally
            saveToCloud(true); // Attempt final cloud save
        }
        stopCloudSync();
    });
</script>
</body>
</html>