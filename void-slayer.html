<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VOID-SLAYER | Cloud MMORPG</title>
    <style>
        :root { --bg: #050508; --panel: #111116; --accent: #8b0000; --gold: #d4af37; --text: #aaa; --admin: #ff00ff; }
        * { box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Crimson Text', serif; margin: 0; display: flex; height: 100vh; height: 100dvh; overflow: hidden; }
        nav { width: 220px; min-width: 220px; background: var(--panel); border-right: 1px solid #222; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .nav-link { color: #666; padding: 12px 10px; border-bottom: 1px solid #1a1a1a; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        .nav-link:hover { color: #fff; background: #1a1a1f; padding-left: 15px; }
        main { flex: 1; display: flex; flex-direction: column; min-width: 0; min-height: 0; overflow: hidden; }
        #stats-bar { background: #000; padding: 10px 20px; border-bottom: 1px solid #222; display: flex; gap: 20px; font-family: monospace; font-size: 0.85rem; align-items: center; flex-wrap: wrap; }
        .stat-val { color: var(--gold); font-weight: bold; }
        .content { flex: 1; padding: 20px; overflow-y: auto; -webkit-overflow-scrolling: touch; background: radial-gradient(circle at top, #16161d 0%, #050508 100%); }
        .card { background: rgba(20, 20, 25, 0.98); border: 1px solid #333; padding: 20px; margin-bottom: 15px; }
        .action-btn { background: #222; border: 1px solid #444; color: #ccc; padding: 10px 20px; cursor: pointer; text-transform: uppercase; margin: 4px; font-family: inherit; font-size: 0.85rem; }
        .action-btn:hover { background: var(--accent); color: white; border-color: red; }
        #game-log { height: 160px; overflow-y: auto; border-top: 1px solid #222; padding-top: 10px; font-size: 0.85rem; color: #888; margin-top: 20px; }
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px; overflow-y: auto; }
        input, select { background: #111; border: 1px solid #333; color: white; padding: 12px; margin-bottom: 12px; width: 260px; box-sizing: border-box; }
        .hidden { display: none; }
        .debug { font-size: 0.75rem; color: #555; margin-top: 10px; font-family: monospace; }

        /* Auth form styles */
        .auth-card { background: rgba(20, 20, 25, 0.98); border: 1px solid #333; padding: 30px 40px; display: flex; flex-direction: column; align-items: center; max-width: 400px; width: 100%; }
        .auth-tabs { display: flex; gap: 0; margin-bottom: 20px; width: 100%; }
        .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; background: #111; border: 1px solid #333; color: #666; text-transform: uppercase; font-family: inherit; letter-spacing: 2px; font-size: 0.85rem; transition: 0.2s; }
        .auth-tab.active { background: var(--accent); color: white; border-color: var(--accent); }
        .auth-tab:hover:not(.active) { color: #fff; background: #1a1a1f; }
        .auth-error { color: #ff4444; font-size: 0.85rem; margin-bottom: 10px; min-height: 1.2em; text-align: center; }
        .auth-success { color: #44ff44; font-size: 0.85rem; margin-bottom: 10px; min-height: 1.2em; text-align: center; }
        .auth-field { width: 100%; }
        .auth-field label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; }
        .auth-field input, .auth-field select { width: 100%; }
        .auth-divider { width: 100%; border-top: 1px solid #222; margin: 15px 0; position: relative; }
        .auth-divider span { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: rgba(20, 20, 25, 0.98); padding: 0 10px; color: #555; font-size: 0.8rem; }
        .realm-info { font-size: 0.75rem; color: #555; text-align: center; margin-top: -5px; margin-bottom: 10px; }
        .name-link { color: inherit; cursor: pointer; text-decoration: none; border-bottom: 1px dotted #555; transition: 0.15s; }
        .name-link:hover { color: var(--gold); border-bottom-color: var(--gold); }

        /* Mobile hamburger */
        #mobile-header { display: none; background: var(--panel); padding: 10px 15px; border-bottom: 1px solid #222; align-items: center; justify-content: space-between; z-index: 50; }
        #menu-toggle { background: none; border: 1px solid #444; color: #ccc; font-size: 1.3rem; padding: 6px 12px; cursor: pointer; font-family: inherit; }
        #nav-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 98; }

        /* Mobile responsive */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #mobile-header { display: flex; }
            nav { position: fixed; top: 0; left: -280px; width: 260px; min-width: 260px; height: 100%; z-index: 99; transition: left 0.3s ease; padding-top: 15px; }
            nav.open { left: 0; }
            #nav-overlay.open { display: block; }
            main { flex: 1; min-height: 0; overflow: hidden; }
            #stats-bar { padding: 8px 12px; gap: 10px; font-size: 0.75rem; }
            .content { padding: 12px; padding-bottom: 80px; }
            .card { padding: 15px; }
            .action-btn { padding: 10px 16px; font-size: 0.8rem; }
            #auth-screen { padding: 15px; }
            .auth-card { padding: 20px 15px; }
            input, select { width: 100%; }
            #chat-in { width: 65% !important; }
        }
    </style>
</head>
<body>

<div id="auth-screen">
    <h1 style="color:var(--accent); letter-spacing: 5px; margin-bottom: 5px;">VOID-SLAYER</h1>
    <p style="color: #555; margin-top: 0; margin-bottom: 25px; font-size: 0.9rem;">Cloud MMORPG</p>

    <div class="auth-card">
        <div class="auth-tabs">
            <div class="auth-tab active" id="tab-login-btn" onclick="switchAuthTab('login')">Login</div>
            <div class="auth-tab" id="tab-register-btn" onclick="switchAuthTab('register')">Register</div>
        </div>

        <div id="auth-error" class="auth-error"></div>
        <div id="auth-success" class="auth-success"></div>

        <!-- Login Form -->
        <div id="auth-login">
            <div class="auth-field">
                <label>Username</label>
                <input type="text" id="login-username" placeholder="Enter username" onkeypress="if(event.key==='Enter')doLogin()">
            </div>
            <div class="auth-field">
                <label>Password</label>
                <input type="password" id="login-password" placeholder="Enter password" onkeypress="if(event.key==='Enter')doLogin()">
            </div>
            <button class="action-btn" style="width:100%; margin: 10px 0 0 0;" onclick="doLogin()">Enter the Void</button>
        </div>

        <!-- Register Form -->
        <div id="auth-register" class="hidden">
            <div class="auth-field">
                <label>Username</label>
                <input type="text" id="reg-username" placeholder="Choose a username" onkeypress="if(event.key==='Enter')doRegister()">
            </div>
            <div class="auth-field">
                <label>Password</label>
                <input type="password" id="reg-password" placeholder="Choose a password" onkeypress="if(event.key==='Enter')doRegister()">
            </div>
            <div class="auth-field">
                <label>Confirm Password</label>
                <input type="password" id="reg-password2" placeholder="Confirm password" onkeypress="if(event.key==='Enter')doRegister()">
            </div>
            <div class="auth-field">
                <label>Race</label>
                <select id="race-sel" style="width:100%;">
                    <option value="Hollow">Hollow (+Str)</option>
                    <option value="Wraith">Wraith (+Wis)</option>
                </select>
            </div>
            <button class="action-btn" style="width:100%; margin: 10px 0 0 0;" onclick="doRegister()">Create Character</button>
        </div>

        <div class="auth-divider"><span>REALM</span></div>

        <div class="auth-field">
            <input type="text" id="realm-name" value="void-realm-default" placeholder="Realm name" style="text-align:center; font-family: monospace; color: var(--gold); border-color: #444;">
        </div>
        <div class="realm-info">All players in the same realm share the same cloud database.</div>

        <div class="debug" id="connection-status">Initializing Cloud Sync...</div>
    </div>
</div>

<div id="nav-overlay" onclick="closeMenu()"></div>

<nav id="main-nav">
    <h2 style="color:var(--accent)">VOID MENU</h2>
    <div class="nav-link" onclick="goTab('grind')">The Frontier</div>
    <div id="nav-dungeon" class="nav-link" onclick="goTab('dungeon')">The Void Gate</div>
    <div class="nav-link" onclick="goTab('lead'); loadLeaderboard();">Leaderboard</div>
    <div class="nav-link" onclick="goTab('shop'); refreshShop();">Black Market</div>
    <div class="nav-link" onclick="goTab('pvp'); refreshPvpTargets();">The Arena</div>
    <div class="nav-link" onclick="goTab('guild'); refreshGuildUI();">Guild Hall</div>
    <div class="nav-link" onclick="goTab('chat')">Tavern</div>
    <div class="nav-link" onclick="goTab('news'); refreshNews();">News</div>
    <div id="nav-backup" class="nav-link hidden" onclick="goTab('backup'); refreshBackupInfo();" style="color:var(--admin);">üîí Backup</div>
    <div class="debug" style="margin-top: auto; padding-top: 20px;">
        <span id="player-count">0</span> players online<br>
        <span id="cloud-status" style="color: #888;">Cloud: Idle</span>
    </div>
</nav>

<div id="mobile-header">
    <button id="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
    <span style="color:var(--accent); font-weight:bold; letter-spacing:2px;">VOID-SLAYER</span>
</div>

<main>
    <div id="stats-bar">
        <span>Lv <span class="stat-val" id="stat-level">1</span></span>
        <span>XP <span class="stat-val" id="stat-xp">0</span>/<span id="stat-xp-next">100</span></span>
        <span>HP <span class="stat-val" id="stat-hp">100</span></span>
        <span>STR <span class="stat-val" id="stat-str">10</span></span>
        <span>WIS <span class="stat-val" id="stat-wis">10</span></span>
        <span style="color:var(--gold)">‚öú <span class="stat-val" id="stat-gold">0</span></span>
        <span id="stat-guild"></span>
    </div>

    <div class="content">
        <!-- FRONTIER TAB -->
        <div id="tab-grind">
            <div class="card">
                <h2>The Frontier</h2>
                <p>The dark frontier sprawls before you, teeming with shadowy foes. Your blade thirsts for blood.</p>
                <button class="action-btn" onclick="doGrind()">Slay Minions</button>
            </div>
            <div id="game-log"></div>
        </div>

        <!-- VOID GATE TAB -->
        <div id="tab-dungeon" class="hidden">
            <div class="card">
                <h2>The Void Gate</h2>
                <p id="gate-desc">The massive obsidian gate looms before you.</p>
                <div id="gate-status"></div>
                <div id="gate-actions"></div>
            </div>
        </div>

        <!-- LEADERBOARD TAB -->
        <div id="tab-lead" class="hidden">
            <div class="card">
                <h2>Leaderboard</h2>
                <div id="leaderboard-list" style="font-family:monospace; font-size:0.9rem;"></div>
            </div>
        </div>

        <!-- SHOP TAB -->
        <div id="tab-shop" class="hidden">
            <div class="card">
                <h2>Black Market</h2>
                <p>A hooded merchant whispers prices. Gold buys power.</p>
                <div id="shop-items"></div>
            </div>
        </div>

        <!-- PVP TAB -->
        <div id="tab-pvp" class="hidden">
            <div class="card">
                <h2>The Arena</h2>
                <p>Challenge other slayers to mortal combat.</p>
                <div id="pvp-targets"></div>
            </div>
        </div>

        <!-- GUILD TAB -->
        <div id="tab-guild" class="hidden">
            <div class="card">
                <h2>Guild Hall</h2>
                <div id="guild-content"></div>
            </div>
        </div>

        <!-- CHAT TAB -->
        <div id="tab-chat" class="hidden">
            <div class="card">
                <h2>The Tavern</h2>
                <div id="chat-log" style="height:300px; overflow-y:auto; border:1px solid #333; padding:10px; margin-bottom:10px; font-size:0.9rem;"></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="chat-in" placeholder="Speak..." style="flex:1; width:auto;" onkeypress="if(event.key==='Enter')sendChatMsg()">
                    <button class="action-btn" onclick="sendChatMsg()">Send</button>
                </div>
            </div>
        </div>

        <!-- NEWS TAB -->
        <div id="tab-news" class="hidden">
            <div class="card">
                <h2>Realm News</h2>
                <div id="news-list"></div>
            </div>
        </div>

        <!-- BACKUP TAB (Admin Only) -->
        <div id="tab-backup" class="hidden">
            <div class="card">
                <h2 style="color:var(--admin)">üîí Admin Backup Panel</h2>
                <p style="color:#888;">Download or restore the entire realm state.</p>
                
                <div id="backup-info" style="margin:15px 0; padding:15px; background:#0a0a0a; border:1px solid #222; font-family:monospace; font-size:0.85rem;"></div>
                
                <button class="action-btn" onclick="downloadBackup()" style="background:var(--admin); border-color:var(--admin);">‚¨á Download Backup</button>
                <label class="action-btn" style="display:inline-block; cursor:pointer;">
                    ‚¨Ü Upload Backup
                    <input type="file" accept=".json" onchange="uploadBackup(event)" style="display:none;">
                </label>
                
                <div id="backup-status" style="margin-top:15px; font-size:0.9rem; color:#888;"></div>
            </div>
        </div>
    </div>
</main>

<script>
    // ============================================
    // CLOUD SYNC CONFIGURATION
    // ============================================
    const CLOUD_CONFIG = {
        webAppUrl: 'https://script.google.com/macros/s/AKfycbzRj1TqeD9M_k84dcgfj3AduBjTq4DJittWqaLfAzXmNU8NpWZh7TP5gMEEo2q22HbJ/exec',
        sheetId: '1EblrSWCeDCgOVLB3wJ9rkQ56-SdThchkcpaa3bR4Bas',
        heartbeatInterval: 60000, // 60 seconds
        autoSaveDelay: 3000 // 3 seconds after marking dirty
    };

    let cloudSyncTimer = null;
    let isDirty = false;
    let lastSyncTime = 0;
    let autoSaveTimer = null;

    // ============================================
    // GAME STATE & CONSTANTS
    // ============================================
    const ADMIN = 'voidmaster';
    let currentUser = null;
    let currentTab = 'grind';
    let p = {}; // Current player
    
    const gameState = {
        players: {},
        guilds: {},
        wars: [],
        news: [],
        gate: 'CLOSED',
        chat: []
    };

    const seenChatIds = new Set();

    // ============================================
    // CLOUD SYNC FUNCTIONS
    // ============================================
    
    function updateCloudStatus(message, color = '#888') {
        const statusEl = document.getElementById('cloud-status');
        if (statusEl) {
            statusEl.textContent = 'Cloud: ' + message;
            statusEl.style.color = color;
        }
    }

    async function loadFromCloud() {
        try {
            updateCloudStatus('Loading...', '#ffaa00');
            const realm = document.getElementById('realm-name').value.trim() || 'void-realm-default';
            
            const response = await fetch(`${CLOUD_CONFIG.webAppUrl}?realm=${encodeURIComponent(realm)}&action=load`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success && data.data) {
                // Load accounts
                if (data.data.accounts) {
                    saveAccounts(data.data.accounts);
                }
                
                // Load game state
                if (data.data.gameState) {
                    const gs = data.data.gameState;
                    if (gs.players) gameState.players = gs.players;
                    if (gs.guilds) gameState.guilds = gs.guilds;
                    if (gs.wars) gameState.wars = gs.wars;
                    if (gs.news) gameState.news = gs.news;
                    if (gs.gate) gameState.gate = gs.gate;
                    if (gs.chat) {
                        gameState.chat = gs.chat;
                        gs.chat.forEach(msg => seenChatIds.add(msg.id));
                    }
                }
                
                updateCloudStatus('Connected', '#44ff44');
                addLog("<span style='color:#44ff44'>‚úì Loaded from cloud</span>");
                return true;
            } else {
                // No data yet in cloud, that's okay
                updateCloudStatus('Connected (empty)', '#ffaa00');
                return true;
            }
        } catch (err) {
            console.error('Cloud load error:', err);
            updateCloudStatus('Load failed', '#ff4444');
            addLog("<span style='color:#ff4444'>‚ö† Could not load from cloud: " + err.message + "</span>");
            return false;
        }
    }

    async function saveToCloud(force = false) {
        if (!force && !isDirty) {
            updateCloudStatus('Idle', '#888');
            return true;
        }
        
        try {
            updateCloudStatus('Saving...', '#ffaa00');
            const realm = document.getElementById('realm-name').value.trim() || 'void-realm-default';
            
            const payload = {
                realm: realm,
                accounts: getAccounts(),
                gameState: {
                    players: gameState.players,
                    guilds: gameState.guilds,
                    wars: gameState.wars,
                    news: gameState.news,
                    gate: gameState.gate,
                    chat: gameState.chat
                },
                timestamp: Date.now()
            };
            
            const response = await fetch(CLOUD_CONFIG.webAppUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                isDirty = false;
                lastSyncTime = Date.now();
                updateCloudStatus('Synced', '#44ff44');
                
                // Auto-hide success message after 2 seconds
                setTimeout(() => {
                    if (!isDirty) {
                        updateCloudStatus('Idle', '#888');
                    }
                }, 2000);
                
                return true;
            } else {
                throw new Error(result.error || 'Save failed');
            }
        } catch (err) {
            console.error('Cloud save error:', err);
            updateCloudStatus('Save failed', '#ff4444');
            return false;
        }
    }

    function markDirty() {
        isDirty = true;
        
        // Clear existing timer
        if (autoSaveTimer) {
            clearTimeout(autoSaveTimer);
        }
        
        // Set new timer for auto-save after brief delay
        autoSaveTimer = setTimeout(() => {
            saveToCloud();
        }, CLOUD_CONFIG.autoSaveDelay);
    }

    function startCloudSync() {
        // Start heartbeat timer
        if (cloudSyncTimer) {
            clearInterval(cloudSyncTimer);
        }
        
        cloudSyncTimer = setInterval(() => {
            saveToCloud(); // Will only save if dirty
        }, CLOUD_CONFIG.heartbeatInterval);
        
        addLog("<span style='color:#44ff44'>Cloud sync started (60s heartbeat)</span>");
    }

    function stopCloudSync() {
        if (cloudSyncTimer) {
            clearInterval(cloudSyncTimer);
            cloudSyncTimer = null;
        }
        if (autoSaveTimer) {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = null;
        }
    }

    // ============================================
    // LOCAL STORAGE (Accounts only)
    // ============================================
    function getAccounts() {
        const realm = document.getElementById('realm-name')?.value.trim() || 'void-realm-default';
        const key = `void-accounts-${realm}`;
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : {};
    }

    function saveAccounts(accounts) {
        const realm = document.getElementById('realm-name')?.value.trim() || 'void-realm-default';
        const key = `void-accounts-${realm}`;
        localStorage.setItem(key, JSON.stringify(accounts));
    }

    function saveGameState() {
        // Legacy function - no longer saves to localStorage
        // State is now auto-synced to cloud via dirty flag
        markDirty();
    }

    // ============================================
    // AUTH FUNCTIONS
    // ============================================
    function switchAuthTab(tab) {
        document.getElementById('auth-login').classList.toggle('hidden', tab !== 'login');
        document.getElementById('auth-register').classList.toggle('hidden', tab !== 'register');
        document.getElementById('tab-login-btn').classList.toggle('active', tab === 'login');
        document.getElementById('tab-register-btn').classList.toggle('active', tab === 'register');
        document.getElementById('auth-error').innerText = '';
        document.getElementById('auth-success').innerText = '';
    }

    async function doLogin() {
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;
        const errorDiv = document.getElementById('auth-error');
        
        errorDiv.innerText = '';
        
        if (!username || !password) {
            errorDiv.innerText = 'Enter username and password.';
            return;
        }
        
        // Load from cloud first
        await loadFromCloud();
        
        const accounts = getAccounts();
        
        if (!accounts[username]) {
            errorDiv.innerText = 'Account not found.';
            return;
        }
        
        if (accounts[username].password !== password) {
            errorDiv.innerText = 'Incorrect password.';
            return;
        }
        
        currentUser = username;
        
        if (!gameState.players[username]) {
            gameState.players[username] = {
                race: accounts[username].race,
                level: 1,
                xp: 0,
                hp: 100,
                maxHp: 100,
                str: accounts[username].race === 'Hollow' ? 11 : 10,
                wis: accounts[username].race === 'Wraith' ? 11 : 10,
                gold: 0,
                guild: null,
                kills: 0,
                deaths: 0,
                online: true,
                lastSeen: Date.now()
            };
            markDirty();
        } else {
            gameState.players[username].online = true;
            gameState.players[username].lastSeen = Date.now();
            markDirty();
        }
        
        p = gameState.players[username];
        
        document.getElementById('auth-screen').classList.add('hidden');
        refreshUI();
        startCloudSync();
        updatePlayerCount();
        
        if (username === ADMIN) {
            document.getElementById('nav-backup').classList.remove('hidden');
        }
        
        addLog(`<span style="color:var(--gold)">Welcome, ${username}.</span>`);
        sendSystemChat(`‚öî ${username} has entered the Void.`);
    }

    async function doRegister() {
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value;
        const password2 = document.getElementById('reg-password2').value;
        const race = document.getElementById('race-sel').value;
        const errorDiv = document.getElementById('auth-error');
        const successDiv = document.getElementById('auth-success');
        
        errorDiv.innerText = '';
        successDiv.innerText = '';
        
        if (!username || !password) {
            errorDiv.innerText = 'Enter a username and password.';
            return;
        }
        
        if (username.length < 3) {
            errorDiv.innerText = 'Username must be at least 3 characters.';
            return;
        }
        
        if (password.length < 4) {
            errorDiv.innerText = 'Password must be at least 4 characters.';
            return;
        }
        
        if (password !== password2) {
            errorDiv.innerText = 'Passwords do not match.';
            return;
        }
        
        // Load from cloud first
        await loadFromCloud();
        
        const accounts = getAccounts();
        
        if (accounts[username]) {
            errorDiv.innerText = 'Username already taken.';
            return;
        }
        
        accounts[username] = { password, race };
        saveAccounts(accounts);
        markDirty();
        
        successDiv.innerText = '‚úì Account created! You may now login.';
        
        setTimeout(() => {
            switchAuthTab('login');
            document.getElementById('login-username').value = username;
            document.getElementById('login-password').focus();
        }, 1500);
    }

    // ============================================
    // UI FUNCTIONS
    // ============================================
    function refreshUI() {
        document.getElementById('stat-level').innerText = p.level;
        document.getElementById('stat-xp').innerText = p.xp;
        document.getElementById('stat-xp-next').innerText = p.level * 100;
        document.getElementById('stat-hp').innerText = p.hp;
        document.getElementById('stat-str').innerText = p.str;
        document.getElementById('stat-wis').innerText = p.wis;
        document.getElementById('stat-gold').innerText = p.gold;
        
        const guildSpan = document.getElementById('stat-guild');
        if (p.guild) {
            const guild = gameState.guilds[p.guild];
            guildSpan.innerHTML = `<span style="color:#4af">„Äê${guild ? guild.tag : p.guild}„Äë</span>`;
        } else {
            guildSpan.innerHTML = '';
        }
    }

    function addLog(html) {
        const log = document.getElementById('game-log');
        if (!log) return;
        const entry = document.createElement('div');
        entry.innerHTML = `<span style="color:#555">[${new Date().toLocaleTimeString()}]</span> ${html}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    }

    function goTab(tabName) {
        currentTab = tabName;
        document.querySelectorAll('.content > div').forEach(el => el.classList.add('hidden'));
        const target = document.getElementById('tab-' + tabName);
        if (target) target.classList.remove('hidden');
        closeMenu();
    }

    function toggleMenu() {
        document.getElementById('main-nav').classList.toggle('open');
        document.getElementById('nav-overlay').classList.toggle('open');
    }

    function closeMenu() {
        document.getElementById('main-nav').classList.remove('open');
        document.getElementById('nav-overlay').classList.remove('open');
    }

    function updatePlayerCount() {
        const online = Object.values(gameState.players).filter(pl => {
            const age = Date.now() - (pl.lastSeen || 0);
            return pl.online && age < 120000;
        }).length;
        
        const countEl = document.getElementById('player-count');
        if (countEl) countEl.innerText = online;
    }

    // ============================================
    // GRINDING
    // ============================================
    function doGrind() {
        const xpGain = Math.floor(10 + Math.random() * 20);
        const goldGain = Math.floor(5 + Math.random() * 15);
        
        p.xp += xpGain;
        p.gold += goldGain;
        p.kills++;
        
        addLog(`You slay a Void Wraith. <span style="color:var(--gold)">+${xpGain} XP, +${goldGain} Gold</span>`);
        
        while (p.xp >= p.level * 100) {
            p.xp -= p.level * 100;
            p.level++;
            p.maxHp += 20;
            p.hp = p.maxHp;
            p.str += 2;
            p.wis += 2;
            addLog(`<span style="color:#4af; font-weight:bold;">LEVEL UP! You are now level ${p.level}.</span>`);
        }
        
        refreshUI();
        markDirty();
    }

    // ============================================
    // VOID GATE (Dungeon)
    // ============================================
    function updateGateUI(state) {
        const desc = document.getElementById('gate-desc');
        const status = document.getElementById('gate-status');
        const actions = document.getElementById('gate-actions');
        
        if (!desc || !status || !actions) return;
        
        if (state === 'CLOSED') {
            desc.innerText = 'The gate is sealed shut. Only the strongest can break it open.';
            status.innerHTML = '<p style="color:#888;">Status: <span style="color:#ff4444; font-weight:bold;">CLOSED</span></p>';
            
            if (currentUser === ADMIN) {
                actions.innerHTML = '<button class="action-btn" onclick="openGate()" style="background:var(--admin); border-color:var(--admin);">üîì Open Gate (Admin)</button>';
            } else {
                actions.innerHTML = '<p style="color:#666;">You are not strong enough to open it alone...</p>';
            }
        } else if (state === 'OPEN') {
            desc.innerText = 'The gate groans open. A horrifying presence emanates from within.';
            status.innerHTML = '<p style="color:#888;">Status: <span style="color:#44ff44; font-weight:bold;">OPEN</span></p>';
            actions.innerHTML = '<button class="action-btn" onclick="enterGate()">Enter the Gate</button>';
        } else if (state === 'ENTERED') {
            desc.innerText = 'You stand before an ancient horror...';
            status.innerHTML = `<p style="color:#888;">Boss: <span style="color:#ff4444; font-weight:bold;">Void Titan</span> | HP: ${gameState.bossHp || 5000}</p>`;
            actions.innerHTML = '<button class="action-btn" onclick="attackBoss()">‚öî Attack Boss</button>';
        }
    }

    function openGate() {
        if (currentUser !== ADMIN) return;
        gameState.gate = 'OPEN';
        gameState.bossHp = 5000;
        updateGateUI('OPEN');
        sendSystemChat('üåÄ The Void Gate has been opened by the Void Master!');
        markDirty();
    }

    function enterGate() {
        if (gameState.gate !== 'OPEN') return;
        gameState.gate = 'ENTERED';
        updateGateUI('ENTERED');
        addLog('<span style="color:#ff4444">You step into the abyss...</span>');
        markDirty();
    }

    function attackBoss() {
        if (gameState.gate !== 'ENTERED') return;
        
        const dmg = Math.floor(p.str * 2 + Math.random() * 50);
        gameState.bossHp -= dmg;
        
        addLog(`You strike the Void Titan for <span style="color:#ff4444">${dmg}</span> damage.`);
        
        if (gameState.bossHp <= 0) {
            gameState.gate = 'CLOSED';
            const reward = 1000;
            p.gold += reward;
            p.xp += 500;
            addLog(`<span style="color:var(--gold); font-weight:bold;">BOSS DEFEATED! +${reward} Gold, +500 XP</span>`);
            sendSystemChat(`üèÜ ${currentUser} has slain the Void Titan!`);
            updateGateUI('CLOSED');
        } else {
            updateGateUI('ENTERED');
        }
        
        refreshUI();
        markDirty();
    }

    // ============================================
    // LEADERBOARD
    // ============================================
    function loadLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        if (!list) return;
        
        const players = Object.entries(gameState.players)
            .sort((a, b) => b[1].level - a[1].level || b[1].xp - a[1].xp)
            .slice(0, 20);
        
        if (players.length === 0) {
            list.innerHTML = '<p style="color:#666;">No players yet.</p>';
            return;
        }
        
        let html = '<table style="width:100%; border-collapse: collapse;">';
        html += '<tr style="border-bottom:1px solid #333;"><th style="text-align:left; padding:8px;">Rank</th><th style="text-align:left;">Name</th><th>Level</th><th>Guild</th><th>Kills</th></tr>';
        
        players.forEach(([name, data], i) => {
            const guildTag = data.guild && gameState.guilds[data.guild] ? `„Äê${gameState.guilds[data.guild].tag}„Äë` : '-';
            const isOnline = data.online && (Date.now() - (data.lastSeen || 0)) < 120000;
            const onlineIndicator = isOnline ? '<span style="color:#44ff44;">‚óè</span>' : '<span style="color:#666;">‚óè</span>';
            
            html += `<tr style="border-bottom:1px solid #222;">`;
            html += `<td style="padding:8px;">#${i + 1}</td>`;
            html += `<td>${onlineIndicator} <span class="name-link" onclick="showPlayerCard('${name}')">${name}</span></td>`;
            html += `<td style="text-align:center;">${data.level}</td>`;
            html += `<td style="text-align:center; color:#4af;">${guildTag}</td>`;
            html += `<td style="text-align:center;">${data.kills || 0}</td>`;
            html += `</tr>`;
        });
        
        html += '</table>';
        list.innerHTML = html;
    }

    function showPlayerCard(username) {
        const pl = gameState.players[username];
        if (!pl) return;
        
        const guildName = pl.guild && gameState.guilds[pl.guild] ? gameState.guilds[pl.guild].name : 'None';
        
        alert(
            `‚ïê‚ïê‚ïê ${username} ‚ïê‚ïê‚ïê\n\n` +
            `Race: ${pl.race}\n` +
            `Level: ${pl.level}\n` +
            `HP: ${pl.hp}/${pl.maxHp}\n` +
            `STR: ${pl.str} | WIS: ${pl.wis}\n` +
            `Gold: ${pl.gold}\n` +
            `Guild: ${guildName}\n` +
            `Kills: ${pl.kills} | Deaths: ${pl.deaths}`
        );
    }

    // ============================================
    // SHOP
    // ============================================
    function refreshShop() {
        const container = document.getElementById('shop-items');
        if (!container) return;
        
        const items = [
            { name: 'Health Potion', cost: 50, desc: 'Restore 50 HP', effect: () => { p.hp = Math.min(p.maxHp, p.hp + 50); } },
            { name: 'Strength Elixir', cost: 200, desc: '+2 STR permanently', effect: () => { p.str += 2; } },
            { name: 'Wisdom Scroll', cost: 200, desc: '+2 WIS permanently', effect: () => { p.wis += 2; } }
        ];
        
        let html = '<div style="display:flex; flex-wrap:wrap; gap:10px;">';
        items.forEach((item, i) => {
            html += `<div style="border:1px solid #333; padding:15px; flex:1; min-width:200px;">`;
            html += `<h3 style="margin:0 0 5px 0; color:var(--gold);">${item.name}</h3>`;
            html += `<p style="color:#888; font-size:0.85rem; margin:5px 0;">${item.desc}</p>`;
            html += `<p style="color:var(--gold); font-weight:bold; margin:10px 0;">Cost: ${item.cost} Gold</p>`;
            html += `<button class="action-btn" onclick="buyItem(${i})">Purchase</button>`;
            html += `</div>`;
        });
        html += '</div>';
        
        container.innerHTML = html;
        window.shopItems = items;
    }

    function buyItem(index) {
        const item = window.shopItems[index];
        if (!item) return;
        
        if (p.gold < item.cost) {
            addLog('<span style="color:#ff4444;">Not enough gold!</span>');
            return;
        }
        
        p.gold -= item.cost;
        item.effect();
        addLog(`<span style="color:var(--gold);">Purchased ${item.name}.</span>`);
        refreshUI();
        markDirty();
    }

    // ============================================
    // PVP
    // ============================================
    function refreshPvpTargets() {
        const container = document.getElementById('pvp-targets');
        if (!container) return;
        
        const targets = Object.entries(gameState.players)
            .filter(([name]) => name !== currentUser)
            .sort((a, b) => b[1].level - a[1].level);
        
        if (targets.length === 0) {
            container.innerHTML = '<p style="color:#666;">No other players available.</p>';
            return;
        }
        
        let html = '';
        targets.slice(0, 10).forEach(([name, data]) => {
            const isOnline = data.online && (Date.now() - (data.lastSeen || 0)) < 120000;
            const onlineText = isOnline ? '<span style="color:#44ff44;">‚óè</span>' : '<span style="color:#666;">‚óã</span>';
            
            html += `<div style="border:1px solid #333; padding:12px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">`;
            html += `<span>${onlineText} <span class="name-link" onclick="showPlayerCard('${name}')">${name}</span> (Lv ${data.level})</span>`;
            html += `<button class="action-btn" onclick="attackPlayer('${name}')">‚öî Attack</button>`;
            html += `</div>`;
        });
        
        container.innerHTML = html;
    }

    function attackPlayer(targetName) {
        const target = gameState.players[targetName];
        if (!target) return;
        
        const myPower = p.level * 10 + p.str * 5;
        const theirPower = target.level * 10 + target.str * 5;
        const chance = myPower / (myPower + theirPower);
        
        if (Math.random() < chance) {
            const goldStolen = Math.floor(target.gold * 0.1);
            const xpGain = target.level * 20;
            
            p.gold += goldStolen;
            p.xp += xpGain;
            p.kills++;
            target.gold = Math.max(0, target.gold - goldStolen);
            target.deaths++;
            
            addLog(`<span style="color:#44ff44;">Victory!</span> You defeated ${targetName}. <span style="color:var(--gold)">+${goldStolen} Gold, +${xpGain} XP</span>`);
            sendSystemChat(`‚öî ${currentUser} has defeated ${targetName} in the Arena!`);
        } else {
            const goldLost = Math.floor(p.gold * 0.05);
            p.gold = Math.max(0, p.gold - goldLost);
            p.deaths++;
            target.kills++;
            
            addLog(`<span style="color:#ff4444;">Defeat!</span> ${targetName} bested you. <span style="color:#ff4444;">-${goldLost} Gold</span>`);
        }
        
        refreshUI();
        markDirty();
    }

    // ============================================
    // GUILD SYSTEM
    // ============================================
    function refreshGuildUI() {
        const container = document.getElementById('guild-content');
        if (!container) return;
        
        if (!p.guild) {
            let html = '<h3>You are not in a guild.</h3>';
            html += '<button class="action-btn" onclick="showCreateGuild()">Create Guild (500 Gold)</button>';
            html += '<div style="margin-top:20px;"><h4>Existing Guilds</h4>';
            
            const guilds = Object.entries(gameState.guilds);
            if (guilds.length === 0) {
                html += '<p style="color:#666;">No guilds exist yet.</p>';
            } else {
                guilds.forEach(([id, guild]) => {
                    html += `<div style="border:1px solid #333; padding:10px; margin-bottom:5px;">`;
                    html += `<strong style="color:#4af;">„Äê${guild.tag}„Äë${guild.name}</strong> - ${guild.members.length} members`;
                    html += ` <button class="action-btn" onclick="joinGuild('${id}')">Request to Join</button>`;
                    html += `</div>`;
                });
            }
            html += '</div>';
            container.innerHTML = html;
        } else {
            const guild = gameState.guilds[p.guild];
            if (!guild) {
                p.guild = null;
                markDirty();
                refreshGuildUI();
                return;
            }
            
            const isLeader = guild.leader === currentUser;
            
            let html = `<h3 style="color:#4af;">„Äê${guild.tag}„Äë${guild.name}</h3>`;
            html += `<p>Leader: ${guild.leader}</p>`;
            html += `<p>Members (${guild.members.length}): ${guild.members.join(', ')}</p>`;
            
            if (isLeader) {
                html += '<button class="action-btn" onclick="disbandGuild()" style="background:#8b0000;">Disband Guild</button>';
                html += '<button class="action-btn" onclick="declareWar()">Declare War</button>';
            }
            
            html += '<button class="action-btn" onclick="leaveGuild()">Leave Guild</button>';
            
            container.innerHTML = html;
        }
    }

    function showCreateGuild() {
        const name = prompt('Guild Name:');
        if (!name) return;
        
        const tag = prompt('Guild Tag (3-5 characters):');
        if (!tag || tag.length < 3 || tag.length > 5) {
            alert('Tag must be 3-5 characters.');
            return;
        }
        
        if (p.gold < 500) {
            alert('You need 500 gold to create a guild.');
            return;
        }
        
        const guildId = 'guild_' + Date.now();
        gameState.guilds[guildId] = {
            name: name,
            tag: tag.toUpperCase(),
            leader: currentUser,
            members: [currentUser],
            createdAt: Date.now()
        };
        
        p.guild = guildId;
        p.gold -= 500;
        
        addLog(`<span style="color:#4af;">Guild „Äê${tag.toUpperCase()}„Äë${name} created!</span>`);
        sendSystemChat(`üè∞ ${currentUser} has founded the guild „Äê${tag.toUpperCase()}„Äë${name}!`);
        
        refreshUI();
        refreshGuildUI();
        markDirty();
    }

    function joinGuild(guildId) {
        const guild = gameState.guilds[guildId];
        if (!guild) return;
        
        if (guild.members.includes(currentUser)) {
            alert('You are already in this guild.');
            return;
        }
        
        guild.members.push(currentUser);
        p.guild = guildId;
        
        addLog(`<span style="color:#4af;">You joined „Äê${guild.tag}„Äë${guild.name}!</span>`);
        sendSystemChat(`üè∞ ${currentUser} has joined „Äê${guild.tag}„Äë${guild.name}!`);
        
        refreshUI();
        refreshGuildUI();
        markDirty();
    }

    function leaveGuild() {
        const guild = gameState.guilds[p.guild];
        if (!guild) return;
        
        if (guild.leader === currentUser) {
            alert('You are the leader. Disband the guild or transfer leadership first.');
            return;
        }
        
        guild.members = guild.members.filter(m => m !== currentUser);
        p.guild = null;
        
        addLog('<span style="color:#888;">You left the guild.</span>');
        
        refreshUI();
        refreshGuildUI();
        markDirty();
    }

    function disbandGuild() {
        const guild = gameState.guilds[p.guild];
        if (!guild || guild.leader !== currentUser) return;
        
        if (!confirm(`Disband „Äê${guild.tag}„Äë${guild.name}? This cannot be undone.`)) {
            return;
        }
        
        guild.members.forEach(member => {
            if (gameState.players[member]) {
                gameState.players[member].guild = null;
            }
        });
        
        delete gameState.guilds[p.guild];
        p.guild = null;
        
        addLog('<span style="color:#ff4444;">Guild disbanded.</span>');
        sendSystemChat(`üèö The guild „Äê${guild.tag}„Äë${guild.name} has been disbanded!`);
        
        refreshUI();
        refreshGuildUI();
        markDirty();
    }

    function declareWar() {
        const guild = gameState.guilds[p.guild];
        if (!guild || guild.leader !== currentUser) return;
        
        const targetGuilds = Object.entries(gameState.guilds)
            .filter(([id]) => id !== p.guild)
            .map(([id, g]) => `${id}:„Äê${g.tag}„Äë${g.name}`)
            .join('\n');
        
        if (!targetGuilds) {
            alert('No other guilds to declare war on.');
            return;
        }
        
        const choice = prompt(`Declare war on:\n${targetGuilds}\n\nEnter guild ID:`);
        if (!choice || !gameState.guilds[choice]) return;
        
        const targetGuild = gameState.guilds[choice];
        
        gameState.wars.push({
            attacker: p.guild,
            defender: choice,
            attackerTag: guild.tag,
            defenderTag: targetGuild.tag,
            startedAt: Date.now()
        });
        
        addLog(`<span style="color:#ff4444;">War declared against „Äê${targetGuild.tag}„Äë!</span>`);
        sendSystemChat(`‚öî WAR! „Äê${guild.tag}„Äë has declared war on „Äê${targetGuild.tag}„Äë!`);
        
        markDirty();
    }

    // ============================================
    // CHAT SYSTEM
    // ============================================
    function sendChatMsg() {
        const input = document.getElementById('chat-in');
        const msg = input.value.trim();
        if (!msg) return;
        
        const chatMsg = {
            id: Date.now() + '-' + currentUser,
            user: currentUser,
            text: msg,
            time: Date.now()
        };
        
        gameState.chat.push(chatMsg);
        seenChatIds.add(chatMsg.id);
        
        if (gameState.chat.length > 100) {
            gameState.chat.shift();
        }
        
        displayChat();
        input.value = '';
        markDirty();
    }

    function sendSystemChat(text) {
        const chatMsg = {
            id: Date.now() + '-system',
            user: 'SYSTEM',
            text: text,
            time: Date.now()
        };
        
        gameState.chat.push(chatMsg);
        seenChatIds.add(chatMsg.id);
        
        if (gameState.chat.length > 100) {
            gameState.chat.shift();
        }
        
        displayChat();
        markDirty();
    }

    function displayChat() {
        const log = document.getElementById('chat-log');
        if (!log) return;
        
        log.innerHTML = '';
        gameState.chat.slice(-50).forEach(msg => {
            const div = document.createElement('div');
            div.style.marginBottom = '5px';
            
            if (msg.user === 'SYSTEM') {
                div.style.color = '#888';
                div.innerHTML = `<strong>[SYSTEM]</strong> ${msg.text}`;
            } else {
                const userColor = msg.user === currentUser ? 'var(--gold)' : '#4af';
                div.innerHTML = `<strong style="color:${userColor};">${msg.user}:</strong> ${msg.text}`;
            }
            
            log.appendChild(div);
        });
        
        log.scrollTop = log.scrollHeight;
    }

    // ============================================
    // NEWS
    // ============================================
    function refreshNews() {
        const container = document.getElementById('news-list');
        if (!container) return;
        
        if (gameState.news.length === 0) {
            container.innerHTML = '<p style="color:#666;">No news yet.</p>';
            return;
        }
        
        let html = '';
        gameState.news.slice().reverse().slice(0, 20).forEach(item => {
            const date = new Date(item.time).toLocaleString();
            html += `<div style="border-bottom:1px solid #222; padding:10px 0;">`;
            html += `<div style="color:#888; font-size:0.8rem; margin-bottom:5px;">${date}</div>`;
            html += `<div>${item.text}</div>`;
            html += `</div>`;
        });
        
        container.innerHTML = html;
    }

    function addNews(text) {
        gameState.news.push({
            text: text,
            time: Date.now()
        });
        
        if (gameState.news.length > 100) {
            gameState.news.shift();
        }
        
        markDirty();
    }

    // ============================================
    // BACKUP SYSTEM (Admin Only)
    // ============================================
    function refreshBackupInfo() {
        if (currentUser !== ADMIN) return;
        
        const info = document.getElementById('backup-info');
        if (!info) return;
        const playerCount = Object.keys(gameState.players).length;
        const accountCount = Object.keys(getAccounts()).length;
        const guildCount = Object.keys(gameState.guilds || {}).length;
        const warCount = (gameState.wars || []).length;
        const newsCount = (gameState.news || []).length;
        const chatCount = (gameState.chat || []).length;
        
        info.innerHTML = `Players: ${playerCount} ¬∑ Accounts: ${accountCount} ¬∑ Guilds: ${guildCount}<br>` +
            `Wars: ${warCount} ¬∑ News: ${newsCount} ¬∑ Chat msgs: ${chatCount}<br>` +
            `Gate: ${gameState.gate || 'CLOSED'}`;
    }

    function downloadBackup() {
        if (currentUser !== ADMIN) return;

        const backup = {
            _meta: {
                version: 1,
                exported: new Date().toISOString(),
                exportedBy: currentUser,
                realm: document.getElementById('realm-name').value.trim() || 'void-realm-default'
            },
            accounts: getAccounts(),
            gameState: {
                players: gameState.players,
                guilds: gameState.guilds || {},
                wars: gameState.wars || [],
                news: gameState.news || [],
                gate: gameState.gate || 'CLOSED',
                chat: gameState.chat || []
            }
        };

        const json = JSON.stringify(backup, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        const dateStr = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
        a.href = url;
        a.download = `void-slayer-backup-${dateStr}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        const status = document.getElementById('backup-status');
        status.style.color = '#44ff44';
        status.innerText = '‚úÖ Backup downloaded!';
        addLog("<span style='color:var(--admin)'>Realm backup downloaded.</span>");
    }

    function uploadBackup(event) {
        if (currentUser !== ADMIN) return;
        const status = document.getElementById('backup-status');
        
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const backup = JSON.parse(e.target.result);
                
                if (!backup.gameState || !backup.accounts) {
                    status.style.color = '#ff4444';
                    status.innerText = '‚ùå Invalid backup file ‚Äî missing gameState or accounts.';
                    return;
                }

                const gs = backup.gameState;
                const playerCount = Object.keys(gs.players || {}).length;
                const accountCount = Object.keys(backup.accounts || {}).length;
                const meta = backup._meta || {};

                if (!confirm(
                    `Restore this backup?\n\n` +
                    `From: ${meta.exported || 'Unknown date'}\n` +
                    `Realm: ${meta.realm || 'Unknown'}\n` +
                    `Players: ${playerCount}\n` +
                    `Accounts: ${accountCount}\n\n` +
                    `This will OVERWRITE all current realm data.`
                )) {
                    status.style.color = '#888';
                    status.innerText = 'Restore cancelled.';
                    return;
                }

                // Restore accounts
                const accounts = backup.accounts;
                saveAccounts(accounts);

                // Restore game state
                if (gs.players) gameState.players = gs.players;
                if (gs.guilds) gameState.guilds = gs.guilds;
                if (gs.wars) gameState.wars = gs.wars;
                if (gs.news) gameState.news = gs.news;
                if (gs.gate) gameState.gate = gs.gate;
                if (gs.chat) {
                    gameState.chat = gs.chat;
                    gs.chat.forEach(msg => seenChatIds.add(msg.id));
                }

                // Reload own player data if present
                if (gameState.players[currentUser]) {
                    Object.assign(p, gameState.players[currentUser]);
                    refreshUI();
                }

                // Force cloud sync
                saveToCloud(true);
                
                updateGateUI(gameState.gate);
                updatePlayerCount();

                status.style.color = '#44ff44';
                status.innerText = `‚úÖ Restored! ${playerCount} players, ${accountCount} accounts loaded.`;
                addLog("<span style='color:var(--admin)'>Realm backup restored!</span>");
                sendSystemChat("üîÑ The Void Master has restored the realm from a backup!");

                refreshBackupInfo();
            } catch (err) {
                status.style.color = '#ff4444';
                status.innerText = '‚ùå Error reading backup: ' + err.message;
            }
        };
        reader.readAsText(file);
        
        event.target.value = '';
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    window.addEventListener('load', () => {
        updateCloudStatus('Ready', '#888');
        goTab('grind');
        
        // Periodic player count update
        setInterval(() => {
            if (currentUser) {
                updatePlayerCount();
                p.lastSeen = Date.now();
            }
        }, 30000);
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (currentUser && p) {
            p.online = false;
            saveToCloud(true); // Force final save
        }
        stopCloudSync();
    });
</script>
</body>
</html>